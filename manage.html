<!--
  @file manage.html
  @brief åº—èˆ—ç®¡ç†ç”»é¢ - ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆäºˆç´„ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
  @details ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆURLã«ã‚ˆã‚‹åº—èˆ—èªè¨¼ã€äºˆç´„ä¸€è¦§è¡¨ç¤ºã€å—æ¸¡æ¸ˆã¿ãƒã‚§ãƒƒã‚¯ã€ãƒ¡ãƒ¢æ©Ÿèƒ½
  @version 1.0
-->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åº—èˆ—ç®¡ç†ç”»é¢ - ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆäºˆç´„ç®¡ç†</title>
  <style>
    * { 
      box-sizing: border-box; 
    }
    
    body {
      font-family: 'Segoe UI', 'Meiryo', sans-serif;
      margin: 0;
      padding: 16px;
      background-color: #f5f5f5;
      line-height: 1.5;
    }
    
    .header {
      background: linear-gradient(135deg, #2c3e50, #34495e);
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 24px;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      margin: 0 0 8px 0;
      font-size: 1.6em;
      font-weight: 600;
    }
    
    .header .subtitle {
      font-size: 0.9em;
      opacity: 0.9;
    }
    
    .auth-error {
      background: #e74c3c;
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      margin: 40px auto;
      max-width: 500px;
    }
    
    .auth-error h2 {
      margin: 0 0 12px 0;
    }
    
    .controls {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 24px;
    }
    
    .btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 500;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .btn:hover {
      background: #2980b9;
      transform: translateY(-1px);
    }
    
    .btn.refresh {
      background: #27ae60;
    }
    
    .btn.refresh:hover {
      background: #229954;
    }
    
    .btn.active {
      background: #e67e22;
    }
    
    .btn.active:hover {
      background: #d35400;
    }
    
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #666;
      background: white;
      border-radius: 8px;
      margin: 20px 0;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error {
      background: #e74c3c;
      color: white;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .no-data {
      text-align: center;
      padding: 60px 20px;
      color: #666;
      background: white;
      border-radius: 12px;
      margin: 20px 0;
    }
    
    .no-data h3 {
      margin: 0 0 12px 0;
      color: #555;
    }
    
    .reservation-list {
      display: grid;
      gap: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .reservation-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      position: relative;
      transition: all 0.2s ease;
      border: 1px solid #e1e8ed;
    }
    
    .reservation-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    }
    
    .reservation-card.completed {
      background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
      border-left: 6px solid #27ae60;
    }
    
    .reservation-card.pending {
      border-left: 6px solid #f39c12;
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .pickup-info {
      font-weight: 600;
      font-size: 1.2em;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .status {
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 1.0em;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .status.pending {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .status.completed {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .customer-info {
      margin: 16px 0;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }
    
    .customer-info .row {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
    }
    
    .customer-info .row:last-child {
      margin-bottom: 0;
    }
    
    .customer-info .icon {
      width: 20px;
      text-align: center;
    }
    
    .phone-link {
      color: #3498db;
      text-decoration: none;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    
    .phone-link:hover {
      background: #3498db;
      color: white;
    }
    
    .products {
      background: #f1f3f4;
      padding: 16px;
      border-radius: 8px;
      margin: 16px 0;
      border: 1px solid #dee2e6;
    }
    
    .products .title {
      font-weight: 600;
      margin-bottom: 8px;
      color: #495057;
    }
    
    .product-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px solid #e9ecef;
    }
    
    .product-item:last-child {
      border-bottom: none;
    }
    
    .product-name {
      font-weight: 500;
    }
    
    .product-price {
      color: #666;
      font-weight: 600;
    }
    
    .total {
      font-weight: 700;
      font-size: 1.3em;
      color: #e74c3c;
      text-align: right;
      margin: 16px 0;
      padding: 12px;
      background: #fff5f5;
      border-radius: 8px;
      border: 1px solid #f8d7da;
    }
    
    .note {
      margin: 16px 0;
      padding: 12px;
      background: #e9ecef;
      border-radius: 8px;
      color: #495057;
      border-left: 4px solid #6c757d;
    }
    
    .note .title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .controls-row {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid #e9ecef;
      flex-wrap: wrap;
    }
    
    .toggle-container {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 500;
    }
    
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: #27ae60;
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }
    
    .toggle-slider:after {
      content: 'âœ—';
      color: white;
      display: block;
      text-align: center;
      line-height: 34px;
      font-size: 18px;
      font-weight: bold;
    }
    
    input:checked + .toggle-slider:after {
      content: 'âœ“';
    }
    
    .toggle-label {
      font-size: 1.1em;
      cursor: pointer;
      user-select: none;
    }
    
    .memo-area {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 250px;
    }
    
    .memo-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #ced4da;
      border-radius: 8px;
      font-size: 1.0em;
      transition: border-color 0.2s ease;
      min-height: 48px;
    }
    
    .memo-input:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }
    
    .save-btn {
      background: #f39c12;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: 500;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      min-height: 48px;
    }
    
    .save-btn:hover {
      background: #e67e22;
      transform: translateY(-1px);
    }
    
    .stats {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    
    .stat-card {
      background: white;
      padding: 16px 24px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      min-width: 120px;
    }
    
    .stat-number {
      font-size: 1.8em;
      font-weight: 700;
      color: #2c3e50;
    }
    
    .stat-label {
      font-size: 0.9em;
      color: #666;
      margin-top: 4px;
    }
    
    /* æœ¬æ—¥åˆ†è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .today-warning {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 24px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
      animation: pulse 2s infinite;
      border: 3px solid #fff;
    }
    
    .today-warning h3 {
      margin: 0 0 8px 0;
      font-size: 1.3em;
      font-weight: 700;
    }
    
    .today-warning p {
      margin: 0;
      font-size: 1.1em;
      opacity: 0.95;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3); }
      50% { box-shadow: 0 6px 20px rgba(231, 76, 60, 0.5); }
      100% { box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3); }
    }
    
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
    @media (max-width: 768px) {
      body { 
        padding: 12px; 
      }
      
      .header { 
        padding: 16px; 
      }
      
      .header h1 { 
        font-size: 1.3em; 
      }
      
      .reservation-card { 
        padding: 16px; 
      }
      
      .controls-row { 
        flex-direction: column; 
        align-items: stretch; 
        gap: 16px; /* è¡Œé–“ã‚’åºƒã’ã‚‹ */
      }
      
      .toggle-container {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .memo-area { 
        min-width: auto;
        width: 100%;
      }
      
      .memo-input {
        flex: 1;
        min-width: 0; /* flexè¦ç´ ã®æœ€å°å¹…ã‚’0ã« */
      }
      
      .save-btn {
        min-width: 100px; /* æœ€å°å¹…ã‚’ç¢ºä¿ */
        white-space: nowrap; /* æ–‡å­—ã®æ”¹è¡Œã‚’é˜²ã */
        flex-shrink: 0; /* ç¸®å°ã‚’é˜²ã */
      }
      
      .card-header { 
        flex-direction: column; 
        align-items: flex-start;
      }
      
      .customer-info .row {
        flex-wrap: wrap;
      }
      
      .stats {
        gap: 12px;
      }
      
      .stat-card {
        min-width: 100px;
        padding: 12px 16px;
      }
    }
    
    @media (max-width: 480px) {
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .btn {
        justify-content: center;
      }
      
      .save-btn {
        font-size: 1.0em;
        padding: 10px 16px;
        min-width: 80px;
      }
      
      /* æ¥µå°ç”»é¢ã§ã¯ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’çŸ­ç¸® */
      .save-btn-text {
        display: none;
      }
      
      .save-btn::after {
        content: "ğŸ’¾";
      }
    }
    
    /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    
    .modal-content h3 {
      margin: 0 0 20px 0;
      color: #2c3e50;
      font-size: 1.3em;
    }
    
    .modal-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-size: 1.1em;
      margin-bottom: 20px;
      transition: border-color 0.2s ease;
    }
    
    .modal-input:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    
    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    
    .modal-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1.1em;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .modal-btn.confirm {
      background: #27ae60;
      color: white;
    }
    
    .modal-btn.confirm:hover {
      background: #229954;
    }
    
    .modal-btn.cancel {
      background: #95a5a6;
      color: white;
    }
    
    .modal-btn.cancel:hover {
      background: #7f8c8d;
    }
  </style>
</head>
<body>
  <!-- èªè¨¼ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
  <div id="auth-error" class="auth-error" style="display: none;">
    <h2>ğŸ”’ ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚¨ãƒ©ãƒ¼</h2>
    <p>ã“ã®ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    <p>æ­£ã—ã„ç®¡ç†ç”»é¢URLã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚</p>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
  <div id="main-content" style="display: none;">
    <div class="header">
      <h1 id="store-name">åº—èˆ—ç®¡ç†ç”»é¢</h1>
      <div class="subtitle">æœ¬æ—¥ä»¥é™ã®äºˆç´„ä¸€è¦§</div>
    </div>
    
    <!-- çµ±è¨ˆæƒ…å ± -->
    <div class="stats" id="stats">
      <div class="stat-card">
        <div class="stat-number" id="total-count">0</div>
        <div class="stat-label">ç·äºˆç´„æ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="pending-count">0</div>
        <div class="stat-label">æœªå®Œäº†</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="completed-count">0</div>
        <div class="stat-label">å®Œäº†æ¸ˆã¿</div>
      </div>
    </div>
    
    <!-- æœ¬æ—¥åˆ†æœªå®Œäº†è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div id="today-warning" class="today-warning" style="display: none;">
      <h3>ğŸš¨ æœ¬æ—¥åˆ†ã®äºˆç´„ã«æœªå—æ¸¡ã—ãŒã‚ã‚Šã¾ã™</h3>
      <p>æœ¬æ—¥ã®ãŠå®¢æ§˜ã‚’ãŠå¾…ãŸã›ã—ãªã„ã‚ˆã†ã€å—æ¸¡ã—å®Œäº†ã®ç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™</p>
    </div>
    
    <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
    <div class="controls">
      <button class="btn refresh" onclick="loadReservations()">
        ğŸ”„ æ›´æ–°
      </button>
      <button class="btn" id="filter-today" onclick="filterReservations('today')">
        ğŸ“… æœ¬æ—¥åˆ†ã®ã¿
      </button>
      <button class="btn" id="filter-all" onclick="filterReservations('all')">
        ğŸ“‹ å…¨ã¦è¡¨ç¤º
      </button>
      <button class="btn" id="filter-pending" onclick="filterReservations('pending')">
        â³ æœªå®Œäº†ã®ã¿
      </button>
      <button class="btn" id="filter-completed" onclick="filterReservations('completed')">
        âœ… å®Œäº†æ¸ˆã¿ã®ã¿
      </button>
    </div>
    
    <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div id="error-message" class="error" style="display: none;">
      <span>âš ï¸</span>
      <span id="error-text"></span>
    </div>
    
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <div>äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
    
    <!-- äºˆç´„ä¸€è¦§ -->
    <div id="reservation-list" class="reservation-list" style="display: none;"></div>
    
    <!-- ãƒ‡ãƒ¼ã‚¿ãªã— -->
    <div id="no-data" class="no-data" style="display: none;">
      <h3>ğŸ“‹ äºˆç´„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h3>
      <p>æœ¬æ—¥ä»¥é™ã®äºˆç´„ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    </div>
  </div>

  <!-- æ‹…å½“è€…åå…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="staff-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <h3>ğŸ‘¤ å—æ¸¡ã—æ‹…å½“è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h3>
      <input type="text" id="staff-name-input" class="modal-input" placeholder="æ‹…å½“è€…åã‚’å…¥åŠ›..." maxlength="50" required>
      <div class="modal-buttons">
        <button class="modal-btn confirm" onclick="confirmStaffInput()">âœ“ ç¢ºå®š</button>
        <button class="modal-btn cancel" onclick="cancelStaffInput()">âœ— ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <script>
    // GitHub Pages URL: https://applegrimm.github.io/fictional-octo-lamp/
    // GASã®Webã‚¢ãƒ—ãƒªURLï¼ˆå®Ÿéš›ã®URLã«å¤‰æ›´ã—ã¦ãã ã•ã„ï¼‰
    // âš ï¸ é‡è¦: æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ä½œæˆã—ãŸå ´åˆã¯ã€ä»¥ä¸‹ã®URLã‚’æ›´æ–°ã—ã¦ãã ã•ã„
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwgeG189yH0YGt6gpqpYHoclCnZe4cbo8jARRaHCqjgxpiD_XW47taPqNFlQYDhfaYaCg/exec';
    
    let SHOP_SECRET = '';
    let allReservations = [];
    let currentFilter = 'all';

    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®å¤‰æ•°
    let pendingToggleRowId = null;
    let pendingToggleElement = null;

    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    function getTodayString() {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // æœ¬æ—¥åˆ†ã®äºˆç´„ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°
    function checkTodayReservations() {
      const today = getTodayString();
      const todayReservations = allReservations.filter(reservation => {
        return reservation.pickupDate === today;
      });
      
      const groupedToday = groupByOrderId(todayReservations);
      const todayPending = groupedToday.filter(group => 
        !group.items.every(item => item.isCompleted)
      );
      
      const warningElement = document.getElementById('today-warning');
      if (todayPending.length > 0) {
        warningElement.style.display = 'block';
      } else {
        warningElement.style.display = 'none';
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
    window.addEventListener('DOMContentLoaded', function() {
      console.log('=== ç®¡ç†ç”»é¢èª­ã¿è¾¼ã¿é–‹å§‹ ===');
      
      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰shopã‚’å–å¾—
      const urlParams = new URLSearchParams(window.location.search);
      SHOP_SECRET = urlParams.get('shop');
      
      console.log('Shop Secret:', SHOP_SECRET);
      console.log('GAS API URL:', GAS_API_URL);
      
      if (!SHOP_SECRET) {
        console.log('Shop SecretãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        showAuthError();
        return;
      }
      
      // ãƒ¡ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤º
      document.getElementById('main-content').style.display = 'block';
      
      // äºˆç´„ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ï¼ˆJSONPæ–¹å¼ï¼‰
      console.log('äºˆç´„ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹ï¼ˆJSONPæ–¹å¼ï¼‰');
      loadReservations();
    });

    // èªè¨¼ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    function showAuthError() {
      document.getElementById('auth-error').style.display = 'block';
      document.getElementById('main-content').style.display = 'none';
    }

    // äºˆç´„ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ï¼ˆå®Œå…¨JSONPç‰ˆãƒ»CORSã‚¨ãƒ©ãƒ¼0%ä¿è¨¼ï¼‰
    function loadReservations() {
      console.log('=== loadReservationsé–‹å§‹ ===');
      showLoading(true);
      hideError();

      try {
        // JSONPæ–¹å¼ï¼šã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã§CORSã‚’å®Œå…¨å›é¿
        const callbackName = 'reservationCallback' + Date.now();
        console.log('JSONP Callbackå:', callbackName);
        
        // æ—¢å­˜ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’å‰Šé™¤ï¼ˆã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼‰
        const existingScripts = document.querySelectorAll('script[data-jsonp="true"]');
        existingScripts.forEach(script => script.remove());
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å®šç¾©
        window[callbackName] = function(data) {
          console.log('=== JSONP Responseå—ä¿¡ ===', data);
          
          try {
            if (data && data.success) {
              console.log('äºˆç´„ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', data.data.length + 'ä»¶');
              allReservations = data.data || [];
              
              // åº—èˆ—åã‚’è¨­å®š
              if (data.storeName) {
                document.getElementById('store-name').textContent = data.storeName + ' - äºˆç´„ç®¡ç†ç”»é¢';
                console.log('åº—èˆ—åè¨­å®š:', data.storeName);
              }
              
              // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
              updateStats(allReservations);
              
              // äºˆç´„ä¸€è¦§ã‚’è¡¨ç¤º
              displayReservations(allReservations);
              
            } else {
              console.error('APIã‚¨ãƒ©ãƒ¼:', data);
              if (data && data.error && data.error.includes('ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™')) {
                showAuthError();
              } else {
                showError(data ? data.error : 'äºˆç´„ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
              }
            }
          } catch (error) {
            console.error('ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
            showError('ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
          } finally {
            // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            cleanupJSONP(callbackName);
            showLoading(false);
          }
        };
        
        // JSONPãƒªã‚¯ã‚¨ã‚¹ãƒˆURLä½œæˆ
        const jsonpUrl = `${GAS_API_URL}?action=getReservations&shop=${encodeURIComponent(SHOP_SECRET)}&callback=${callbackName}&_t=${Date.now()}`;
        console.log('JSONP URL:', jsonpUrl);
        
        // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’ä½œæˆ
        const script = document.createElement('script');
        script.src = jsonpUrl;
        script.setAttribute('data-jsonp', 'true');
        script.setAttribute('data-callback', callbackName);
        
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        script.onerror = function(error) {
          console.error('JSONPèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
          showError('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚GASã®URLã¾ãŸã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
          cleanupJSONP(callbackName);
          showLoading(false);
        };
        
        script.onload = function() {
          console.log('JSONPã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†');
        };
        
        // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’è¿½åŠ ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆå®Ÿè¡Œ
        document.head.appendChild(script);
        
        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ10ç§’ï¼‰
        setTimeout(() => {
          if (window[callbackName]) {
            console.warn('JSONP ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ');
            showError('ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            cleanupJSONP(callbackName);
            showLoading(false);
          }
        }, 10000);
        
      } catch (error) {
        console.error('JSONPåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        showError('äºˆç´„ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        showLoading(false);
      }
    }

    // JSONP ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°
    function cleanupJSONP(callbackName) {
      try {
        // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’å‰Šé™¤
        const script = document.querySelector(`script[data-callback="${callbackName}"]`);
        if (script && script.parentNode) {
          script.parentNode.removeChild(script);
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å‰Šé™¤
        if (window[callbackName]) {
          delete window[callbackName];
        }
        
        console.log('JSONP ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†:', callbackName);
      } catch (error) {
        console.warn('JSONP ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
    function updateStats(reservations) {
      const grouped = groupByOrderId(reservations);
      const totalCount = grouped.length;
      const completedCount = grouped.filter(group => 
        group.items.every(item => item.isCompleted)
      ).length;
      const pendingCount = totalCount - completedCount;

      document.getElementById('total-count').textContent = totalCount;
      document.getElementById('pending-count').textContent = pendingCount;
      document.getElementById('completed-count').textContent = completedCount;
      
      // æœ¬æ—¥åˆ†ã®è­¦å‘Šãƒã‚§ãƒƒã‚¯
      checkTodayReservations();
    }

    // äºˆç´„ä¸€è¦§ã‚’è¡¨ç¤º
    function displayReservations(reservations) {
      const listContainer = document.getElementById('reservation-list');
      const noDataContainer = document.getElementById('no-data');

      if (reservations.length === 0) {
        listContainer.style.display = 'none';
        noDataContainer.style.display = 'block';
        return;
      }

      listContainer.style.display = 'grid';
      noDataContainer.style.display = 'none';

      // æ³¨æ–‡IDã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const groupedReservations = groupByOrderId(reservations);

      listContainer.innerHTML = groupedReservations.map(group => {
        const isCompleted = group.items.every(item => item.isCompleted);
        const totalAmount = group.items[0].total;
        const customer = group.items[0];

        return `
          <div class="reservation-card ${isCompleted ? 'completed' : 'pending'}" data-filter="${isCompleted ? 'completed' : 'pending'}">
            <div class="card-header">
              <div class="pickup-info">
                ğŸ“… ${formatPickupDateTime(customer.pickupDate, customer.pickupTime)}
              </div>
              <div class="status ${isCompleted ? 'completed' : 'pending'}">
                ${isCompleted ? 'å®Œäº†' : 'æœªå®Œäº†'}
              </div>
            </div>
            
            <div class="customer-info">
              <div class="row">
                <span class="icon">ğŸ‘¤</span>
                <strong>${escapeHtml(customer.customerName)}</strong>
              </div>
              <div class="row">
                <span class="icon">ğŸ“</span>
                <a href="tel:${customer.phone}" class="phone-link">${customer.phone}</a>
              </div>
              <div class="row">
                <span class="icon">ğŸ“§</span>
                <span>${escapeHtml(customer.email)}</span>
              </div>
              <div class="row">
                <span class="icon">ğŸ†”</span>
                <span>${escapeHtml(customer.orderId)}</span>
              </div>
            </div>
            
            <div class="products">
              <div class="title">ğŸ“¦ æ³¨æ–‡å†…å®¹</div>
              ${group.items.map(item => `
                <div class="product-item">
                  <span class="product-name">${escapeHtml(item.productName)} Ã— ${item.quantity}</span>
                  <span class="product-price">${item.subtotal}å††</span>
                </div>
              `).join('')}
            </div>
            
            <div class="total">ğŸ’° åˆè¨ˆé‡‘é¡: ${totalAmount}å††</div>
            
            ${customer.note ? `
              <div class="note">
                <div class="title">ğŸ“ ãŠå®¢æ§˜ã‹ã‚‰ã®å‚™è€ƒ</div>
                <div>${escapeHtml(customer.note)}</div>
              </div>
            ` : ''}
            
            <div class="controls-row">
              <div class="toggle-container">
                <label class="toggle-switch">
                  <input type="checkbox" id="check-${group.orderId}" ${isCompleted ? 'checked' : ''} 
                         onchange="handleToggleChange('${group.items[0].rowId}', this)">
                  <span class="toggle-slider"></span>
                </label>
                <label for="check-${group.orderId}" class="toggle-label">å—æ¸¡å®Œäº†</label>
                ${customer.handoverStaff ? `<span style="color: #666; font-size: 0.9em; margin-left: 8px;">æ‹…å½“: ${escapeHtml(customer.handoverStaff)}</span>` : ''}
                <span class="auto-save-message" id="save-msg-${group.orderId}" style="display: none; color: #27ae60; font-size: 0.9em; margin-left: 8px;">è‡ªå‹•ä¿å­˜ä¸­...</span>
              </div>
              
              <div class="memo-area">
                <input type="text" class="memo-input" id="memo-${group.orderId}" 
                       value="${escapeHtml(customer.memo || '')}" placeholder="ã‚¹ã‚¿ãƒƒãƒ•ãƒ¡ãƒ¢ã‚’å…¥åŠ›..." maxlength="200">
                <button class="save-btn" onclick="updateReservation('${group.items[0].rowId}', null, document.getElementById('memo-${group.orderId}').value)">
                  ğŸ“ <span class="save-btn-text">ãƒ¡ãƒ¢ä¿å­˜</span>
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // æ³¨æ–‡IDã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    function groupByOrderId(reservations) {
      const groups = {};
      
      reservations.forEach(reservation => {
        const orderId = reservation.orderId;
        if (!groups[orderId]) {
          groups[orderId] = {
            orderId: orderId,
            items: []
          };
        }
        groups[orderId].items.push(reservation);
      });
      
      return Object.values(groups).sort((a, b) => {
        const dateA = new Date(a.items[0].pickupDate + ' ' + a.items[0].pickupTime);
        const dateB = new Date(b.items[0].pickupDate + ' ' + b.items[0].pickupTime);
        return dateA - dateB;
      });
    }

    // äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ï¼ˆJSONPæ–¹å¼ãƒ»CORSå®Œå…¨å›é¿ãƒ»åŒä¸€æ³¨æ–‡IDä¸€æ‹¬æ›´æ–°å¯¾å¿œï¼‰
    function updateReservation(rowId, checked, memo, staffName) {
      console.log('=== updateReservationé–‹å§‹ ===', {rowId, checked, memo, staffName});
      
      // ãƒœã‚¿ãƒ³ã®å‚ç…§ã‚’å–å¾—
      let originalButton = null;
      let autoSaveMessage = null;
      
      if (event && event.target) {
        originalButton = event.target;
        
        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å ´åˆã¯è‡ªå‹•ä¿å­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        if (checked !== null && event.target.type === 'checkbox') {
          const orderId = event.target.id.replace('check-', '');
          autoSaveMessage = document.getElementById(`save-msg-${orderId}`);
          if (autoSaveMessage) {
            autoSaveMessage.style.display = 'inline';
          }
        }
      }
      
      try {
        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹æ›´æ–°ã®å ´åˆã¯ã€åŒä¸€æ³¨æ–‡IDã®å…¨è¡Œã‚’æ›´æ–°
        if (checked !== null) {
          // ç¾åœ¨ã®è¡Œã‹ã‚‰æ³¨æ–‡IDã‚’å–å¾—
          const currentReservation = allReservations.find(r => r.rowId === parseInt(rowId));
          if (currentReservation) {
            // åŒä¸€æ³¨æ–‡IDã®å…¨è¡Œã‚’æ›´æ–°
            const sameOrderRows = allReservations
              .filter(r => r.orderId === currentReservation.orderId)
              .map(r => r.rowId);
            
            console.log('åŒä¸€æ³¨æ–‡IDè¡Œä¸€æ‹¬æ›´æ–°:', {orderId: currentReservation.orderId, rows: sameOrderRows});
            
            // å„è¡Œã‚’é †æ¬¡æ›´æ–°
            updateMultipleRows(sameOrderRows, checked, memo, staffName);
            return;
          }
        }
        
        // ãƒ¡ãƒ¢æ›´æ–°ã®å ´åˆã¯å˜ä¸€è¡Œã®ã¿æ›´æ–°ï¼ˆå¾“æ¥é€šã‚Šï¼‰
        updateSingleRow(rowId, checked, memo, originalButton, autoSaveMessage, staffName);
        
      } catch (error) {
        console.error('UpdateåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        showError('æ›´æ–°å‡¦ç†ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        
        // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
        if (originalButton) {
          originalButton.disabled = false;
          if (memo !== null) {
            const textSpan = originalButton.querySelector('.save-btn-text');
            if (textSpan) {
              textSpan.textContent = 'ãƒ¡ãƒ¢ä¿å­˜';
            } else {
              originalButton.innerHTML = 'ğŸ“ <span class="save-btn-text">ãƒ¡ãƒ¢ä¿å­˜</span>';
            }
          }
        }
        
        // è‡ªå‹•ä¿å­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
        if (autoSaveMessage) {
          autoSaveMessage.style.display = 'none';
        }
      }
    }

    // è¤‡æ•°è¡Œã‚’é †æ¬¡æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateMultipleRows(rowIds, checked, memo, staffName) {
      let completedCount = 0;
      let totalCount = rowIds.length;
      let hasError = false;

      console.log('è¤‡æ•°è¡Œæ›´æ–°é–‹å§‹:', {rowIds, checked, memo, totalCount});

      rowIds.forEach((rowId, index) => {
        setTimeout(() => {
          updateSingleRowInternal(rowId, checked, memo, staffName, (success) => {
            completedCount++;
            if (!success) hasError = true;

            console.log('è¡Œæ›´æ–°å®Œäº†:', {rowId, success, completedCount, totalCount});

            // å…¨è¡Œã®æ›´æ–°ãŒå®Œäº†ã—ãŸå ´åˆ
            if (completedCount >= totalCount) {
              if (hasError) {
                showError('ä¸€éƒ¨ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
              } else {
                console.log('å…¨è¡Œæ›´æ–°å®Œäº†');
              }
              // å…¨ã¦å®Œäº†å¾Œã«ãƒªãƒ­ãƒ¼ãƒ‰
              setTimeout(() => {
                loadReservations();
              }, 500);
            }
          });
        }, index * 200); // 200msé–“éš”ã§é †æ¬¡å®Ÿè¡Œ
      });
    }

    // å˜ä¸€è¡Œæ›´æ–°ã®å†…éƒ¨é–¢æ•°
    function updateSingleRowInternal(rowId, checked, memo, staffName, callback) {
      try {
        const callbackName = 'updateCallback' + Date.now() + '_' + rowId;
        console.log('å˜ä¸€è¡Œæ›´æ–°é–‹å§‹:', {rowId, callbackName});

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å®šç¾©
        window[callbackName] = function(result) {
          console.log('=== å˜ä¸€è¡ŒResponseå—ä¿¡ ===', {rowId, result});
          
          try {
            const success = result && result.success;
            if (success) {
              console.log('å˜ä¸€è¡Œæ›´æ–°æˆåŠŸ:', rowId);
            } else {
              console.error('å˜ä¸€è¡Œæ›´æ–°å¤±æ•—:', {rowId, result});
            }
            if (callback) callback(success);
          } catch (error) {
            console.error('å˜ä¸€è¡Œå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
            if (callback) callback(false);
          } finally {
            cleanupJSONP(callbackName);
          }
        };

        // JSONP URLã‚’ä½œæˆ
        const params = new URLSearchParams({
          action: 'updateReservation',
          shop: SHOP_SECRET,
          rowId: parseInt(rowId),
          callback: callbackName,
          _t: Date.now()
        });

        if (checked !== null && checked !== undefined) {
          params.append('checked', checked ? '1' : '0');
        }
        if (memo !== null && memo !== undefined) {
          params.append('memo', memo);
        }
        if (staffName !== null && staffName !== undefined) {
          params.append('staffName', staffName);
        }

        const jsonpUrl = `${GAS_API_URL}?${params.toString()}`;
        console.log('å˜ä¸€è¡ŒJSONP URL:', jsonpUrl);

        // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’ä½œæˆãƒ»å®Ÿè¡Œ
        const script = document.createElement('script');
        script.src = jsonpUrl;
        script.setAttribute('data-jsonp', 'true');
        script.setAttribute('data-callback', callbackName);

        script.onerror = function(error) {
          console.error('å˜ä¸€è¡ŒJSONPèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', {rowId, error});
          if (callback) callback(false);
          cleanupJSONP(callbackName);
        };

        document.head.appendChild(script);

        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
        setTimeout(() => {
          if (window[callbackName]) {
            console.warn('å˜ä¸€è¡ŒJSONP ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ:', rowId);
            if (callback) callback(false);
            cleanupJSONP(callbackName);
          }
        }, 5000);

      } catch (error) {
        console.error('å˜ä¸€è¡Œæ›´æ–°åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        if (callback) callback(false);
      }
    }

    // å˜ä¸€è¡Œæ›´æ–°é–¢æ•°ï¼ˆUIä»˜ãï¼‰
    function updateSingleRow(rowId, checked, memo, originalButton, autoSaveMessage, staffName) {
      try {
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        if (originalButton) {
          originalButton.disabled = true;
          if (memo !== null) {
            const textSpan = originalButton.querySelector('.save-btn-text');
            if (textSpan) {
              textSpan.textContent = 'æ›´æ–°ä¸­...';
            } else {
              originalButton.innerHTML = 'ğŸ“ æ›´æ–°ä¸­...';
            }
          }
        }

        const callbackName = 'updateCallback' + Date.now() + '_single';
        console.log('å˜ä¸€è¡ŒUIæ›´æ–°é–‹å§‹:', {rowId, callbackName});

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å®šç¾©
        window[callbackName] = function(result) {
          console.log('=== å˜ä¸€è¡ŒUI Responseå—ä¿¡ ===', {rowId, result});
          
          try {
            if (result && result.success) {
              console.log('å˜ä¸€è¡ŒUIæ›´æ–°æˆåŠŸ:', rowId);
              // æ›´æ–°æˆåŠŸæ™‚ã«å†èª­ã¿è¾¼ã¿
              setTimeout(() => {
                loadReservations();
              }, 500);
            } else {
              console.error('å˜ä¸€è¡ŒUIæ›´æ–°å¤±æ•—:', {rowId, result});
              showError(result ? result.error : 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
          } catch (error) {
            console.error('å˜ä¸€è¡ŒUIå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
            showError('æ›´æ–°å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
          } finally {
            // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            cleanupJSONP(callbackName);
            
            // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
            if (originalButton) {
              originalButton.disabled = false;
              if (memo !== null) {
                const textSpan = originalButton.querySelector('.save-btn-text');
                if (textSpan) {
                  textSpan.textContent = 'ãƒ¡ãƒ¢ä¿å­˜';
                } else {
                  originalButton.innerHTML = 'ğŸ“ <span class="save-btn-text">ãƒ¡ãƒ¢ä¿å­˜</span>';
                }
              }
            }
            
            // è‡ªå‹•ä¿å­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
            if (autoSaveMessage) {
              setTimeout(() => {
                autoSaveMessage.style.display = 'none';
              }, 1000);
            }
          }
        };

        // JSONP URLã‚’ä½œæˆ
        const params = new URLSearchParams({
          action: 'updateReservation',
          shop: SHOP_SECRET,
          rowId: parseInt(rowId),
          callback: callbackName,
          _t: Date.now()
        });

        if (checked !== null && checked !== undefined) {
          params.append('checked', checked ? '1' : '0');
        }
        if (memo !== null && memo !== undefined) {
          params.append('memo', memo);
        }
        if (staffName !== null && staffName !== undefined) {
          params.append('staffName', staffName);
        }

        const jsonpUrl = `${GAS_API_URL}?${params.toString()}`;
        console.log('å˜ä¸€è¡ŒUI JSONP URL:', jsonpUrl);

        // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’ä½œæˆãƒ»å®Ÿè¡Œ
        const script = document.createElement('script');
        script.src = jsonpUrl;
        script.setAttribute('data-jsonp', 'true');
        script.setAttribute('data-callback', callbackName);

        script.onerror = function(error) {
          console.error('å˜ä¸€è¡ŒUI JSONPèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', {rowId, error});
          showError('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
          cleanupJSONP(callbackName);
          
          // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
          if (originalButton) {
            originalButton.disabled = false;
            if (memo !== null) {
              const textSpan = originalButton.querySelector('.save-btn-text');
              if (textSpan) {
                textSpan.textContent = 'ãƒ¡ãƒ¢ä¿å­˜';
              } else {
                originalButton.innerHTML = 'ğŸ“ <span class="save-btn-text">ãƒ¡ãƒ¢ä¿å­˜</span>';
              }
            }
          }
          
          // è‡ªå‹•ä¿å­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
          if (autoSaveMessage) {
            autoSaveMessage.style.display = 'none';
          }
        };

        script.onload = function() {
          console.log('å˜ä¸€è¡ŒUI JSONPã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†');
        };

        document.head.appendChild(script);

        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
        setTimeout(() => {
          if (window[callbackName]) {
            console.warn('å˜ä¸€è¡ŒUI JSONP ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ:', rowId);
            showError('æ›´æ–°ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
            cleanupJSONP(callbackName);
            
            // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
            if (originalButton) {
              originalButton.disabled = false;
              if (memo !== null) {
                const textSpan = originalButton.querySelector('.save-btn-text');
                if (textSpan) {
                  textSpan.textContent = 'ãƒ¡ãƒ¢ä¿å­˜';
                } else {
                  originalButton.innerHTML = 'ğŸ“ <span class="save-btn-text">ãƒ¡ãƒ¢ä¿å­˜</span>';
                }
              }
            }
            
            // è‡ªå‹•ä¿å­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
            if (autoSaveMessage) {
              autoSaveMessage.style.display = 'none';
            }
          }
        }, 10000);

      } catch (error) {
        console.error('å˜ä¸€è¡ŒUIæ›´æ–°åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        showError('æ›´æ–°å‡¦ç†ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        
        // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
        if (originalButton) {
          originalButton.disabled = false;
          if (memo !== null) {
            const textSpan = originalButton.querySelector('.save-btn-text');
            if (textSpan) {
              textSpan.textContent = 'ãƒ¡ãƒ¢ä¿å­˜';
            } else {
              originalButton.innerHTML = 'ğŸ“ <span class="save-btn-text">ãƒ¡ãƒ¢ä¿å­˜</span>';
            }
          }
        }
        
        // è‡ªå‹•ä¿å­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
        if (autoSaveMessage) {
          autoSaveMessage.style.display = 'none';
        }
      }
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    function filterReservations(filter) {
      currentFilter = filter;
      
      // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
      document.querySelectorAll('.controls .btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(`filter-${filter}`).classList.add('active');
      
      // è¡¨ç¤ºã™ã‚‹äºˆç´„ã‚’æ±ºå®š
      let filteredReservations = [];
      const today = getTodayString();
      
      if (filter === 'today') {
        // æœ¬æ—¥åˆ†ã®ã¿
        filteredReservations = allReservations.filter(reservation => {
          return reservation.pickupDate === today;
        });
      } else {
        filteredReservations = allReservations;
      }
      
      // å®Œäº†çŠ¶æ…‹ã§ã•ã‚‰ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const groupedFiltered = groupByOrderId(filteredReservations);
      
      // ã‚«ãƒ¼ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
      const cards = document.querySelectorAll('.reservation-card');
      let visibleCount = 0;
      
      cards.forEach(card => {
        const orderId = card.querySelector('[id^="check-"]').id.replace('check-', '');
        const matchingGroup = groupedFiltered.find(group => group.orderId === orderId);
        
        if (!matchingGroup) {
          card.style.display = 'none';
          return;
        }
        
        const isCompleted = matchingGroup.items.every(item => item.isCompleted);
        const cardFilter = isCompleted ? 'completed' : 'pending';
        
        if (filter === 'all' || filter === 'today' || cardFilter === filter) {
          card.style.display = 'block';
          visibleCount++;
        } else {
          card.style.display = 'none';
        }
      });
      
      // è¡¨ç¤ºã™ã‚‹äºˆç´„ãŒãªã„å ´åˆ
      const listContainer = document.getElementById('reservation-list');
      const noDataContainer = document.getElementById('no-data');
      
      if (visibleCount === 0 && allReservations.length > 0) {
        listContainer.style.display = 'none';
        noDataContainer.style.display = 'block';
        
        let message = '';
        if (filter === 'today') {
          message = 'æœ¬æ—¥åˆ†ã®äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
        } else if (filter === 'pending') {
          message = 'ã€Œæœªå®Œäº†ã€ã®äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
        } else if (filter === 'completed') {
          message = 'ã€Œå®Œäº†æ¸ˆã¿ã€ã®äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
        }
        
        noDataContainer.innerHTML = `
          <h3>ğŸ“‹ è¡¨ç¤ºã™ã‚‹äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“</h3>
          <p>${message}</p>
        `;
      } else if (visibleCount > 0) {
        listContainer.style.display = 'grid';
        noDataContainer.style.display = 'none';
      }
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºåˆ¶å¾¡
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }

    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºåˆ¶å¾¡
    function showError(message) {
      const errorDiv = document.getElementById('error-message');
      const errorText = document.getElementById('error-text');
      errorText.textContent = message;
      errorDiv.style.display = 'flex';
      
      // 5ç§’å¾Œã«è‡ªå‹•ã§éè¡¨ç¤º
      setTimeout(() => {
        hideError();
      }, 5000);
    }

    function hideError() {
      document.getElementById('error-message').style.display = 'none';
    }

    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // æ—¥æ™‚ã‚’èª­ã¿ã‚„ã™ã„æ—¥æœ¬èªå½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatPickupDateTime(dateStr, timeStr) {
      try {
        // æ—¥ä»˜ã‚’è§£æ
        const date = new Date(dateStr);
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        
        // æ›œæ—¥ã‚’å–å¾—
        const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
        const dayOfWeek = dayNames[date.getDay()];
        
        // æ™‚åˆ»ã‚’è§£æãƒ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        let formattedTime = '';
        
        if (timeStr) {
          // ISOå½¢å¼ã®å ´åˆï¼ˆä¾‹ï¼š1899-12-30T03:30:00.000Zï¼‰
          if (timeStr.includes('T') && timeStr.includes('Z')) {
            const timeDate = new Date(timeStr);
            const hours = timeDate.getHours().toString().padStart(2, '0');
            const minutes = timeDate.getMinutes().toString().padStart(2, '0');
            formattedTime = `${hours}:${minutes}`;
          }
          // ã™ã§ã«HH:MMå½¢å¼ã®å ´åˆ
          else if (timeStr.match(/^\d{1,2}:\d{2}$/)) {
            formattedTime = timeStr;
          }
          // ãã®ä»–ã®å½¢å¼ã®å ´åˆã¯æ–‡å­—åˆ—ã‚’ãã®ã¾ã¾ä½¿ç”¨
          else {
            formattedTime = timeStr;
          }
        }
        
        return `${year}å¹´${month}æœˆ${day}æ—¥ï¼ˆ${dayOfWeek}ï¼‰ ${formattedTime}`;
        
      } catch (error) {
        console.warn('æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error, {dateStr, timeStr});
        return `${dateStr} ${timeStr}`;
      }
    }

    // åˆæœŸãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è¨­å®š
    setTimeout(() => {
      document.getElementById('filter-all').classList.add('active');
    }, 100);

    // ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³å¤‰æ›´å‡¦ç†
    function handleToggleChange(rowId, toggleElement) {
      console.log('=== handleToggleChangeé–‹å§‹ ===', {rowId, checked: toggleElement.checked});
      
      if (toggleElement.checked) {
        // ONã«ã™ã‚‹å ´åˆï¼šæ‹…å½“è€…åå…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        pendingToggleRowId = rowId;
        pendingToggleElement = toggleElement;
        showStaffModal();
      } else {
        // OFFã«ã™ã‚‹å ´åˆï¼šç›´æ¥æ›´æ–°
        updateReservation(rowId, false, null, null);
      }
    }

    // æ‹…å½“è€…åå…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    function showStaffModal() {
      const modal = document.getElementById('staff-modal');
      const input = document.getElementById('staff-name-input');
      input.value = '';
      modal.style.display = 'flex';
      setTimeout(() => {
        input.focus();
      }, 100);
      
      // ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼ã§ç¢ºå®š
      input.onkeypress = function(e) {
        if (e.key === 'Enter') {
          confirmStaffInput();
        }
      };
    }

    // æ‹…å½“è€…åå…¥åŠ›ç¢ºå®š
    function confirmStaffInput() {
      const staffName = document.getElementById('staff-name-input').value.trim();
      
      if (!staffName) {
        alert('æ‹…å½“è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      
      if (staffName.length > 50) {
        alert('æ‹…å½“è€…åã¯50æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      document.getElementById('staff-modal').style.display = 'none';
      
      // äºˆç´„ã‚’æ›´æ–°ï¼ˆå—æ¸¡å®Œäº† + æ‹…å½“è€…åï¼‰
      updateReservation(pendingToggleRowId, true, null, staffName);
      
      // å¤‰æ•°ã‚’ã‚¯ãƒªã‚¢
      pendingToggleRowId = null;
      pendingToggleElement = null;
    }

    // æ‹…å½“è€…åå…¥åŠ›ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    function cancelStaffInput() {
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      document.getElementById('staff-modal').style.display = 'none';
      
      // ãƒˆã‚°ãƒ«ã‚’å…ƒã«æˆ»ã™
      if (pendingToggleElement) {
        pendingToggleElement.checked = false;
      }
      
      // å¤‰æ•°ã‚’ã‚¯ãƒªã‚¢
      pendingToggleRowId = null;
      pendingToggleElement = null;
    }
  </script>
</body>
</html> 
