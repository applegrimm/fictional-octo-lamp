<!--
  @file manage.html
  @brief åº—èˆ—ç®¡ç†ç”»é¢ - ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆäºˆç´„ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
  @details ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆURLã«ã‚ˆã‚‹åº—èˆ—èªè¨¼ã€äºˆç´„ä¸€è¦§è¡¨ç¤ºã€å—æ¸¡æ¸ˆã¿ãƒã‚§ãƒƒã‚¯ã€ãƒ¡ãƒ¢æ©Ÿèƒ½
  @version 1.0
-->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åº—èˆ—ç®¡ç†ç”»é¢ - ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆäºˆç´„ç®¡ç†</title>
  <style>
    * { 
      box-sizing: border-box; 
    }
    
    body {
      font-family: 'Segoe UI', 'Meiryo', sans-serif;
      margin: 0;
      padding: 16px;
      background-color: #f5f5f5;
      line-height: 1.5;
    }
    
    .header {
      background: linear-gradient(135deg, #2c3e50, #34495e);
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 24px;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      margin: 0 0 8px 0;
      font-size: 1.6em;
      font-weight: 600;
    }
    
    .header .subtitle {
      font-size: 0.9em;
      opacity: 0.9;
    }
    
    .auth-error {
      background: #e74c3c;
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      margin: 40px auto;
      max-width: 500px;
    }
    
    .auth-error h2 {
      margin: 0 0 12px 0;
    }
    
    .controls {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 24px;
    }
    
    .btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 500;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .btn:hover {
      background: #2980b9;
      transform: translateY(-1px);
    }
    
    .btn.refresh {
      background: #27ae60;
    }
    
    .btn.refresh:hover {
      background: #229954;
    }
    
    .btn.active {
      background: #e67e22;
    }
    
    .btn.active:hover {
      background: #d35400;
    }
    
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #666;
      background: white;
      border-radius: 8px;
      margin: 20px 0;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error {
      background: #e74c3c;
      color: white;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .no-data {
      text-align: center;
      padding: 60px 20px;
      color: #666;
      background: white;
      border-radius: 12px;
      margin: 20px 0;
    }
    
    .no-data h3 {
      margin: 0 0 12px 0;
      color: #555;
    }
    
    .reservation-list {
      display: grid;
      gap: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .reservation-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      position: relative;
      transition: all 0.2s ease;
      border: 1px solid #e1e8ed;
    }
    
    .reservation-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    }
    
    .reservation-card.completed {
      background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
      border-left: 6px solid #27ae60;
    }
    
    .reservation-card.pending {
      border-left: 6px solid #f39c12;
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .pickup-info {
      font-weight: 600;
      font-size: 1.2em;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status.pending {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .status.completed {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .customer-info {
      margin: 16px 0;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }
    
    .customer-info .row {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
    }
    
    .customer-info .row:last-child {
      margin-bottom: 0;
    }
    
    .customer-info .icon {
      width: 20px;
      text-align: center;
    }
    
    .phone-link {
      color: #3498db;
      text-decoration: none;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    
    .phone-link:hover {
      background: #3498db;
      color: white;
    }
    
    .products {
      background: #f1f3f4;
      padding: 16px;
      border-radius: 8px;
      margin: 16px 0;
      border: 1px solid #dee2e6;
    }
    
    .products .title {
      font-weight: 600;
      margin-bottom: 8px;
      color: #495057;
    }
    
    .product-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px solid #e9ecef;
    }
    
    .product-item:last-child {
      border-bottom: none;
    }
    
    .product-name {
      font-weight: 500;
    }
    
    .product-price {
      color: #666;
      font-weight: 600;
    }
    
    .total {
      font-weight: 700;
      font-size: 1.3em;
      color: #e74c3c;
      text-align: right;
      margin: 16px 0;
      padding: 12px;
      background: #fff5f5;
      border-radius: 8px;
      border: 1px solid #f8d7da;
    }
    
    .note {
      margin: 16px 0;
      padding: 12px;
      background: #e9ecef;
      border-radius: 8px;
      color: #495057;
      border-left: 4px solid #6c757d;
    }
    
    .note .title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .controls-row {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid #e9ecef;
      flex-wrap: wrap;
    }
    
    .checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }
    
    .checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .memo-area {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 250px;
    }
    
    .memo-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-size: 0.9em;
      transition: border-color 0.2s ease;
    }
    
    .memo-input:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }
    
    .save-btn {
      background: #f39c12;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 500;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .save-btn:hover {
      background: #e67e22;
      transform: translateY(-1px);
    }
    
    .stats {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    
    .stat-card {
      background: white;
      padding: 16px 24px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      min-width: 120px;
    }
    
    .stat-number {
      font-size: 1.8em;
      font-weight: 700;
      color: #2c3e50;
    }
    
    .stat-label {
      font-size: 0.9em;
      color: #666;
      margin-top: 4px;
    }
    
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
    @media (max-width: 768px) {
      body { 
        padding: 12px; 
      }
      
      .header { 
        padding: 16px; 
      }
      
      .header h1 { 
        font-size: 1.3em; 
      }
      
      .reservation-card { 
        padding: 16px; 
      }
      
      .controls-row { 
        flex-direction: column; 
        align-items: stretch; 
        gap: 12px;
      }
      
      .memo-area { 
        min-width: auto; 
      }
      
      .card-header { 
        flex-direction: column; 
        align-items: flex-start;
      }
      
      .customer-info .row {
        flex-wrap: wrap;
      }
      
      .stats {
        gap: 12px;
      }
      
      .stat-card {
        min-width: 100px;
        padding: 12px 16px;
      }
    }
    
    @media (max-width: 480px) {
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .btn {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <!-- èªè¨¼ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
  <div id="auth-error" class="auth-error" style="display: none;">
    <h2>ğŸ”’ ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚¨ãƒ©ãƒ¼</h2>
    <p>ã“ã®ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    <p>æ­£ã—ã„ç®¡ç†ç”»é¢URLã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚</p>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
  <div id="main-content" style="display: none;">
    <div class="header">
      <h1 id="store-name">åº—èˆ—ç®¡ç†ç”»é¢</h1>
      <div class="subtitle">æœ¬æ—¥ä»¥é™ã®äºˆç´„ä¸€è¦§</div>
    </div>
    
    <!-- çµ±è¨ˆæƒ…å ± -->
    <div class="stats" id="stats">
      <div class="stat-card">
        <div class="stat-number" id="total-count">0</div>
        <div class="stat-label">ç·äºˆç´„æ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="pending-count">0</div>
        <div class="stat-label">æœªå®Œäº†</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="completed-count">0</div>
        <div class="stat-label">å®Œäº†æ¸ˆã¿</div>
      </div>
    </div>
    
    <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
    <div class="controls">
      <button class="btn refresh" onclick="loadReservations()">
        ğŸ”„ æ›´æ–°
      </button>
      <button class="btn" id="filter-all" onclick="filterReservations('all')">
        ğŸ“‹ å…¨ã¦è¡¨ç¤º
      </button>
      <button class="btn" id="filter-pending" onclick="filterReservations('pending')">
        â³ æœªå®Œäº†ã®ã¿
      </button>
      <button class="btn" id="filter-completed" onclick="filterReservations('completed')">
        âœ… å®Œäº†æ¸ˆã¿ã®ã¿
      </button>
    </div>
    
    <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div id="error-message" class="error" style="display: none;">
      <span>âš ï¸</span>
      <span id="error-text"></span>
    </div>
    
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <div>äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
    
    <!-- äºˆç´„ä¸€è¦§ -->
    <div id="reservation-list" class="reservation-list" style="display: none;"></div>
    
    <!-- ãƒ‡ãƒ¼ã‚¿ãªã— -->
    <div id="no-data" class="no-data" style="display: none;">
      <h3>ğŸ“‹ äºˆç´„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h3>
      <p>æœ¬æ—¥ä»¥é™ã®äºˆç´„ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    </div>
  </div>

  <script>
    // GitHub Pages URL: https://applegrimm.github.io/fictional-octo-lamp/
    // GASã®Webã‚¢ãƒ—ãƒªURLï¼ˆå®Ÿéš›ã®URLã«å¤‰æ›´ã—ã¦ãã ã•ã„ï¼‰
    // âš ï¸ é‡è¦: æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ä½œæˆã—ãŸå ´åˆã¯ã€ä»¥ä¸‹ã®URLã‚’æ›´æ–°ã—ã¦ãã ã•ã„
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwgeG189yH0YGt6gpqpYHoclCnZe4cbo8jARRaHCqjgxpiD_XW47taPqNFlQYDhfaYaCg/exec';
    
    let SHOP_SECRET = '';
    let allReservations = [];
    let currentFilter = 'all';

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
    window.addEventListener('DOMContentLoaded', function() {
      console.log('=== ç®¡ç†ç”»é¢èª­ã¿è¾¼ã¿é–‹å§‹ ===');
      
      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰shopã‚’å–å¾—
      const urlParams = new URLSearchParams(window.location.search);
      SHOP_SECRET = urlParams.get('shop');
      
      console.log('Shop Secret:', SHOP_SECRET);
      console.log('GAS API URL:', GAS_API_URL);
      
      if (!SHOP_SECRET) {
        console.log('Shop SecretãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        showAuthError();
        return;
      }
      
      // ãƒ¡ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤º
      document.getElementById('main-content').style.display = 'block';
      
      // äºˆç´„ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ï¼ˆJSONPæ–¹å¼ï¼‰
      console.log('äºˆç´„ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹ï¼ˆJSONPæ–¹å¼ï¼‰');
      loadReservations();
    });

    // èªè¨¼ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    function showAuthError() {
      document.getElementById('auth-error').style.display = 'block';
      document.getElementById('main-content').style.display = 'none';
    }

    // äºˆç´„ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ï¼ˆå®Œå…¨JSONPç‰ˆãƒ»CORSã‚¨ãƒ©ãƒ¼0%ä¿è¨¼ï¼‰
    function loadReservations() {
      console.log('=== loadReservationsé–‹å§‹ ===');
      showLoading(true);
      hideError();

      try {
        // JSONPæ–¹å¼ï¼šã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã§CORSã‚’å®Œå…¨å›é¿
        const callbackName = 'reservationCallback' + Date.now();
        console.log('JSONP Callbackå:', callbackName);
        
        // æ—¢å­˜ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’å‰Šé™¤ï¼ˆã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼‰
        const existingScripts = document.querySelectorAll('script[data-jsonp="true"]');
        existingScripts.forEach(script => script.remove());
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å®šç¾©
        window[callbackName] = function(data) {
          console.log('=== JSONP Responseå—ä¿¡ ===', data);
          
          try {
            if (data && data.success) {
              console.log('äºˆç´„ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', data.data.length + 'ä»¶');
              allReservations = data.data || [];
              
              // åº—èˆ—åã‚’è¨­å®š
              if (data.storeName) {
                document.getElementById('store-name').textContent = data.storeName + ' - äºˆç´„ç®¡ç†ç”»é¢';
                console.log('åº—èˆ—åè¨­å®š:', data.storeName);
              }
              
              // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
              updateStats(allReservations);
              
              // äºˆç´„ä¸€è¦§ã‚’è¡¨ç¤º
              displayReservations(allReservations);
              
            } else {
              console.error('APIã‚¨ãƒ©ãƒ¼:', data);
              if (data && data.error && data.error.includes('ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™')) {
                showAuthError();
              } else {
                showError(data ? data.error : 'äºˆç´„ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
              }
            }
          } catch (error) {
            console.error('ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
            showError('ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
          } finally {
            // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            cleanupJSONP(callbackName);
            showLoading(false);
          }
        };
        
        // JSONPãƒªã‚¯ã‚¨ã‚¹ãƒˆURLä½œæˆ
        const jsonpUrl = `${GAS_API_URL}?action=getReservations&shop=${encodeURIComponent(SHOP_SECRET)}&callback=${callbackName}&_t=${Date.now()}`;
        console.log('JSONP URL:', jsonpUrl);
        
        // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’ä½œæˆ
        const script = document.createElement('script');
        script.src = jsonpUrl;
        script.setAttribute('data-jsonp', 'true');
        script.setAttribute('data-callback', callbackName);
        
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        script.onerror = function(error) {
          console.error('JSONPèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
          showError('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚GASã®URLã¾ãŸã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
          cleanupJSONP(callbackName);
          showLoading(false);
        };
        
        script.onload = function() {
          console.log('JSONPã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†');
        };
        
        // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’è¿½åŠ ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆå®Ÿè¡Œ
        document.head.appendChild(script);
        
        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ10ç§’ï¼‰
        setTimeout(() => {
          if (window[callbackName]) {
            console.warn('JSONP ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ');
            showError('ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            cleanupJSONP(callbackName);
            showLoading(false);
          }
        }, 10000);
        
      } catch (error) {
        console.error('JSONPåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        showError('äºˆç´„ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        showLoading(false);
      }
    }

    // JSONP ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°
    function cleanupJSONP(callbackName) {
      try {
        // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’å‰Šé™¤
        const script = document.querySelector(`script[data-callback="${callbackName}"]`);
        if (script && script.parentNode) {
          script.parentNode.removeChild(script);
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å‰Šé™¤
        if (window[callbackName]) {
          delete window[callbackName];
        }
        
        console.log('JSONP ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†:', callbackName);
      } catch (error) {
        console.warn('JSONP ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
    function updateStats(reservations) {
      const grouped = groupByOrderId(reservations);
      const totalCount = grouped.length;
      const completedCount = grouped.filter(group => 
        group.items.every(item => item.isCompleted)
      ).length;
      const pendingCount = totalCount - completedCount;

      document.getElementById('total-count').textContent = totalCount;
      document.getElementById('pending-count').textContent = pendingCount;
      document.getElementById('completed-count').textContent = completedCount;
    }

    // äºˆç´„ä¸€è¦§ã‚’è¡¨ç¤º
    function displayReservations(reservations) {
      const listContainer = document.getElementById('reservation-list');
      const noDataContainer = document.getElementById('no-data');

      if (reservations.length === 0) {
        listContainer.style.display = 'none';
        noDataContainer.style.display = 'block';
        return;
      }

      listContainer.style.display = 'grid';
      noDataContainer.style.display = 'none';

      // æ³¨æ–‡IDã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const groupedReservations = groupByOrderId(reservations);

      listContainer.innerHTML = groupedReservations.map(group => {
        const isCompleted = group.items.every(item => item.isCompleted);
        const totalAmount = group.items[0].total;
        const customer = group.items[0];

        return `
          <div class="reservation-card ${isCompleted ? 'completed' : 'pending'}" data-filter="${isCompleted ? 'completed' : 'pending'}">
            <div class="card-header">
              <div class="pickup-info">
                ğŸ“… ${customer.pickupDate} ${customer.pickupTime}
              </div>
              <div class="status ${isCompleted ? 'completed' : 'pending'}">
                ${isCompleted ? 'å®Œäº†' : 'æœªå®Œäº†'}
              </div>
            </div>
            
            <div class="customer-info">
              <div class="row">
                <span class="icon">ğŸ‘¤</span>
                <strong>${escapeHtml(customer.customerName)}</strong>
              </div>
              <div class="row">
                <span class="icon">ğŸ“</span>
                <a href="tel:${customer.phone}" class="phone-link">${customer.phone}</a>
              </div>
              <div class="row">
                <span class="icon">ğŸ“§</span>
                <span>${escapeHtml(customer.email)}</span>
              </div>
              <div class="row">
                <span class="icon">ğŸ†”</span>
                <span>${escapeHtml(customer.orderId)}</span>
              </div>
            </div>
            
            <div class="products">
              <div class="title">ğŸ“¦ æ³¨æ–‡å†…å®¹</div>
              ${group.items.map(item => `
                <div class="product-item">
                  <span class="product-name">${escapeHtml(item.productName)} Ã— ${item.quantity}</span>
                  <span class="product-price">${item.subtotal}å††</span>
                </div>
              `).join('')}
            </div>
            
            <div class="total">ğŸ’° åˆè¨ˆé‡‘é¡: ${totalAmount}å††</div>
            
            ${customer.note ? `
              <div class="note">
                <div class="title">ğŸ“ ãŠå®¢æ§˜ã‹ã‚‰ã®å‚™è€ƒ</div>
                <div>${escapeHtml(customer.note)}</div>
              </div>
            ` : ''}
            
            <div class="controls-row">
              <div class="checkbox">
                <input type="checkbox" id="check-${group.orderId}" ${isCompleted ? 'checked' : ''} 
                       onchange="console.log('ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å€¤:', this.checked); updateReservation('${group.items[0].rowId}', this.checked, null)">
                <label for="check-${group.orderId}">å—æ¸¡å®Œäº†</label>
              </div>
              
              <div class="memo-area">
                <input type="text" class="memo-input" id="memo-${group.orderId}" 
                       value="${escapeHtml(customer.memo || '')}" placeholder="ã‚¹ã‚¿ãƒƒãƒ•ãƒ¡ãƒ¢ã‚’å…¥åŠ›..." maxlength="200">
                <button class="save-btn" onclick="updateReservation('${group.items[0].rowId}', null, document.getElementById('memo-${group.orderId}').value)">
                  ğŸ’¾ ä¿å­˜
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // æ³¨æ–‡IDã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    function groupByOrderId(reservations) {
      const groups = {};
      
      reservations.forEach(reservation => {
        const orderId = reservation.orderId;
        if (!groups[orderId]) {
          groups[orderId] = {
            orderId: orderId,
            items: []
          };
        }
        groups[orderId].items.push(reservation);
      });
      
      return Object.values(groups).sort((a, b) => {
        const dateA = new Date(a.items[0].pickupDate + ' ' + a.items[0].pickupTime);
        const dateB = new Date(b.items[0].pickupDate + ' ' + b.items[0].pickupTime);
        return dateA - dateB;
      });
    }

    // äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ï¼ˆJSONPæ–¹å¼ãƒ»CORSå®Œå…¨å›é¿ï¼‰
    function updateReservation(rowId, checked, memo) {
      console.log('=== updateReservationé–‹å§‹ ===', {rowId, checked, memo});
      
      // ãƒœã‚¿ãƒ³ã®å‚ç…§ã‚’å–å¾—
      let originalButton = null;
      if (event && event.target) {
        originalButton = event.target;
      }
      
      try {
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        if (originalButton) {
          originalButton.disabled = true;
          if (memo !== null) {
            originalButton.textContent = 'æ›´æ–°ä¸­...';
          }
        }

        // JSONPæ–¹å¼ã§ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        const callbackName = 'updateCallback' + Date.now();
        console.log('Update JSONP Callbackå:', callbackName);
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å®šç¾©
        window[callbackName] = function(result) {
          console.log('=== Update Responseå—ä¿¡ ===', result);
          
          try {
            if (result && result.success) {
              console.log('æ›´æ–°æˆåŠŸ');
              // æ›´æ–°æˆåŠŸæ™‚ã«å†èª­ã¿è¾¼ã¿
              setTimeout(() => {
                loadReservations();
              }, 500);
            } else {
              console.error('æ›´æ–°å¤±æ•—:', result);
              showError(result ? result.error : 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
          } catch (error) {
            console.error('Updateå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
            showError('æ›´æ–°å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
          } finally {
            // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            cleanupJSONP(callbackName);
            
            // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
            if (originalButton) {
              originalButton.disabled = false;
              if (memo !== null) {
                originalButton.textContent = 'ğŸ’¾ ä¿å­˜';
              }
            }
          }
        };
        
        // JSONP URLã‚’ä½œæˆï¼ˆGETãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æ›´æ–°ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ï¼‰
        const params = new URLSearchParams({
          action: 'updateReservation',
          shop: SHOP_SECRET,
          rowId: parseInt(rowId),
          callback: callbackName,
          _t: Date.now()
        });
        
        // checkedã¨memoã¯å€¤ãŒã‚ã‚‹å ´åˆã®ã¿è¿½åŠ 
        if (checked !== null && checked !== undefined) {
          params.append('checked', checked ? '1' : '0');
        }
        if (memo !== null && memo !== undefined) {
          params.append('memo', memo);
        }
        
        const jsonpUrl = `${GAS_API_URL}?${params.toString()}`;
        console.log('Update JSONP URL:', jsonpUrl);
        
        // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’ä½œæˆ
        const script = document.createElement('script');
        script.src = jsonpUrl;
        script.setAttribute('data-jsonp', 'true');
        script.setAttribute('data-callback', callbackName);
        
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        script.onerror = function(error) {
          console.error('Update JSONPèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
          showError('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
          cleanupJSONP(callbackName);
          
          // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
          if (originalButton) {
            originalButton.disabled = false;
            if (memo !== null) {
              originalButton.textContent = 'ğŸ’¾ ä¿å­˜';
            }
          }
        };
        
        script.onload = function() {
          console.log('Update JSONPã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†');
        };
        
        // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’è¿½åŠ ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆå®Ÿè¡Œ
        document.head.appendChild(script);
        
        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ10ç§’ï¼‰
        setTimeout(() => {
          if (window[callbackName]) {
            console.warn('Update JSONP ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ');
            showError('æ›´æ–°ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
            cleanupJSONP(callbackName);
            
            // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
            if (originalButton) {
              originalButton.disabled = false;
              if (memo !== null) {
                originalButton.textContent = 'ğŸ’¾ ä¿å­˜';
              }
            }
          }
        }, 10000);
        
      } catch (error) {
        console.error('Update JSONPåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        showError('æ›´æ–°å‡¦ç†ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        
        // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
        if (originalButton) {
          originalButton.disabled = false;
          if (memo !== null) {
            originalButton.textContent = 'ğŸ’¾ ä¿å­˜';
          }
        }
      }
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    function filterReservations(filter) {
      currentFilter = filter;
      
      // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
      document.querySelectorAll('.controls .btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(`filter-${filter}`).classList.add('active');
      
      // ã‚«ãƒ¼ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
      const cards = document.querySelectorAll('.reservation-card');
      let visibleCount = 0;
      
      cards.forEach(card => {
        const cardFilter = card.getAttribute('data-filter');
        if (filter === 'all' || cardFilter === filter) {
          card.style.display = 'block';
          visibleCount++;
        } else {
          card.style.display = 'none';
        }
      });
      
      // è¡¨ç¤ºã™ã‚‹äºˆç´„ãŒãªã„å ´åˆ
      const listContainer = document.getElementById('reservation-list');
      const noDataContainer = document.getElementById('no-data');
      
      if (visibleCount === 0 && allReservations.length > 0) {
        listContainer.style.display = 'none';
        noDataContainer.style.display = 'block';
        noDataContainer.innerHTML = `
          <h3>ğŸ“‹ è¡¨ç¤ºã™ã‚‹äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“</h3>
          <p>ã€Œ${filter === 'pending' ? 'æœªå®Œäº†' : 'å®Œäº†æ¸ˆã¿'}ã€ã®äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        `;
      } else if (visibleCount > 0) {
        listContainer.style.display = 'grid';
        noDataContainer.style.display = 'none';
      }
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºåˆ¶å¾¡
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }

    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºåˆ¶å¾¡
    function showError(message) {
      const errorDiv = document.getElementById('error-message');
      const errorText = document.getElementById('error-text');
      errorText.textContent = message;
      errorDiv.style.display = 'flex';
      
      // 5ç§’å¾Œã«è‡ªå‹•ã§éè¡¨ç¤º
      setTimeout(() => {
        hideError();
      }, 5000);
    }

    function hideError() {
      document.getElementById('error-message').style.display = 'none';
    }

    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // åˆæœŸãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è¨­å®š
    setTimeout(() => {
      document.getElementById('filter-all').classList.add('active');
    }, 100);
  </script>
</body>
</html> 
