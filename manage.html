<!--
  @file manage.html
  @brief Â∫óËàóÁÆ°ÁêÜÁîªÈù¢ - „ÉÜ„Ç§„ÇØ„Ç¢„Ç¶„Éà‰∫àÁ¥ÑÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†
  @details „Ç∑„Éº„ÇØ„É¨„ÉÉ„ÉàURL„Å´„Çà„ÇãÂ∫óËàóË™çË®º„ÄÅ‰∫àÁ¥Ñ‰∏ÄË¶ßË°®Á§∫„ÄÅÂèóÊ∏°Ê∏à„Åø„ÉÅ„Çß„ÉÉ„ÇØ„ÄÅ„É°„É¢Ê©üËÉΩ
  @version 1.0
-->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Â∫óËàóÁÆ°ÁêÜÁîªÈù¢ - „ÉÜ„Ç§„ÇØ„Ç¢„Ç¶„Éà‰∫àÁ¥ÑÁÆ°ÁêÜ</title>
  <style>
    * { 
      box-sizing: border-box; 
    }
    
    body {
      font-family: 'Segoe UI', 'Meiryo', sans-serif;
      margin: 0;
      padding: 16px;
      background-color: #f5f5f5;
      line-height: 1.5;
    }
    
    .header {
      background: linear-gradient(135deg, #2c3e50, #34495e);
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 24px;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      margin: 0 0 8px 0;
      font-size: 1.6em;
      font-weight: 600;
    }
    
    .header .subtitle {
      font-size: 0.9em;
      opacity: 0.9;
    }
    
    .auth-error {
      background: #e74c3c;
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      margin: 40px auto;
      max-width: 500px;
    }
    
    .auth-error h2 {
      margin: 0 0 12px 0;
    }
    
    .controls {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 24px;
    }
    
    .btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 500;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .btn:hover {
      background: #2980b9;
      transform: translateY(-1px);
    }
    
    .btn.refresh {
      background: #27ae60;
    }
    
    .btn.refresh:hover {
      background: #229954;
    }
    
    .btn.active {
      background: #e67e22;
    }
    
    .btn.active:hover {
      background: #d35400;
    }
    
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #666;
      background: white;
      border-radius: 8px;
      margin: 20px 0;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error {
      background: #e74c3c;
      color: white;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .no-data {
      text-align: center;
      padding: 60px 20px;
      color: #666;
      background: white;
      border-radius: 12px;
      margin: 20px 0;
    }
    
    .no-data h3 {
      margin: 0 0 12px 0;
      color: #555;
    }
    
    .reservation-list {
      display: grid;
      gap: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .reservation-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      position: relative;
      transition: all 0.2s ease;
      border: 1px solid #e1e8ed;
    }
    
    .reservation-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    }
    
    .reservation-card.completed {
      background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
      border-left: 6px solid #27ae60;
    }
    
    .reservation-card.pending {
      border-left: 6px solid #f39c12;
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .pickup-info {
      font-weight: 600;
      font-size: 1.2em;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status.pending {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .status.completed {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .customer-info {
      margin: 16px 0;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }
    
    .customer-info .row {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
    }
    
    .customer-info .row:last-child {
      margin-bottom: 0;
    }
    
    .customer-info .icon {
      width: 20px;
      text-align: center;
    }
    
    .phone-link {
      color: #3498db;
      text-decoration: none;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    
    .phone-link:hover {
      background: #3498db;
      color: white;
    }
    
    .products {
      background: #f1f3f4;
      padding: 16px;
      border-radius: 8px;
      margin: 16px 0;
      border: 1px solid #dee2e6;
    }
    
    .products .title {
      font-weight: 600;
      margin-bottom: 8px;
      color: #495057;
    }
    
    .product-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px solid #e9ecef;
    }
    
    .product-item:last-child {
      border-bottom: none;
    }
    
    .product-name {
      font-weight: 500;
    }
    
    .product-price {
      color: #666;
      font-weight: 600;
    }
    
    .total {
      font-weight: 700;
      font-size: 1.3em;
      color: #e74c3c;
      text-align: right;
      margin: 16px 0;
      padding: 12px;
      background: #fff5f5;
      border-radius: 8px;
      border: 1px solid #f8d7da;
    }
    
    .note {
      margin: 16px 0;
      padding: 12px;
      background: #e9ecef;
      border-radius: 8px;
      color: #495057;
      border-left: 4px solid #6c757d;
    }
    
    .note .title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .controls-row {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid #e9ecef;
      flex-wrap: wrap;
    }
    
    .checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }
    
    .checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .memo-area {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 250px;
    }
    
    .memo-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-size: 0.9em;
      transition: border-color 0.2s ease;
    }
    
    .memo-input:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }
    
    .save-btn {
      background: #f39c12;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 500;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .save-btn:hover {
      background: #e67e22;
      transform: translateY(-1px);
    }
    
    .stats {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    
    .stat-card {
      background: white;
      padding: 16px 24px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      min-width: 120px;
    }
    
    .stat-number {
      font-size: 1.8em;
      font-weight: 700;
      color: #2c3e50;
    }
    
    .stat-label {
      font-size: 0.9em;
      color: #666;
      margin-top: 4px;
    }
    
    /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ„Éá„Ç∂„Ç§„É≥ */
    @media (max-width: 768px) {
      body { 
        padding: 12px; 
      }
      
      .header { 
        padding: 16px; 
      }
      
      .header h1 { 
        font-size: 1.3em; 
      }
      
      .reservation-card { 
        padding: 16px; 
      }
      
      .controls-row { 
        flex-direction: column; 
        align-items: stretch; 
        gap: 12px;
      }
      
      .memo-area { 
        min-width: auto; 
      }
      
      .card-header { 
        flex-direction: column; 
        align-items: flex-start;
      }
      
      .customer-info .row {
        flex-wrap: wrap;
      }
      
      .stats {
        gap: 12px;
      }
      
      .stat-card {
        min-width: 100px;
        padding: 12px 16px;
      }
    }
    
    @media (max-width: 480px) {
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .btn {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <!-- Ë™çË®º„Ç®„É©„ÉºË°®Á§∫„Ç®„É™„Ç¢ -->
  <div id="auth-error" class="auth-error" style="display: none;">
    <h2>üîí „Ç¢„ÇØ„Çª„ÇπÊ®©Èôê„Ç®„É©„Éº</h2>
    <p>„Åì„ÅÆ„Éö„Éº„Ç∏„Å´„Ç¢„ÇØ„Çª„Çπ„Åô„ÇãÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
    <p>Ê≠£„Åó„ÅÑÁÆ°ÁêÜÁîªÈù¢URL„Åã„Çâ„Ç¢„ÇØ„Çª„Çπ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
  </div>

  <!-- „É°„Ç§„É≥ÁîªÈù¢ -->
  <div id="main-content" style="display: none;">
    <div class="header">
      <h1 id="store-name">Â∫óËàóÁÆ°ÁêÜÁîªÈù¢</h1>
      <div class="subtitle">Êú¨Êó•‰ª•Èôç„ÅÆ‰∫àÁ¥Ñ‰∏ÄË¶ß</div>
    </div>
    
    <!-- Áµ±Ë®àÊÉÖÂ†± -->
    <div class="stats" id="stats">
      <div class="stat-card">
        <div class="stat-number" id="total-count">0</div>
        <div class="stat-label">Á∑è‰∫àÁ¥ÑÊï∞</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="pending-count">0</div>
        <div class="stat-label">Êú™ÂÆå‰∫Ü</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="completed-count">0</div>
        <div class="stat-label">ÂÆå‰∫ÜÊ∏à„Åø</div>
      </div>
    </div>
    
    <!-- „Ç≥„É≥„Éà„É≠„Éº„É´„Éú„Çø„É≥ -->
    <div class="controls">
      <button class="btn refresh" onclick="loadReservations()">
        üîÑ Êõ¥Êñ∞
      </button>
      <button class="btn" id="filter-all" onclick="filterReservations('all')">
        üìã ÂÖ®„Å¶Ë°®Á§∫
      </button>
      <button class="btn" id="filter-pending" onclick="filterReservations('pending')">
        ‚è≥ Êú™ÂÆå‰∫Ü„ÅÆ„Åø
      </button>
      <button class="btn" id="filter-completed" onclick="filterReservations('completed')">
        ‚úÖ ÂÆå‰∫ÜÊ∏à„Åø„ÅÆ„Åø
      </button>
    </div>
    
    <!-- „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏ -->
    <div id="error-message" class="error" style="display: none;">
      <span>‚ö†Ô∏è</span>
      <span id="error-text"></span>
    </div>
    
    <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞ -->
    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <div>‰∫àÁ¥Ñ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
    </div>
    
    <!-- ‰∫àÁ¥Ñ‰∏ÄË¶ß -->
    <div id="reservation-list" class="reservation-list" style="display: none;"></div>
    
    <!-- „Éá„Éº„Çø„Å™„Åó -->
    <div id="no-data" class="no-data" style="display: none;">
      <h3>üìã ‰∫àÁ¥Ñ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</h3>
      <p>Êú¨Êó•‰ª•Èôç„ÅÆ‰∫àÁ¥Ñ„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
    </div>
  </div>

  <script>
    // GitHub Pages URL: https://applegrimm.github.io/fictional-octo-lamp/
    // GAS„ÅÆWeb„Ç¢„Éó„É™URLÔºàÂÆüÈöõ„ÅÆURL„Å´Â§âÊõ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ
    // ‚ö†Ô∏è ÈáçË¶Å: Êñ∞„Åó„ÅÑ„Éá„Éó„É≠„Ç§„Çí‰ΩúÊàê„Åó„ÅüÂ†¥Âêà„ÅØ„ÄÅ‰ª•‰∏ã„ÅÆURL„ÇíÊõ¥Êñ∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwgeG189yH0YGt6gpqpYHoclCnZe4cbo8jARRaHCqjgxpiD_XW47taPqNFlQYDhfaYaCg/exec';
    
    let SHOP_SECRET = '';
    let allReservations = [];
    let currentFilter = 'all';

    // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂàùÊúüÂåñ
    window.addEventListener('DOMContentLoaded', function() {
      console.log('=== ÁÆ°ÁêÜÁîªÈù¢Ë™≠„ÅøËæº„ÅøÈñãÂßã ===');
      
      // URL„Éë„É©„É°„Éº„Çø„Åã„Çâshop„ÇíÂèñÂæó
      const urlParams = new URLSearchParams(window.location.search);
      SHOP_SECRET = urlParams.get('shop');
      
      console.log('Shop Secret:', SHOP_SECRET);
      console.log('GAS API URL:', GAS_API_URL);
      
      if (!SHOP_SECRET) {
        console.log('Shop Secret„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
        showAuthError();
        return;
      }
      
      // „É°„Ç§„É≥ÁîªÈù¢„ÇíË°®Á§∫
      document.getElementById('main-content').style.display = 'block';
      
      // ‰∫àÁ¥Ñ‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„ÅøÔºàJSONPÊñπÂºèÔºâ
      console.log('‰∫àÁ¥Ñ„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÈñãÂßãÔºàJSONPÊñπÂºèÔºâ');
      loadReservations();
    });

    // Ë™çË®º„Ç®„É©„ÉºË°®Á§∫
    function showAuthError() {
      document.getElementById('auth-error').style.display = 'block';
      document.getElementById('main-content').style.display = 'none';
    }

    // ‰∫àÁ¥Ñ‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„ÅøÔºàÂÆåÂÖ®JSONPÁâà„ÉªCORS„Ç®„É©„Éº0%‰øùË®ºÔºâ
    function loadReservations() {
      console.log('=== loadReservationsÈñãÂßã ===');
      showLoading(true);
      hideError();

      try {
        // JSONPÊñπÂºèÔºö„Çπ„ÇØ„É™„Éó„Éà„Çø„Ç∞„ÅßCORS„ÇíÂÆåÂÖ®ÂõûÈÅø
        const callbackName = 'reservationCallback' + Date.now();
        console.log('JSONP CallbackÂêç:', callbackName);
        
        // Êó¢Â≠ò„ÅÆ„Çπ„ÇØ„É™„Éó„Éà„Çø„Ç∞„ÇíÂâäÈô§Ôºà„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÔºâ
        const existingScripts = document.querySelectorAll('script[data-jsonp="true"]');
        existingScripts.forEach(script => script.remove());
        
        // „Ç∞„É≠„Éº„Éê„É´„Ç≥„Éº„É´„Éê„ÉÉ„ÇØÈñ¢Êï∞„ÇíÂÆöÁæ©
        window[callbackName] = function(data) {
          console.log('=== JSONP ResponseÂèó‰ø° ===', data);
          
          try {
            if (data && data.success) {
              console.log('‰∫àÁ¥Ñ„Éá„Éº„ÇøÂèñÂæóÊàêÂäü:', data.data.length + '‰ª∂');
              allReservations = data.data || [];
              
              // Â∫óËàóÂêç„ÇíË®≠ÂÆö
              if (data.storeName) {
                document.getElementById('store-name').textContent = data.storeName + ' - ‰∫àÁ¥ÑÁÆ°ÁêÜÁîªÈù¢';
                console.log('Â∫óËàóÂêçË®≠ÂÆö:', data.storeName);
              }
              
              // Áµ±Ë®àÊÉÖÂ†±„ÇíÊõ¥Êñ∞
              updateStats(allReservations);
              
              // ‰∫àÁ¥Ñ‰∏ÄË¶ß„ÇíË°®Á§∫
              displayReservations(allReservations);
              
            } else {
              console.error('API„Ç®„É©„Éº:', data);
              if (data && data.error && data.error.includes('„Ç¢„ÇØ„Çª„ÇπÊ®©Èôê')) {
                showAuthError();
              } else {
                showError(data ? data.error : '‰∫àÁ¥Ñ„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
              }
            }
          } catch (error) {
            console.error('„Éá„Éº„ÇøÂá¶ÁêÜ„Ç®„É©„Éº:', error);
            showError('„Éá„Éº„Çø„ÅÆÂá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
          } finally {
            // „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
            cleanupJSONP(callbackName);
            showLoading(false);
          }
        };
        
        // JSONP„É™„ÇØ„Ç®„Çπ„ÉàURL‰ΩúÊàê
        const jsonpUrl = `${GAS_API_URL}?action=getReservations&shop=${encodeURIComponent(SHOP_SECRET)}&callback=${callbackName}&_t=${Date.now()}`;
        console.log('JSONP URL:', jsonpUrl);
        
        // „Çπ„ÇØ„É™„Éó„Éà„Çø„Ç∞„Çí‰ΩúÊàê
        const script = document.createElement('script');
        script.src = jsonpUrl;
        script.setAttribute('data-jsonp', 'true');
        script.setAttribute('data-callback', callbackName);
        
        // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
        script.onerror = function(error) {
          console.error('JSONPË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
          showError('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇGAS„ÅÆURL„Åæ„Åü„ÅØ„Éá„Éó„É≠„Ç§„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
          cleanupJSONP(callbackName);
          showLoading(false);
        };
        
        script.onload = function() {
          console.log('JSONP„Çπ„ÇØ„É™„Éó„ÉàË™≠„ÅøËæº„ÅøÂÆå‰∫Ü');
        };
        
        // „Çπ„ÇØ„É™„Éó„Éà„Çø„Ç∞„ÇíËøΩÂä†„Åó„Å¶„É™„ÇØ„Ç®„Çπ„ÉàÂÆüË°å
        document.head.appendChild(script);
        
        // „Çø„Ç§„É†„Ç¢„Ç¶„ÉàË®≠ÂÆöÔºà10ÁßíÔºâ
        setTimeout(() => {
          if (window[callbackName]) {
            console.warn('JSONP „Çø„Ç§„É†„Ç¢„Ç¶„Éà');
            showError('„É™„ÇØ„Ç®„Çπ„Éà„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü„ÄÇÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
            cleanupJSONP(callbackName);
            showLoading(false);
          }
        }, 10000);
        
      } catch (error) {
        console.error('JSONPÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
        showError('‰∫àÁ¥Ñ„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„ÅøÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
        showLoading(false);
      }
    }

    // JSONP „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÈñ¢Êï∞
    function cleanupJSONP(callbackName) {
      try {
        // „Çπ„ÇØ„É™„Éó„Éà„Çø„Ç∞„ÇíÂâäÈô§
        const script = document.querySelector(`script[data-callback="${callbackName}"]`);
        if (script && script.parentNode) {
          script.parentNode.removeChild(script);
        }
        
        // „Ç∞„É≠„Éº„Éê„É´„Ç≥„Éº„É´„Éê„ÉÉ„ÇØÈñ¢Êï∞„ÇíÂâäÈô§
        if (window[callbackName]) {
          delete window[callbackName];
        }
        
        console.log('JSONP „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü:', callbackName);
      } catch (error) {
        console.warn('JSONP „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó„Ç®„É©„Éº:', error);
      }
    }

    // Áµ±Ë®àÊÉÖÂ†±„ÇíÊõ¥Êñ∞
    function updateStats(reservations) {
      const grouped = groupByOrderId(reservations);
      const totalCount = grouped.length;
      const completedCount = grouped.filter(group => 
        group.items.every(item => item.isCompleted)
      ).length;
      const pendingCount = totalCount - completedCount;

      document.getElementById('total-count').textContent = totalCount;
      document.getElementById('pending-count').textContent = pendingCount;
      document.getElementById('completed-count').textContent = completedCount;
    }

    // ‰∫àÁ¥Ñ‰∏ÄË¶ß„ÇíË°®Á§∫
    function displayReservations(reservations) {
      const listContainer = document.getElementById('reservation-list');
      const noDataContainer = document.getElementById('no-data');

      if (reservations.length === 0) {
        listContainer.style.display = 'none';
        noDataContainer.style.display = 'block';
        return;
      }

      listContainer.style.display = 'grid';
      noDataContainer.style.display = 'none';

      // Ê≥®ÊñáID„Åî„Å®„Å´„Ç∞„É´„Éº„ÉóÂåñ
      const groupedReservations = groupByOrderId(reservations);

      listContainer.innerHTML = groupedReservations.map(group => {
        const isCompleted = group.items.every(item => item.isCompleted);
        const totalAmount = group.items[0].total;
        const customer = group.items[0];

        return `
          <div class="reservation-card ${isCompleted ? 'completed' : 'pending'}" data-filter="${isCompleted ? 'completed' : 'pending'}">
            <div class="card-header">
              <div class="pickup-info">
                üìÖ ${customer.pickupDate} ${customer.pickupTime}
              </div>
              <div class="status ${isCompleted ? 'completed' : 'pending'}">
                ${isCompleted ? 'ÂÆå‰∫Ü' : 'Êú™ÂÆå‰∫Ü'}
              </div>
            </div>
            
            <div class="customer-info">
              <div class="row">
                <span class="icon">üë§</span>
                <strong>${escapeHtml(customer.customerName)}</strong>
              </div>
              <div class="row">
                <span class="icon">üìû</span>
                <a href="tel:${customer.phone}" class="phone-link">${customer.phone}</a>
              </div>
              <div class="row">
                <span class="icon">üìß</span>
                <span>${escapeHtml(customer.email)}</span>
              </div>
              <div class="row">
                <span class="icon">üÜî</span>
                <span>${escapeHtml(customer.orderId)}</span>
              </div>
            </div>
            
            <div class="products">
              <div class="title">üì¶ Ê≥®ÊñáÂÜÖÂÆπ</div>
              ${group.items.map(item => `
                <div class="product-item">
                  <span class="product-name">${escapeHtml(item.productName)} √ó ${item.quantity}</span>
                  <span class="product-price">${item.subtotal}ÂÜÜ</span>
                </div>
              `).join('')}
            </div>
            
            <div class="total">üí∞ ÂêàË®àÈáëÈ°ç: ${totalAmount}ÂÜÜ</div>
            
            ${customer.note ? `
              <div class="note">
                <div class="title">üìù „ÅäÂÆ¢Êßò„Åã„Çâ„ÅÆÂÇôËÄÉ</div>
                <div>${escapeHtml(customer.note)}</div>
              </div>
            ` : ''}
            
            <div class="controls-row">
              <div class="checkbox">
                <input type="checkbox" id="check-${group.orderId}" ${isCompleted ? 'checked' : ''} 
                       onchange="console.log('„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„ÇπÂÄ§:', this.checked); updateReservation('${group.items[0].rowId}', this.checked, null)">
                <label for="check-${group.orderId}">ÂèóÊ∏°ÂÆå‰∫Ü</label>
              </div>
              
              <div class="memo-area">
                <input type="text" class="memo-input" id="memo-${group.orderId}" 
                       value="${escapeHtml(customer.memo || '')}" placeholder="„Çπ„Çø„ÉÉ„Éï„É°„É¢„ÇíÂÖ•Âäõ..." maxlength="200">
                <button class="save-btn" onclick="updateReservation('${group.items[0].rowId}', null, document.getElementById('memo-${group.orderId}').value)">
                  üíæ ‰øùÂ≠ò
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Ê≥®ÊñáID„Åß„Ç∞„É´„Éº„ÉóÂåñ
    function groupByOrderId(reservations) {
      const groups = {};
      
      reservations.forEach(reservation => {
        const orderId = reservation.orderId;
        if (!groups[orderId]) {
          groups[orderId] = {
            orderId: orderId,
            items: []
          };
        }
        groups[orderId].items.push(reservation);
      });
      
      return Object.values(groups).sort((a, b) => {
        const dateA = new Date(a.items[0].pickupDate + ' ' + a.items[0].pickupTime);
        const dateB = new Date(b.items[0].pickupDate + ' ' + b.items[0].pickupTime);
        return dateA - dateB;
      });
    }

    // ‰∫àÁ¥Ñ„Éá„Éº„Çø„ÇíÊõ¥Êñ∞ÔºàJSONPÊñπÂºè„ÉªCORSÂÆåÂÖ®ÂõûÈÅøÔºâ
    function updateReservation(rowId, checked, memo) {
      console.log('=== updateReservationÈñãÂßã ===', {rowId, checked, memo});
      
      // „Éú„Çø„É≥„ÅÆÂèÇÁÖß„ÇíÂèñÂæó
      let originalButton = null;
      if (event && event.target) {
        originalButton = event.target;
      }
      
      try {
        // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
        if (originalButton) {
          originalButton.disabled = true;
          if (memo !== null) {
            originalButton.textContent = 'Êõ¥Êñ∞‰∏≠...';
          }
        }

        // JSONPÊñπÂºè„Åß„Éá„Éº„ÇøÊõ¥Êñ∞
        const callbackName = 'updateCallback' + Date.now();
        console.log('Update JSONP CallbackÂêç:', callbackName);
        
        // „Ç∞„É≠„Éº„Éê„É´„Ç≥„Éº„É´„Éê„ÉÉ„ÇØÈñ¢Êï∞„ÇíÂÆöÁæ©
        window[callbackName] = function(result) {
          console.log('=== Update ResponseÂèó‰ø° ===', result);
          
          try {
            if (result && result.success) {
              console.log('Êõ¥Êñ∞ÊàêÂäü');
              // Êõ¥Êñ∞ÊàêÂäüÊôÇ„Å´ÂÜçË™≠„ÅøËæº„Åø
              setTimeout(() => {
                loadReservations();
              }, 500);
            } else {
              console.error('Êõ¥Êñ∞Â§±Êïó:', result);
              showError(result ? result.error : 'Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
          } catch (error) {
            console.error('UpdateÂá¶ÁêÜ„Ç®„É©„Éº:', error);
            showError('Êõ¥Êñ∞Âá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
          } finally {
            // „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
            cleanupJSONP(callbackName);
            
            // „Éú„Çø„É≥„ÇíÂÖÉ„Å´Êàª„Åô
            if (originalButton) {
              originalButton.disabled = false;
              if (memo !== null) {
                originalButton.textContent = 'üíæ ‰øùÂ≠ò';
              }
            }
          }
        };
        
        // JSONP URL„Çí‰ΩúÊàêÔºàGET„Éë„É©„É°„Éº„Çø„ÅßÊõ¥Êñ∞„Éá„Éº„Çø„ÇíÈÄÅ‰ø°Ôºâ
        const params = new URLSearchParams({
          action: 'updateReservation',
          shop: SHOP_SECRET,
          rowId: parseInt(rowId),
          callback: callbackName,
          _t: Date.now()
        });
        
        // checked„Å®memo„ÅØÂÄ§„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøËøΩÂä†
        if (checked !== null && checked !== undefined) {
          params.append('checked', checked ? '1' : '0');
        }
        if (memo !== null && memo !== undefined) {
          params.append('memo', memo);
        }
        
        const jsonpUrl = `${GAS_API_URL}?${params.toString()}`;
        console.log('Update JSONP URL:', jsonpUrl);
        
        // „Çπ„ÇØ„É™„Éó„Éà„Çø„Ç∞„Çí‰ΩúÊàê
        const script = document.createElement('script');
        script.src = jsonpUrl;
        script.setAttribute('data-jsonp', 'true');
        script.setAttribute('data-callback', callbackName);
        
        // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
        script.onerror = function(error) {
          console.error('Update JSONPË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
          showError('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
          cleanupJSONP(callbackName);
          
          // „Éú„Çø„É≥„ÇíÂÖÉ„Å´Êàª„Åô
          if (originalButton) {
            originalButton.disabled = false;
            if (memo !== null) {
              originalButton.textContent = 'üíæ ‰øùÂ≠ò';
            }
          }
        };
        
        script.onload = function() {
          console.log('Update JSONP„Çπ„ÇØ„É™„Éó„ÉàË™≠„ÅøËæº„ÅøÂÆå‰∫Ü');
        };
        
        // „Çπ„ÇØ„É™„Éó„Éà„Çø„Ç∞„ÇíËøΩÂä†„Åó„Å¶„É™„ÇØ„Ç®„Çπ„ÉàÂÆüË°å
        document.head.appendChild(script);
        
        // „Çø„Ç§„É†„Ç¢„Ç¶„ÉàË®≠ÂÆöÔºà10ÁßíÔºâ
        setTimeout(() => {
          if (window[callbackName]) {
            console.warn('Update JSONP „Çø„Ç§„É†„Ç¢„Ç¶„Éà');
            showError('Êõ¥Êñ∞„É™„ÇØ„Ç®„Çπ„Éà„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü');
            cleanupJSONP(callbackName);
            
            // „Éú„Çø„É≥„ÇíÂÖÉ„Å´Êàª„Åô
            if (originalButton) {
              originalButton.disabled = false;
              if (memo !== null) {
                originalButton.textContent = 'üíæ ‰øùÂ≠ò';
              }
            }
          }
        }, 10000);
        
      } catch (error) {
        console.error('Update JSONPÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
        showError('Êõ¥Êñ∞Âá¶ÁêÜ„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
        
        // „Éú„Çø„É≥„ÇíÂÖÉ„Å´Êàª„Åô
        if (originalButton) {
          originalButton.disabled = false;
          if (memo !== null) {
            originalButton.textContent = 'üíæ ‰øùÂ≠ò';
          }
        }
      }
    }

    // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞
    function filterReservations(filter) {
      currentFilter = filter;
      
      // „Éú„Çø„É≥„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
      document.querySelectorAll('.controls .btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(`filter-${filter}`).classList.add('active');
      
      // „Ç´„Éº„Éâ„ÅÆË°®Á§∫/ÈùûË°®Á§∫„ÇíÂàá„ÇäÊõø„Åà
      const cards = document.querySelectorAll('.reservation-card');
      let visibleCount = 0;
      
      cards.forEach(card => {
        const cardFilter = card.getAttribute('data-filter');
        if (filter === 'all' || cardFilter === filter) {
          card.style.display = 'block';
          visibleCount++;
        } else {
          card.style.display = 'none';
        }
      });
      
      // Ë°®Á§∫„Åô„Çã‰∫àÁ¥Ñ„Åå„Å™„ÅÑÂ†¥Âêà
      const listContainer = document.getElementById('reservation-list');
      const noDataContainer = document.getElementById('no-data');
      
      if (visibleCount === 0 && allReservations.length > 0) {
        listContainer.style.display = 'none';
        noDataContainer.style.display = 'block';
        noDataContainer.innerHTML = `
          <h3>üìã Ë°®Á§∫„Åô„Çã‰∫àÁ¥Ñ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</h3>
          <p>„Äå${filter === 'pending' ? 'Êú™ÂÆå‰∫Ü' : 'ÂÆå‰∫ÜÊ∏à„Åø'}„Äç„ÅÆ‰∫àÁ¥Ñ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
        `;
      } else if (visibleCount > 0) {
        listContainer.style.display = 'grid';
        noDataContainer.style.display = 'none';
      }
    }

    // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫Âà∂Âæ°
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }

    // „Ç®„É©„ÉºË°®Á§∫Âà∂Âæ°
    function showError(message) {
      const errorDiv = document.getElementById('error-message');
      const errorText = document.getElementById('error-text');
      errorText.textContent = message;
      errorDiv.style.display = 'flex';
      
      // 5ÁßíÂæå„Å´Ëá™Âãï„ÅßÈùûË°®Á§∫
      setTimeout(() => {
        hideError();
      }, 5000);
    }

    function hideError() {
      document.getElementById('error-message').style.display = 'none';
    }

    // HTML„Ç®„Çπ„Ç±„Éº„ÉóÈñ¢Êï∞
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ÂàùÊúü„Éï„Ç£„É´„Çø„Éº„ÇíË®≠ÂÆö
    setTimeout(() => {
      document.getElementById('filter-all').classList.add('active');
    }, 100);
  </script>
</body>
</html> 
