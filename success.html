<!--
  @file success.html
  @brief Stripeæ±ºæ¸ˆå®Œäº†ãƒšãƒ¼ã‚¸
  @details æ±ºæ¸ˆå®Œäº†å¾Œã«äºˆç´„æƒ…å ±ã‚’GASã«é€ä¿¡ã—ã€ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚’å®Ÿè¡Œ
-->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta name="format-detection" content="telephone=no">
  <meta name="mobile-web-app-capable" content="yes">
  <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ãƒ¡ã‚¿ã‚¿ã‚° -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <!-- HTTPS ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¼·åˆ¶ -->
  <script>
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      location.replace('https:' + window.location.href.substring(window.location.protocol.length));
    }
  </script>
  <title>æ±ºæ¸ˆå®Œäº† - ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆäºˆç´„ãƒ•ã‚©ãƒ¼ãƒ </title>
  
  <style>
  /* =============================
    ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ç”¨CSS
  ============================= */
  * {
    box-sizing: border-box !important;
  }
  html {
    width: 100vw !important;
    max-width: 100vw !important;
    overflow-x: hidden !important;
    margin: 0 !important;
    padding: 0 !important;
  }
  body {
    width: 100vw !important;
    max-width: 100vw !important;
    min-height: 100vh !important;
    margin: 0 !important;
    padding: 0 !important;
    font-family: 'Segoe UI', 'Meiryo', sans-serif;
    background: #f7f7f7;
    -webkit-text-size-adjust: 100%;
    overflow-x: hidden !important;
  }
  
  .container {
    max-width: 480px;
    margin: 40px auto;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    padding: 32px 24px;
    text-align: center;
  }
  
  .success-icon {
    font-size: 4em;
    color: #27ae60;
    margin-bottom: 16px;
  }
  
  h1 {
    color: #27ae60;
    font-size: 1.8em;
    margin-bottom: 24px;
  }
  
  .payment-info {
    background: #e8f5e8;
    border: 1px solid #c3e6c3;
    border-radius: 4px;
    padding: 16px;
    margin: 24px 0;
    text-align: left;
  }
  
  .payment-info h3 {
    margin-top: 0;
    color: #2d5016;
    font-size: 1.1em;
  }
  
  .payment-info p {
    margin: 8px 0;
    color: #2d5016;
    font-size: 0.9em;
  }
  
  .processing-message {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 4px;
    padding: 16px;
    margin: 24px 0;
    color: #856404;
  }
  
  .error-message {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    border-radius: 4px;
    padding: 16px;
    margin: 24px 0;
    color: #721c24;
  }
  
  .loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 8px;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .action-buttons {
    margin-top: 32px;
  }
  
  .btn {
    display: inline-block;
    padding: 12px 24px;
    margin: 8px;
    border: none;
    border-radius: 4px;
    text-decoration: none;
    font-size: 1em;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  .btn-primary {
    background: #3498db;
    color: #fff;
  }
  
  .btn-primary:hover {
    background: #2980b9;
  }
  
  .btn-secondary {
    background: #95a5a6;
    color: #fff;
  }
  
  .btn-secondary:hover {
    background: #7f8c8d;
  }
  
  @media (max-width: 600px) {
    .container {
      margin: 20px auto;
      padding: 24px 16px;
      border-radius: 0;
      min-height: calc(100vh - 40px);
    }
    
    h1 {
      font-size: 1.5em;
    }
    
    .btn {
      display: block;
      width: 100%;
      margin: 8px 0;
    }
  }
  </style>
</head>
<body>
  <div class="container">
    <div class="success-icon">âœ…</div>
    <h1>æ±ºæ¸ˆå®Œäº†</h1>
    
    <div id="processing-status" class="processing-message">
      <div class="loading-spinner"></div>
      äºˆç´„æƒ…å ±ã‚’å‡¦ç†ã—ã¦ã„ã¾ã™...
    </div>
    
    <div id="payment-details" class="payment-info" style="display: none;">
      <h3>æ±ºæ¸ˆæƒ…å ±</h3>
      <p><strong>æ±ºæ¸ˆID:</strong> <span id="session-id" style="font-family: monospace; word-break: break-all; font-size: 0.9em;">-</span></p>
      <p><strong>æ±ºæ¸ˆé‡‘é¡:</strong> <span id="payment-amount">-</span></p>
      <p><strong>æ±ºæ¸ˆæ—¥æ™‚:</strong> <span id="payment-date">-</span></p>
    </div>
    
    <div id="reservation-details" class="payment-info" style="display: none;">
      <h3>äºˆç´„æƒ…å ±</h3>
      <p><strong>ãŠåå‰:</strong> <span id="customer-name">-</span></p>
      <p><strong id="store-label">å—å–åº—èˆ—:</strong> <span id="pickup-store">-</span></p>
      <p><strong id="datetime-label">å—å–æ—¥æ™‚:</strong> <span id="pickup-datetime">-</span></p>
      <p><strong>ã”æ³¨æ–‡å†…å®¹:</strong></p>
      <div id="order-items">-</div>
    </div>
    
    <div id="success-message" style="display: none;">
      <p style="color: #27ae60; font-size: 1.1em; margin: 16px 0;">
        âœ… äºˆç´„ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼<br>
        ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’ãŠé€ã‚Šã—ã¾ã—ãŸã®ã§ã€ã”ç¢ºèªãã ã•ã„ã€‚
      </p>
    </div>
    
    <div id="close-instruction" style="display: none; background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%); border: 2px solid #27ae60; border-radius: 8px; padding: 20px; margin: 24px 0; box-shadow: 0 4px 12px rgba(39, 174, 96, 0.15);">
      <h4 style="margin: 0 0 16px 0; color: #27ae60; font-size: 1.2em; text-align: center; font-weight: bold;">ğŸ‰ äºˆç´„å®Œäº†ï¼</h4>
      <p style="margin: 0 0 20px 0; color: #2d5016; font-weight: bold; font-size: 1.1em; text-align: center; background: #fff; padding: 12px; border-radius: 6px; border: 1px solid #c3e6c3;">
        âœ… äºˆç´„å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ<br>
        <span style="color: #27ae60; font-size: 1.3em;">ã“ã®ç”»é¢ã‚’é–‰ã˜ã¦ãã ã•ã„</span>
      </p>
      <div style="text-align: left; background: #fff; padding: 16px; border-radius: 6px; border: 1px solid #c3e6c3;">
        <p style="margin: 8px 0; font-weight: bold; color: #2d5016; font-size: 1em;">ğŸ“± ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã®å ´åˆï¼š</p>
        <ul style="margin: 4px 0 16px 20px; padding: 0; color: #2d5016;">
          <li style="margin: 4px 0;">ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¿ãƒ–ä¸€è¦§ã‹ã‚‰è©²å½“ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹</li>
          <li style="margin: 4px 0;">ãƒ–ãƒ©ã‚¦ã‚¶ã‚¢ãƒ—ãƒªã‚’çµ‚äº†ã™ã‚‹</li>
        </ul>
        <p style="margin: 8px 0; font-weight: bold; color: #2d5016; font-size: 1em;">ğŸ’» ãƒ‘ã‚½ã‚³ãƒ³ã®å ´åˆï¼š</p>
        <ul style="margin: 4px 0 8px 20px; padding: 0; color: #2d5016;">
          <li style="margin: 4px 0;">ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¿ãƒ–ã®ã€ŒÃ—ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
          <li style="margin: 4px 0;">ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ã€ŒCtrl + Wã€ï¼ˆWindowsï¼‰ã¾ãŸã¯ã€ŒCmd + Wã€ï¼ˆMacï¼‰</li>
          <li style="margin: 4px 0;">ãƒ–ãƒ©ã‚¦ã‚¶ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ã€ŒÃ—ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
        </ul>
      </div>
    </div>
    
    <div id="error-details" class="error-content" style="display: none;">
      <div class="error-icon">âŒ</div>
      <h2>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h2>
      <p id="error-message-detail">äºˆç´„ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>
      <p>
        æ±ºæ¸ˆID <span id="error-session-id" style="font-family: monospace; word-break: break-all; font-size: 0.9em;">-</span> ã‚’æ§ãˆã¦ã€
        ãŠæ‰‹æ•°ã§ã™ãŒåº—èˆ—ã¾ã§ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
      </p>
      <p style="color: #666; font-size: 0.9em;">
        â€»æ±ºæ¸ˆã¯å®Œäº†ã—ã¦ã„ã¾ã™ã®ã§ã€é‡è¤‡ã—ã¦æ±ºæ¸ˆã‚’è¡Œã‚ãªã„ã§ãã ã•ã„ã€‚
      </p>
    </div>
    
  </div>

  <script>
    // GASã®Webã‚¢ãƒ—ãƒªURLï¼ˆindex.htmlã¨åŒã˜URLï¼‰
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwQi1nQI1jDspUlagORpKHtpj3NBbQ5RNNkkcXqhsE-WM_j_w10CvO0CAPkVZFT5Vxh/exec';
    
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰æ±ºæ¸ˆæƒ…å ±ã‚’å–å¾—
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('session_id');
    
    console.log('æ±ºæ¸ˆå®Œäº†ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿:', { sessionId });
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å‡¦ç†é–‹å§‹
    window.addEventListener('DOMContentLoaded', async function() {
      if (!sessionId) {
        showError('æ±ºæ¸ˆã‚»ãƒƒã‚·ãƒ§ãƒ³IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
        return;
      }
      
      try {
        // session_idã‚’ä½¿ã£ã¦GASã‹ã‚‰æ±ºæ¸ˆãƒ»äºˆç´„æƒ…å ±ã‚’å–å¾—
        const paymentInfo = await getPaymentInfoFromGas(sessionId);
        
        if (!paymentInfo || !paymentInfo.success) {
          throw new Error(paymentInfo ? paymentInfo.error : 'æ±ºæ¸ˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
        console.log('æ±ºæ¸ˆæƒ…å ±å–å¾—:', paymentInfo);
        
        // æ±ºæ¸ˆæƒ…å ±ã‚’è¡¨ç¤º
        displayPaymentInfo(sessionId, paymentInfo.data);
        
        // äºˆç´„æƒ…å ±ã‚’è¡¨ç¤º
        displayReservationInfo(paymentInfo.data);
        
        // GASã«äºˆç´„æƒ…å ±ã‚’é€ä¿¡
        await submitReservationToGas(sessionId, paymentInfo.data);
        
      } catch (error) {
        console.error('äºˆç´„å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        showError('äºˆç´„ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
      }
    });
    
    /**
     * GASã‹ã‚‰æ±ºæ¸ˆæƒ…å ±ã‚’å–å¾—
     */
    async function getPaymentInfoFromGas(sessionId) {
      try {
        console.log('GASã‹ã‚‰æ±ºæ¸ˆæƒ…å ±å–å¾—é–‹å§‹:', sessionId);
        
        // JSONPæ–¹å¼ã§GASã‹ã‚‰æƒ…å ±ã‚’å–å¾—
        const result = await fetchFromGasViaJsonp('getPaymentInfo', { sessionId });
        
        console.log('æ±ºæ¸ˆæƒ…å ±å–å¾—çµæœ:', result);
        return result;
        
      } catch (error) {
        console.error('æ±ºæ¸ˆæƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        return { success: false, error: error.message };
      }
    }
    
    /**
     * æ±ç”¨JSONPæ–¹å¼ã§GASã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
     */
    async function fetchFromGasViaJsonp(action, data) {
      return new Promise((resolve, reject) => {
        try {
          const callbackName = 'gasCallback' + Date.now();
          
          // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å®šç¾©
          window[callbackName] = function(result) {
            console.log('GASå¿œç­”å—ä¿¡:', result);
            
            try {
              if (typeof result === 'string') {
                result = JSON.parse(result);
              }
              resolve(result);
            } catch (error) {
              reject(new Error('å¿œç­”ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ'));
            } finally {
              cleanup();
            }
          };
          
          // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°
          const cleanup = () => {
            const script = document.querySelector(`script[data-callback="${callbackName}"]`);
            if (script && script.parentNode) {
              script.parentNode.removeChild(script);
            }
            if (window[callbackName]) {
              delete window[callbackName];
            }
          };
          
          // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
          const jsonString = JSON.stringify(data);
          const encodedData = btoa(encodeURIComponent(jsonString));
          
          // JSONPãƒªã‚¯ã‚¨ã‚¹ãƒˆURLä½œæˆ
          const jsonpUrl = `${GAS_WEB_APP_URL}?action=${action}&data=${encodedData}&callback=${callbackName}&_t=${Date.now()}`;
          
          console.log(`${action} JSONP URL:`, jsonpUrl.substring(0, 200) + '...');
          
          // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’ä½œæˆ
          const script = document.createElement('script');
          script.src = jsonpUrl;
          script.setAttribute('data-callback', callbackName);
          
          script.onerror = function(error) {
            console.error(`${action} JSONPèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:`, error);
            cleanup();
            reject(new Error('ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ'));
          };
          
          document.head.appendChild(script);
          
          // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ15ç§’ï¼‰
          setTimeout(() => {
            if (window[callbackName]) {
              cleanup();
              reject(new Error(`${action}ã®é€šä¿¡ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ`));
            }
          }, 15000);
          
        } catch (error) {
          reject(error);
        }
      });
    }
    
    /**
     * æ±ºæ¸ˆæƒ…å ±ã‚’è¡¨ç¤º
     */
    function displayPaymentInfo(sessionId, paymentData) {
      console.log('=== æ±ºæ¸ˆæƒ…å ±è¡¨ç¤ºãƒ‡ãƒãƒƒã‚° ===');
      console.log('sessionId:', sessionId);
      console.log('paymentData:', paymentData);
      console.log('paymentData.total_amount:', paymentData.total_amount);
      console.log('paymentData.metadata:', paymentData.metadata);
      
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’çŸ­ç¸®ç‰ˆã§è¡¨ç¤º
      const shortSessionId = sessionId.length > 20 ? sessionId.substring(sessionId.length - 16) : sessionId;
      document.getElementById('session-id').textContent = shortSessionId;
      
      // åˆè¨ˆé‡‘é¡ã‚’è¡¨ç¤ºï¼ˆè¤‡æ•°ã®ã‚½ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ã‚’è©¦è¡Œï¼‰
      let totalAmount = 0;
      let amountSource = 'unknown';
      
      // 1. paymentData.total_amountã‹ã‚‰å–å¾—
      if (paymentData.total_amount && paymentData.total_amount !== 'unknown') {
        totalAmount = parseInt(paymentData.total_amount);
        amountSource = 'paymentData.total_amount';
        console.log('é‡‘é¡ã‚½ãƒ¼ã‚¹1 (paymentData.total_amount):', totalAmount);
        console.log('å…ƒã®æ–‡å­—åˆ—å€¤:', paymentData.total_amount);
      }
      // 2. metadataã‹ã‚‰å–å¾—
      else if (paymentData.metadata && paymentData.metadata.total_amount) {
        totalAmount = parseInt(paymentData.metadata.total_amount);
        amountSource = 'metadata.total_amount';
        console.log('é‡‘é¡ã‚½ãƒ¼ã‚¹2 (metadata.total_amount):', totalAmount);
      }
      // 3. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—
      else {
        const urlParams = new URLSearchParams(window.location.search);
        const dataParam = urlParams.get('data');
        console.log('URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿data:', dataParam);
        
        if (dataParam) {
          try {
            const reservationData = JSON.parse(decodeURIComponent(atob(dataParam)));
            console.log('URLã‹ã‚‰å¾©å…ƒã—ãŸäºˆç´„ãƒ‡ãƒ¼ã‚¿:', reservationData);
            
            if (reservationData.items) {
              totalAmount = reservationData.items.reduce((sum, item) => {
                const itemTotal = parseInt(item.price) * parseInt(item.qty);
                console.log(`å•†å“è¨ˆç®—: ${item.name} - ${item.price}å†† Ã— ${item.qty}å€‹ = ${itemTotal}å††`);
                return sum + itemTotal;
              }, 0);
              amountSource = 'URL_parameter_calculation';
              console.log('é‡‘é¡ã‚½ãƒ¼ã‚¹3 (URLè¨ˆç®—):', totalAmount);
            }
          } catch (error) {
            console.warn('URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ã®é‡‘é¡å–å¾—å¤±æ•—:', error);
          }
        }
      }
      
      console.log('æœ€çµ‚æ±ºå®šé‡‘é¡:', totalAmount, 'ã‚½ãƒ¼ã‚¹:', amountSource);
      console.log('=== ãƒ‡ãƒãƒƒã‚°æƒ…å ±çµ‚äº† ===');
      
      if (totalAmount > 0) {
        document.getElementById('payment-amount').textContent = totalAmount.toLocaleString() + 'å††';
      } else {
        document.getElementById('payment-amount').textContent = 'é‡‘é¡æƒ…å ±å–å¾—ä¸­...';
      }
      
      document.getElementById('payment-date').textContent = new Date().toLocaleString('ja-JP');
      document.getElementById('payment-details').style.display = 'block';
    }
    
    /**
     * äºˆç´„æƒ…å ±ã‚’è¡¨ç¤º
     */
    function displayReservationInfo(paymentData) {
      const metadata = paymentData.metadata || paymentData;
      
      document.getElementById('customer-name').textContent = metadata.customer_name || '-';
      
      // é…é€äºˆç´„ã®å ´åˆã¯ã€Œå®…é…ä¾¿ã€ã¨è¡¨ç¤º
      const isDelivery = metadata.delivery_method === 'delivery';
      const storeDisplay = isDelivery ? 'å®…é…ä¾¿' : (metadata.pickup_store || '-');
      document.getElementById('pickup-store').textContent = storeDisplay;
      
      // ãƒ©ãƒ™ãƒ«ã®è¡¨ç¤ºã‚‚é…é€/å—å–ã§åˆ†å²
      document.getElementById('store-label').textContent = isDelivery ? 'é…é€æ–¹æ³•:' : 'å—å–åº—èˆ—:';
      document.getElementById('datetime-label').textContent = isDelivery ? 'é…é€æ—¥æ™‚:' : 'å—å–æ—¥æ™‚:';
      
      // æ—¥æ™‚ã®è¡¨ç¤ºã‚‚é…é€/å—å–ã§åˆ†å²
      const dateTimeDisplay = isDelivery 
        ? `${metadata.delivery_date || '-'} ${metadata.delivery_time_slot || '-'}`
        : `${metadata.pickup_date || '-'} ${metadata.pickup_time || '-'}`;
      document.getElementById('pickup-datetime').textContent = dateTimeDisplay;
      
      // æ³¨æ–‡å•†å“ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
      const itemsContainer = document.getElementById('order-items');
      itemsContainer.innerHTML = '';
      
      try {
        const orderItems = metadata.order_items ? JSON.parse(metadata.order_items) : [];
        
        if (orderItems.length > 0) {
          orderItems.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.style.cssText = 'margin: 4px 0; padding: 4px 0; border-bottom: 1px dotted #ccc;';
            itemDiv.innerHTML = `
              <span style="font-weight: bold;">${item.name}</span> Ã— ${item.qty}å€‹
              <span style="float: right;">${(item.price * item.qty).toLocaleString()}å††</span>
            `;
            itemsContainer.appendChild(itemDiv);
          });
        } else {
          itemsContainer.innerHTML = '<div>æ³¨æ–‡æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</div>';
        }
      } catch (error) {
        console.error('å•†å“æƒ…å ±ã®è§£æã‚¨ãƒ©ãƒ¼:', error);
        itemsContainer.innerHTML = '<div>æ³¨æ–‡æƒ…å ±ã®è¡¨ç¤ºã‚¨ãƒ©ãƒ¼</div>';
      }
      
      document.getElementById('reservation-details').style.display = 'block';
    }
    
    /**
     * GASã«äºˆç´„æƒ…å ±ã‚’é€ä¿¡
     */
    async function submitReservationToGas(sessionId, paymentData) {
      try {
        console.log('GASã«äºˆç´„æƒ…å ±é€ä¿¡é–‹å§‹');
        
        const metadata = paymentData.metadata || paymentData;
        
        // metadataã‹ã‚‰å•†å“æƒ…å ±ã‚’å¾©å…ƒ
        let items = [];
        try {
          items = metadata.order_items ? JSON.parse(metadata.order_items) : [];
        } catch (error) {
          console.error('å•†å“æƒ…å ±ã®è§£æã‚¨ãƒ©ãƒ¼:', error);
          items = [];
        }
        
        // æ±ºæ¸ˆæ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ ï¼ˆdeliveryMethodã‚„é…é€é …ç›®ã‚’ã‚µãƒ¼ãƒã¸ä¼æ¬ï¼‰
        const reservationData = {
          name: metadata.customer_name,
          phone: metadata.customer_phone,
          email: metadata.customer_email,
          store: metadata.pickup_store,
          pickup_date: metadata.pickup_date,
          pickup_time: metadata.pickup_time,
          note: metadata.pickup_note || '',
          deliveryMethod: metadata.delivery_method || 'pickup',
          // é…é€ç³»ï¼ˆmetadataã«å«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã‚’åæ˜ ï¼‰
          deliveryDate: metadata.delivery_date || '',
          deliveryTimeSlot: metadata.delivery_time_slot || '',
          noshiOption: metadata.noshi_option || metadata.noshiOption || 'ãªã—',
          applicationStore: metadata.application_store || metadata.pickup_store || '',
          ordererAddress: metadata.orderer_address ? JSON.parse(metadata.orderer_address) : null,
          deliveryAddress: metadata.delivery_address ? JSON.parse(metadata.delivery_address) : null,
          items: items,
          payment_status: 'completed',
          payment_session_id: sessionId,
          payment_amount: parseInt(metadata.total_amount) || 0,
          payment_date: new Date().toISOString()
        };
        
        console.log('é€ä¿¡ãƒ‡ãƒ¼ã‚¿:', reservationData);
        
        // JSONPæ–¹å¼ã§GASã«é€ä¿¡ï¼ˆindex.htmlã¨åŒã˜æ–¹å¼ï¼‰
        const result = await sendToGasViaJsonp(reservationData);
        
        console.log('GASå¿œç­”:', result);
        
        if (result && result.success) {
          // æˆåŠŸæ™‚ã®è¡¨ç¤º
          document.getElementById('processing-status').style.display = 'none';
          document.getElementById('success-message').style.display = 'block';
          document.getElementById('close-instruction').style.display = 'block';
        } else {
          // å¤±æ•—æ™‚ã®è¡¨ç¤º
          throw new Error(result ? result.error : 'äºˆç´„ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
      } catch (error) {
        console.error('äºˆç´„é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        showError(error.message, sessionId);
      }
    }
    
    /**
     * JSONPæ–¹å¼ã§GASã«ãƒ‡ãƒ¼ã‚¿é€ä¿¡ï¼ˆæ—¢å­˜ã®é–¢æ•°ã‚’ç°¡ç´ åŒ–ï¼‰
     */
    async function sendToGasViaJsonp(data) {
      return await fetchFromGasViaJsonp('submitPaymentReservation', data);
    }
    
    /**
     * ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
     */
    function showError(message, sessionId = null) {
      document.getElementById('processing-status').style.display = 'none';
      document.getElementById('error-message-detail').textContent = message;
      
      if (sessionId) {
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’çŸ­ç¸®ç‰ˆã§è¡¨ç¤º
        const shortSessionId = sessionId.length > 20 ? sessionId.substring(sessionId.length - 16) : sessionId;
        document.getElementById('error-session-id').textContent = shortSessionId;
      }
      
      document.getElementById('error-details').style.display = 'block';
      document.getElementById('close-instruction').style.display = 'block';
    }
  </script>
</body>
</html> 
