<!--
  @file success.html
  @brief Stripe決済完了ページ
  @details 決済完了後に予約情報をGASに送信し、メール通知を実行
-->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta name="format-detection" content="telephone=no">
  <meta name="mobile-web-app-capable" content="yes">
  <!-- セキュリティ強化メタタグ -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <!-- HTTPS リダイレクト強制 -->
  <script>
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      location.replace('https:' + window.location.href.substring(window.location.protocol.length));
    }
  </script>
  <title>決済完了 - テイクアウト予約フォーム</title>
  
  <style>
  /* =============================
    レスポンシブデザイン用CSS
  ============================= */
  * {
    box-sizing: border-box !important;
  }
  html {
    width: 100vw !important;
    max-width: 100vw !important;
    overflow-x: hidden !important;
    margin: 0 !important;
    padding: 0 !important;
  }
  body {
    width: 100vw !important;
    max-width: 100vw !important;
    min-height: 100vh !important;
    margin: 0 !important;
    padding: 0 !important;
    font-family: 'Segoe UI', 'Meiryo', sans-serif;
    background: #f7f7f7;
    -webkit-text-size-adjust: 100%;
    overflow-x: hidden !important;
  }
  
  .container {
    max-width: 480px;
    margin: 40px auto;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    padding: 32px 24px;
    text-align: center;
  }
  
  .success-icon {
    font-size: 4em;
    color: #27ae60;
    margin-bottom: 16px;
  }
  
  h1 {
    color: #27ae60;
    font-size: 1.8em;
    margin-bottom: 24px;
  }
  
  .payment-info {
    background: #e8f5e8;
    border: 1px solid #c3e6c3;
    border-radius: 4px;
    padding: 16px;
    margin: 24px 0;
    text-align: left;
  }
  
  .payment-info h3 {
    margin-top: 0;
    color: #2d5016;
    font-size: 1.1em;
  }
  
  .payment-info p {
    margin: 8px 0;
    color: #2d5016;
    font-size: 0.9em;
  }
  
  .processing-message {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 4px;
    padding: 16px;
    margin: 24px 0;
    color: #856404;
  }
  
  .error-message {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    border-radius: 4px;
    padding: 16px;
    margin: 24px 0;
    color: #721c24;
  }
  
  .loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 8px;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .action-buttons {
    margin-top: 32px;
  }
  
  .btn {
    display: inline-block;
    padding: 12px 24px;
    margin: 8px;
    border: none;
    border-radius: 4px;
    text-decoration: none;
    font-size: 1em;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  .btn-primary {
    background: #3498db;
    color: #fff;
  }
  
  .btn-primary:hover {
    background: #2980b9;
  }
  
  .btn-secondary {
    background: #95a5a6;
    color: #fff;
  }
  
  .btn-secondary:hover {
    background: #7f8c8d;
  }
  
  @media (max-width: 600px) {
    .container {
      margin: 20px auto;
      padding: 24px 16px;
      border-radius: 0;
      min-height: calc(100vh - 40px);
    }
    
    h1 {
      font-size: 1.5em;
    }
    
    .btn {
      display: block;
      width: 100%;
      margin: 8px 0;
    }
  }
  </style>
</head>
<body>
  <div class="container">
    <div class="success-icon">✅</div>
    <h1>決済完了</h1>
    
    <div id="processing-status" class="processing-message">
      <div class="loading-spinner"></div>
      予約情報を処理しています...
    </div>
    
    <div id="payment-details" class="payment-info" style="display: none;">
      <h3>決済情報</h3>
      <p><strong>決済ID:</strong> <span id="session-id">-</span></p>
      <p><strong>決済金額:</strong> <span id="payment-amount">-</span></p>
      <p><strong>決済日時:</strong> <span id="payment-date">-</span></p>
    </div>
    
    <div id="reservation-details" class="payment-info" style="display: none;">
      <h3>予約情報</h3>
      <p><strong>お名前:</strong> <span id="customer-name">-</span></p>
      <p><strong>受取店舗:</strong> <span id="pickup-store">-</span></p>
      <p><strong>受取日時:</strong> <span id="pickup-datetime">-</span></p>
      <p><strong>ご注文内容:</strong></p>
      <div id="order-items">-</div>
    </div>
    
    <div id="success-message" style="display: none;">
      <p style="color: #27ae60; font-size: 1.1em; margin: 16px 0;">
        ✅ 予約が正常に完了しました！<br>
        確認メールをお送りしましたので、ご確認ください。
      </p>
    </div>
    
    <div id="error-details" class="error-message" style="display: none;">
      <h3>⚠️ 予約処理エラー</h3>
      <p>決済は完了しましたが、予約情報の登録でエラーが発生しました。</p>
      <p id="error-message-detail">-</p>
      <p style="margin-top: 16px;">
        <strong>対処方法：</strong><br>
        決済ID <span id="error-session-id">-</span> を控えて、
        直接店舗にお電話でご連絡ください。
      </p>
    </div>
    
    <div class="action-buttons" id="action-buttons" style="display: none;">
      <a href="index.html" class="btn btn-primary">新しい予約をする</a>
      <button onclick="window.close()" class="btn btn-secondary">画面を閉じる</button>
    </div>
  </div>

  <script>
    // GASのWebアプリURL（index.htmlと同じURL）
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwgeG189yH0YGt6gpqpYHoclCnZe4cbo8jARRaHCqjgxpiD_XW47taPqNFlQYDhfaYaCg/exec';
    
    // URLパラメータから決済情報と予約データを取得
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('session_id');
    const reservationData = urlParams.get('data');
    
    console.log('決済完了ページ読み込み:', { sessionId, reservationData });
    
    // ページ読み込み時に処理開始
    window.addEventListener('DOMContentLoaded', async function() {
      if (!sessionId) {
        showError('決済セッションIDが取得できませんでした。');
        return;
      }
      
      if (!reservationData) {
        showError('予約データが取得できませんでした。');
        return;
      }
      
      try {
        // 予約データをデコード
        const decodedData = decodeURIComponent(atob(reservationData));
        const orderData = JSON.parse(decodedData);
        
        console.log('予約データ復元:', orderData);
        
        // 決済情報を表示
        displayPaymentInfo(sessionId, orderData);
        
        // 予約情報を表示
        displayReservationInfo(orderData);
        
        // GASに予約情報を送信
        await submitReservationToGas(sessionId, orderData);
        
      } catch (error) {
        console.error('予約処理エラー:', error);
        showError('予約データの処理中にエラーが発生しました: ' + error.message);
      }
    });
    
    /**
     * 決済情報を表示
     */
    function displayPaymentInfo(sessionId, orderData) {
      document.getElementById('session-id').textContent = sessionId;
      
      // 合計金額を計算（products.jsonは使えないので、orderDataから計算）
      const totalAmount = orderData.items.reduce((sum, item) => {
        return sum + (item.price * item.qty);
      }, 0);
      
      document.getElementById('payment-amount').textContent = totalAmount.toLocaleString() + '円';
      document.getElementById('payment-date').textContent = new Date().toLocaleString('ja-JP');
      document.getElementById('payment-details').style.display = 'block';
    }
    
    /**
     * 予約情報を表示
     */
    function displayReservationInfo(orderData) {
      document.getElementById('customer-name').textContent = orderData.name;
      document.getElementById('pickup-store').textContent = orderData.store;
      document.getElementById('pickup-datetime').textContent = 
        `${orderData.pickup_date} ${orderData.pickup_time}`;
      
      // 注文商品リストを表示
      const itemsContainer = document.getElementById('order-items');
      itemsContainer.innerHTML = '';
      
      orderData.items.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.style.cssText = 'margin: 4px 0; padding: 4px 0; border-bottom: 1px dotted #ccc;';
        itemDiv.innerHTML = `
          <span style="font-weight: bold;">${item.name}</span> × ${item.qty}個
          <span style="float: right;">${(item.price * item.qty).toLocaleString()}円</span>
        `;
        itemsContainer.appendChild(itemDiv);
      });
      
      document.getElementById('reservation-details').style.display = 'block';
    }
    
    /**
     * GASに予約情報を送信
     */
    async function submitReservationToGas(sessionId, orderData) {
      try {
        console.log('GASに予約情報送信開始');
        
        // 決済済みフラグを追加
        const reservationData = {
          ...orderData,
          payment_status: 'completed',
          payment_session_id: sessionId,
          payment_amount: orderData.items.reduce((sum, item) => sum + (item.price * item.qty), 0),
          payment_date: new Date().toISOString()
        };
        
        console.log('送信データ:', reservationData);
        
        // JSONP方式でGASに送信（index.htmlと同じ方式）
        const result = await sendToGasViaJsonp(reservationData);
        
        console.log('GAS応答:', result);
        
        if (result && result.success) {
          // 成功時の表示
          document.getElementById('processing-status').style.display = 'none';
          document.getElementById('success-message').style.display = 'block';
          document.getElementById('action-buttons').style.display = 'block';
        } else {
          // 失敗時の表示
          throw new Error(result ? result.error : '予約登録に失敗しました');
        }
        
      } catch (error) {
        console.error('予約送信エラー:', error);
        showError(error.message, sessionId);
      }
    }
    
    /**
     * JSONP方式でGASにデータ送信
     */
    async function sendToGasViaJsonp(data) {
      return new Promise((resolve, reject) => {
        try {
          const callbackName = 'paymentCallback' + Date.now();
          
          // グローバルコールバック関数を定義
          window[callbackName] = function(result) {
            console.log('GAS応答受信:', result);
            
            try {
              if (typeof result === 'string') {
                result = JSON.parse(result);
              }
              resolve(result);
            } catch (error) {
              reject(new Error('応答の解析に失敗しました'));
            } finally {
              // クリーンアップ
              cleanup();
            }
          };
          
          // クリーンアップ関数
          const cleanup = () => {
            const script = document.querySelector(`script[data-callback="${callbackName}"]`);
            if (script && script.parentNode) {
              script.parentNode.removeChild(script);
            }
            if (window[callbackName]) {
              delete window[callbackName];
            }
          };
          
          // データをエンコード
          const jsonString = JSON.stringify(data);
          const encodedData = btoa(encodeURIComponent(jsonString));
          
          // JSONPリクエストURL作成
          const jsonpUrl = `${GAS_WEB_APP_URL}?action=submitPaymentReservation&data=${encodedData}&callback=${callbackName}&_t=${Date.now()}`;
          
          console.log('JSONP URL:', jsonpUrl.substring(0, 200) + '...');
          
          // スクリプトタグを作成
          const script = document.createElement('script');
          script.src = jsonpUrl;
          script.setAttribute('data-callback', callbackName);
          
          script.onerror = function(error) {
            console.error('JSONP読み込みエラー:', error);
            cleanup();
            reject(new Error('サーバーとの通信に失敗しました'));
          };
          
          document.head.appendChild(script);
          
          // タイムアウト設定（15秒）
          setTimeout(() => {
            if (window[callbackName]) {
              cleanup();
              reject(new Error('サーバーとの通信がタイムアウトしました'));
            }
          }, 15000);
          
        } catch (error) {
          reject(error);
        }
      });
    }
    
    /**
     * エラー表示
     */
    function showError(message, sessionId = null) {
      document.getElementById('processing-status').style.display = 'none';
      document.getElementById('error-message-detail').textContent = message;
      
      if (sessionId) {
        document.getElementById('error-session-id').textContent = sessionId;
      }
      
      document.getElementById('error-details').style.display = 'block';
      document.getElementById('action-buttons').style.display = 'block';
    }
  </script>
</body>
</html> 