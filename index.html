<!--
  @file index.html
  @brief GitHub Pagesç”¨ ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆäºˆç´„ãƒ•ã‚©ãƒ¼ãƒ 
  @details GASã®doPost APIã¨é€£æºã—ã¦GoogleãƒãƒŠãƒ¼ã‚’è¡¨ç¤ºã›ãšã«äºˆç´„æ©Ÿèƒ½ã‚’æä¾›
-->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta name="format-detection" content="telephone=no">
  <meta name="mobile-web-app-capable" content="yes">
  <title>ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆäºˆç´„ãƒ•ã‚©ãƒ¼ãƒ </title>
  
  <!-- reCAPTCHA v3ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script src="https://www.google.com/recaptcha/api.js?render=6Le2lk4rAAAAAJu2ojJxoexvlUILZn4oNyJvuHzd" async defer></script>
  
  <style>
  /* =============================
    ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ç”¨CSS
  ============================= */
  * {
    box-sizing: border-box !important;
  }
  html {
    width: 100vw !important;
    max-width: 100vw !important;
    overflow-x: hidden !important;
    margin: 0 !important;
    padding: 0 !important;
  }
  body {
    width: 100vw !important;
    max-width: 100vw !important;
    min-height: 100vh !important;
    margin: 0 !important;
    padding: 0 !important;
    font-family: 'Segoe UI', 'Meiryo', sans-serif;
    background: #f7f7f7;
    -webkit-text-size-adjust: 100%;
    overflow-x: hidden !important;
  }
  @media (max-width: 600px) {
    html, body {
      width: 100vw !important;
      max-width: 100vw !important;
      min-width: 100vw !important;
      height: 100% !important;
      min-height: 100vh !important;
      margin: 0 !important;
      padding: 0 !important;
      background: #fff !important;
      font-size: 16px !important;
      overflow-x: hidden !important;
    }
    .container {
      width: 100vw !important;
      max-width: 100vw !important;
      min-width: 100vw !important;
      margin: 0 !important;
      padding: 12px 6px !important;
      border-radius: 0 !important;
      box-shadow: none !important;
    }
    h1 {
      font-size: 1.6em !important;
      margin: 0 0 20px 0 !important;
      padding: 0 !important;
      text-align: center !important;
    }
    input, select, textarea {
      width: 100% !important;
      max-width: 100% !important;
      font-size: 16px !important;
      height: auto !important;
      padding: 12px 8px !important;
      margin-top: 6px !important;
      border: 1px solid #ccc !important;
      border-radius: 4px !important;
    }
    input[type="date"] {
      min-height: 44px !important;
    }
    button {
      width: 100% !important;
      max-width: 100% !important;
      padding: 14px !important;
      font-size: 1.2em !important;
      min-height: 50px !important;
    }
    .product-item {
      display: flex !important;
      flex-direction: column !important;
      align-items: stretch !important;
      margin-bottom: 16px !important;
      width: 100% !important;
      max-width: 100% !important;
    }
    .product-item select {
      width: 100% !important;
      max-width: 100% !important;
      margin-right: 0 !important;
      margin-bottom: 8px !important;
    }
    .product-item input[type="number"] {
      width: 100px !important;
      max-width: 100px !important;
      height: 44px !important;
      margin-right: 8px !important;
      margin-bottom: 8px !important;
    }
    .remove-product-btn {
      width: auto !important;
      max-width: 150px !important;
      padding: 8px 12px !important;
      height: 44px !important;
      align-self: flex-end !important;
    }
    .add-product-btn {
      width: 100% !important;
      max-width: 100% !important;
      padding: 12px !important;
      margin-top: 12px !important;
    }
    form div {
      margin-top: 20px !important;
      width: 100% !important;
      max-width: 100% !important;
    }
    form label {
      font-size: 1.1em !important;
      display: block !important;
      width: 100% !important;
    }
    .product-desc {
      width: 100% !important;
      max-width: 100% !important;
      margin-top: 8px !important;
      margin-left: 0 !important;
      word-wrap: break-word !important;
    }
    #custom-modal > div {
      width: 90vw !important;
      max-width: 90vw !important;
      padding: 20px 12px !important;
      margin: 0 auto !important;
    }
    .consent-checkbox input[type="checkbox"] {
      margin-top: 0;
    }
  }
  .container {
    max-width: 480px;
    margin: 40px auto;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    padding: 24px 16px;
  }
  h1 {
    text-align: center;
    font-size: 1.5em;
    margin-bottom: 24px;
  }
  form div {
    margin-top: 16px;
  }
  form label {
    display: block;
    font-weight: bold;
    margin-bottom: 4px;
  }
  input, select, textarea {
    width: 100%;
    padding: 8px;
    margin-top: 4px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 1em;
    box-sizing: border-box;
  }
  input:invalid, select:invalid, textarea:invalid {
    border-color: #e74c3c;
  }
  .error-message {
    color: #e74c3c;
    font-size: 0.95em;
    margin-top: 2px;
    display: block;
  }
  .required {
    color: #e74c3c;
    font-size: 0.95em;
    margin-left: 4px;
  }
  button {
    margin-top: 24px;
    width: 100%;
    padding: 12px;
    background: #2ecc71;
    color: #fff;
    border: none;
    border-radius: 4px;
    font-size: 1.1em;
    cursor: pointer;
    transition: background 0.2s;
  }
  button:disabled {
    background: #aaa;
    cursor: not-allowed;
  }
  .success-message {
    color: #27ae60;
    text-align: center;
    margin-top: 24px;
    font-size: 1.1em;
  }
  /* å•†å“ãƒªã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .product-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
  }
  .product-item select {
    flex-grow: 1; /* é¸æŠè‚¢ã‚’åºƒã’ã‚‹ */
    margin-right: 8px;
  }
  .product-item input[type="number"] {
    width: 60px; /* æ•°é‡å…¥åŠ›æ¬„ã®å¹… */
    margin-right: 8px;
  }
  .remove-product-btn {
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    padding: 4px 8px;
    font-size: 0.9em;
  }
  .add-product-btn {
    margin-top: 8px;
    padding: 8px 12px;
    background: #3498db; /* é’ç³»ã®è‰² */
    color: #fff;
    border: none;
    border-radius: 4px;
    font-size: 1em;
    cursor: pointer;
  }
  /* å•†å“èª¬æ˜ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .product-desc {
    font-size: 0.9em;
    color: #666;
    margin-top: 4px;
    margin-left: 8px;
  }
  /* ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  #custom-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
  }
  #custom-modal > div {
    background: #fff;
    padding: 32px 24px;
    border-radius: 8px;
    text-align: center;
    max-width: 400px;
    width: 80%;
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
  }
  #custom-modal h2 {
    margin-top: 0;
    color: #27ae60;
  }
  #custom-modal button {
    margin-top: 16px;
    padding: 12px 24px;
    background: #3498db;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1em;
  }
  #final-message {
    display: none;
    text-align: center;
    font-size: 1.2em;
    color: #27ae60;
    margin-top: 40px;
  }
  
  /* ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼é–¢é€£ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .privacy-section {
    margin-top: 20px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 4px;
    border-left: 4px solid #3498db;
  }
  
  .privacy-toggle {
    background: none;
    border: none;
    color: #3498db;
    text-decoration: underline;
    cursor: pointer;
    font-size: 0.9em;
    padding: 0;
    margin-left: 4px;
  }
  
  .privacy-toggle:hover {
    color: #2980b9;
  }
  
  .privacy-content {
    display: none;
    margin-top: 10px;
    padding: 10px;
    background: #fff;
    border-radius: 4px;
    font-size: 0.85em;
    line-height: 1.4;
    border: 1px solid #e0e0e0;
    max-height: 200px;
    overflow-y: auto;
  }
  
  .privacy-content h3 {
    margin-top: 0;
    margin-bottom: 8px;
    font-size: 1em;
    color: #333;
  }
  
  .consent-checkbox {
    margin-top: 12px;
    display: flex;
    align-items: flex-start;
    gap: 8px;
  }
  
  .consent-checkbox input[type="checkbox"] {
    width: auto;
    margin: 0;
    flex-shrink: 0;
    margin-top: 2px;
  }
  
  .consent-checkbox label {
    font-size: 0.9em;
    margin: 0;
    cursor: pointer;
    line-height: 1.3;
  }
  
  /* ãƒ¬ãƒ¼ãƒˆåˆ¶é™è­¦å‘Š */
  .rate-limit-warning {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 4px;
    padding: 12px;
    margin-top: 16px;
    color: #856404;
    font-size: 0.9em;
    display: none;
  }
  
  /* ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é€šçŸ¥ */
  .security-notice {
    background: #e8f5e8;
    border: 1px solid #c3e6c3;
    border-radius: 4px;
    padding: 8px 12px;
    margin-top: 8px;
    color: #2d5016;
    font-size: 0.85em;
    text-align: center;
  }
  
  @media (max-width: 600px) {
    .privacy-content {
      font-size: 0.8em;
      max-height: 150px;
    }
    
    .consent-checkbox {
      flex-direction: column;
      gap: 4px;
    }
    
    .consent-checkbox input[type="checkbox"] {
      margin-top: 0;
    }
  }
  </style>
</head>
<body>
  <div class="container">
    <h1>ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆäºˆç´„ãƒ•ã‚©ãƒ¼ãƒ </h1>
    
    <form id="reserveForm">
      <div>
        <label for="name">ãŠåå‰<span class="required">*</span></label>
        <input type="text" id="name" name="name" required>
        <span class="error-message" id="name-error"></span>
      </div>
      
      <div>
        <label for="phone">é›»è©±ç•ªå·<span class="required">*</span></label>
        <input type="tel" id="phone" name="phone" required>
        <span class="error-message" id="phone-error"></span>
      </div>
      
      <div>
        <label for="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹<span class="required">*</span></label>
        <input type="email" id="email" name="email" required>
        <span class="error-message" id="email-error"></span>
      </div>
      
      <div>
        <label for="store">å—å–åº—èˆ—<span class="required">*</span></label>
        <select id="store" name="store" required>
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
        <span class="error-message" id="store-error"></span>
      </div>
      
      <div>
        <label>å•†å“ãƒ»æ•°é‡<span class="required">*</span></label>
        <div id="product-list-area">
          <!-- å•†å“é¸æŠé …ç›®ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
        </div>
        <button type="button" class="add-product-btn" onclick="addProductItem()">å•†å“ã‚’è¿½åŠ </button>
        <span class="error-message" id="items-error"></span>
        <div id="product-date-note" style="font-size: 0.9em; color: #666; margin-top: 8px;">å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
      </div>
      
      <div>
        <label for="pickup_date">å—å–å¸Œæœ›æ—¥<span class="required">*</span></label>
        <input type="date" id="pickup_date" name="pickup_date" required disabled>
        <span class="error-message" id="pickup_date-error"></span>
      </div>
      
      <div>
        <label for="pickup_time">å—å–å¸Œæœ›æ™‚é–“<span class="required">*</span></label>
        <select id="pickup_time" name="pickup_time" required disabled>
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="10:00">10:00</option>
          <option value="10:30">10:30</option>
          <option value="11:00">11:00</option>
          <option value="11:30">11:30</option>
          <option value="12:00">12:00</option>
          <option value="12:30">12:30</option>
          <option value="13:00">13:00</option>
          <option value="13:30">13:30</option>
          <option value="14:00">14:00</option>
          <option value="14:30">14:30</option>
          <option value="15:00">15:00</option>
          <option value="15:30">15:30</option>
          <option value="16:00">16:00</option>
          <option value="16:30">16:30</option>
          <option value="17:00">17:00</option>
          <option value="17:30">17:30</option>
          <option value="18:00">18:00</option>
          <option value="18:30">18:30</option>
          <option value="19:00">19:00</option>
          <option value="19:30">19:30</option>
          <option value="20:00">20:00</option>
        </select>
        <span class="error-message" id="pickup_time-error"></span>
      </div>
      
      <div>
        <label for="note">å‚™è€ƒ</label>
        <textarea id="note" name="note" rows="3" placeholder="ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã‚„ã”è¦æœ›ãªã©ãŒã‚ã‚Œã°ã”è¨˜å…¥ãã ã•ã„"></textarea>
      </div>
      
      <!-- ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="privacy-section">
        <div>
          <strong>å€‹äººæƒ…å ±ã®å–ã‚Šæ‰±ã„ã«ã¤ã„ã¦</strong>
          <button type="button" class="privacy-toggle" onclick="togglePrivacyPolicy()">è©³ç´°ã‚’è¡¨ç¤º</button>
        </div>
        
        <div id="privacy-content" class="privacy-content">
          <h3>å€‹äººæƒ…å ±ä¿è­·æ–¹é‡</h3>
          <p><strong>1. åé›†ã™ã‚‹å€‹äººæƒ…å ±</strong><br>
          ãŠåå‰ã€é›»è©±ç•ªå·ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ã”æ³¨æ–‡å†…å®¹ã€å—å–å¸Œæœ›æ—¥æ™‚</p>
          
          <p><strong>2. åˆ©ç”¨ç›®çš„</strong><br>
          ãƒ»ã”æ³¨æ–‡ã®ç¢ºèªãƒ»å•†å“ã®æº–å‚™<br>
          ãƒ»å—å–æ—¥æ™‚ã®èª¿æ•´ãƒ»é€£çµ¡<br>
          ãƒ»ã‚µãƒ¼ãƒ“ã‚¹å‘ä¸Šã®ãŸã‚ã®çµ±è¨ˆåˆ†æ</p>
          
          <p><strong>3. ç¬¬ä¸‰è€…æä¾›</strong><br>
          ãŠå®¢æ§˜ã®å€‹äººæƒ…å ±ã‚’ç¬¬ä¸‰è€…ã«æä¾›ã™ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆæ³•ä»¤ã«åŸºã¥ãå ´åˆã‚’é™¤ãï¼‰</p>
          
          <p><strong>4. ä¿ç®¡æœŸé–“</strong><br>
          ã‚µãƒ¼ãƒ“ã‚¹æä¾›ã«å¿…è¦ãªæœŸé–“ä¿ç®¡ã—ã€ãã®å¾Œé©åˆ‡ã«å‰Šé™¤ã„ãŸã—ã¾ã™</p>
          
          <p><strong>5. ãŠå•ã„åˆã‚ã›</strong><br>
          å€‹äººæƒ…å ±ã«é–¢ã™ã‚‹ãŠå•ã„åˆã‚ã›ã¯åº—èˆ—ã¾ã§ã”é€£çµ¡ãã ã•ã„</p>
        </div>
        
        <div class="consent-checkbox">
          <input type="checkbox" id="privacy-consent" name="privacy-consent" required>
          <label for="privacy-consent">ä¸Šè¨˜ã®å€‹äººæƒ…å ±ä¿è­·æ–¹é‡ã‚’ç¢ºèªã—ã€å€‹äººæƒ…å ±ã®å–ã‚Šæ‰±ã„ã«åŒæ„ã—ã¾ã™<span class="required">*</span></label>
        </div>
        <span class="error-message" id="privacy-consent-error"></span>
      </div>
      
      <!-- reCAPTCHA v3ã¯èƒŒæ™¯ã§å‹•ä½œã™ã‚‹ãŸã‚è¡¨ç¤ºè¦ç´ ã¯ä¸è¦ -->
      
      <!-- ãƒ¬ãƒ¼ãƒˆåˆ¶é™è­¦å‘Š -->
      <div id="rate-limit-warning" class="rate-limit-warning">
        <strong>âš ï¸ æ³¨æ„:</strong> çŸ­æ™‚é–“å†…ã®é€£ç¶šé€ä¿¡ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ç½®ã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚
      </div>
      
      <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é€šçŸ¥ -->
      <div class="security-notice">
        ğŸ”’ ãŠå®¢æ§˜ã®æƒ…å ±ã¯æš—å·åŒ–ã—ã¦å®‰å…¨ã«é€ä¿¡ã•ã‚Œã¾ã™
      </div>
      
      <button type="submit" id="submit-btn">äºˆç´„ã™ã‚‹</button>
    </form>
    
    <div id="result"></div>
    <div id="close-btn-area"></div>
  </div>

  <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="custom-modal">
    <div>
      <h2>äºˆç´„å®Œäº†</h2>
      <div id="modal-message"></div>
      <button id="modal-close-btn">ç”»é¢ã‚’é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
  <div id="final-message"></div>

  <script>
    // GASã®Webã‚¢ãƒ—ãƒªURLï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«å®Ÿéš›ã®URLã«å¤‰æ›´ã—ã¦ãã ã•ã„ï¼‰
    // âš ï¸ é‡è¦: æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ä½œæˆã—ãŸå ´åˆã¯ã€ä»¥ä¸‹ã®URLã‚’æ›´æ–°ã—ã¦ãã ã•ã„
    // æ‰‹é †: GAS â†’ ãƒ‡ãƒ—ãƒ­ã‚¤ â†’ æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ â†’ ç”Ÿæˆã•ã‚ŒãŸURLã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘
    // 
    // ğŸ”¥ ç·Šæ€¥ä¿®æ­£å¿…è¦: ç¾åœ¨ã®URLã¯å¤ã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
    // Code.gsã‚’ä¿®æ­£ã—ãŸãŸã‚ã€æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…è¦ã§ã™
    // ç¾åœ¨ã®URLï¼ˆæ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«æ›´æ–°ã—ã¦ãã ã•ã„ï¼‰:
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwgeG189yH0YGt6gpqpYHoclCnZe4cbo8jARRaHCqjgxpiD_XW47taPqNFlQYDhfaYaCg/exec';
    
    // å•†å“ãƒ»åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹å¤‰æ•°
    let allProducts = [];
    let allStores = [];

    // å•†å“é¸æŠæ¬„ã®selectã¨æ•°é‡inputã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    function attachProductSelectListener() {
      document.querySelectorAll('.product-item select').forEach(select => {
        select.addEventListener('change', updatePickupDateControl);
      });
      document.querySelectorAll('.product-item input[type="number"]').forEach(input => {
        input.addEventListener('input', updatePickupDateControl);
      });
    }
    
    // å•†å“é …ç›®è¿½åŠ æ™‚ã«ã‚‚ãƒªã‚¹ãƒŠãƒ¼ã‚’ä»˜ä¸
    const origAddProductItem = addProductItem;
    addProductItem = function() {
      origAddProductItem();
      attachProductSelectListener();
      updatePickupDateControl();
    };
    
    // çµ±åˆã•ã‚ŒãŸåˆæœŸåŒ–å‡¦ç†
    window.addEventListener('DOMContentLoaded', function() {
      // å•†å“ãƒ»åº—èˆ—ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã¨åˆæœŸåŒ–
      loadProductsAndStores();
      addProductItem(); // åˆæœŸå•†å“é …ç›®ã‚’è¿½åŠ 
      
      // åº—èˆ—é¸æŠã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      document.getElementById('store').addEventListener('change', function() {
        updatePickupDateControl(); // æ—¥ä»˜åˆ¶å¾¡ã‚’æ›´æ–°
        updatePickupTimeOptions(); // æ™‚é–“é¸æŠã‚’æ›´æ–°
      });
      
      // å—å–æ—¥é¸æŠã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆvalidatePickupDateã‚’ä½¿ç”¨ï¼‰
      document.getElementById('pickup_date').addEventListener('change', validatePickupDate);
      
      // å•†å“é¸æŠã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      attachProductSelectListener();
      updatePickupDateControl();
      
      // GASæ¥ç¶šãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
      setTimeout(async () => {
        console.log('GASæ¥ç¶šãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™...');
        const testResult = await testGasConnection();
        
        if (!testResult.success) {
          console.error('GASæ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—:', testResult.error);
          
          // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
          const errorDiv = document.createElement('div');
          errorDiv.style.cssText = `
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 12px;
            margin: 16px 0;
            color: #856404;
            font-size: 0.9em;
          `;
          errorDiv.innerHTML = `
            <strong>âš ï¸ æ¥ç¶šè­¦å‘Š:</strong> ã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚<br>
            ã‚¨ãƒ©ãƒ¼: ${testResult.error}<br>
            äºˆç´„é€ä¿¡æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚<br>
            <small>â€»ç®¡ç†è€…ã®æ–¹: GASã®æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…è¦ãªå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™</small>
          `;
          
          document.querySelector('.container').insertBefore(errorDiv, document.getElementById('reserveForm'));
        } else {
          console.log('GASæ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ:', testResult.result);
          
          // æˆåŠŸæ™‚ã‚‚æƒ…å ±è¡¨ç¤ºï¼ˆé–‹ç™ºç”¨ï¼‰
          if (testResult.result && testResult.result.message) {
            console.log('âœ… ' + testResult.result.message);
            console.log('ğŸ“Š ã‚µãƒ¼ãƒãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', testResult.result.status);
            
            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯éè¡¨ç¤ºã«ã™ã‚‹ï¼‰
            const debugDiv = document.createElement('div');
            debugDiv.style.cssText = `
              background: #e8f5e8;
              border: 1px solid #c3e6c3;
              border-radius: 4px;
              padding: 8px 12px;
              margin: 8px 0;
              color: #2d5016;
              font-size: 0.8em;
              text-align: center;
              display: none;
            `;
            debugDiv.innerHTML = `
               âœ… ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šæ­£å¸¸ - ${testResult.result.status}
            `;
            
            // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®ã¿è¡¨ç¤ºï¼ˆURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§debug=1ãŒã‚ã‚‹å ´åˆï¼‰
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('debug') === '1') {
              debugDiv.style.display = 'block';
              document.querySelector('.container').insertBefore(debugDiv, document.getElementById('reserveForm'));
            }
          }
        }
      }, 2000); // 2ç§’å¾…ã£ã¦ã‹ã‚‰ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      
      // å•†å“å‰Šé™¤æ™‚ã«ã‚‚åˆ¶å¾¡ã‚’æ›´æ–°ï¼ˆMutationObserverã‚’ä½¿ç”¨ï¼‰
      const productListArea = document.getElementById('product-list-area');
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'childList' && mutation.removedNodes.length > 0) {
            setTimeout(updatePickupDateControl, 100);
          }
        });
      });
      observer.observe(productListArea, { childList: true });
    });
    
    // å•†å“ãƒ»åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
    async function loadProductsAndStores() {
      try {
        // å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        const productsResponse = await fetch('./products.json');
        allProducts = await productsResponse.json();
        
        // åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        const storesResponse = await fetch('./stores.json');
        allStores = await storesResponse.json();
        
        // åº—èˆ—é¸æŠè‚¢ã‚’è¨­å®š
        const storeSelect = document.getElementById('store');
        allStores.forEach(store => {
          const option = document.createElement('option');
          option.value = store.name;
          option.textContent = store.name;
          storeSelect.appendChild(option);
        });
        
        // å•†å“é¸æŠè‚¢ã‚’æ›´æ–°
        updateProductSelects();
        
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        document.getElementById('result').textContent = 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚';
        document.getElementById('result').style.color = '#e74c3c';
      }
    }

    // å•†å“é¸æŠè‚¢ã‚’æ›´æ–°
    function updateProductSelects() {
      const selects = document.querySelectorAll('.product-item select');
      selects.forEach(select => {
        // ç¾åœ¨ã®é¸æŠå€¤ã‚’ä¿æŒ
        const currentValue = select.value;
        
        // é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢
        select.innerHTML = '<option value="">å•†å“ã‚’é¸æŠ</option>';
        
        // å•†å“ã‚’è¿½åŠ 
        allProducts.forEach(product => {
          const option = document.createElement('option');
          option.value = product.name;
          option.textContent = `${product.name} (${product.price}å††)`;
          select.appendChild(option);
        });
        
        // é¸æŠå€¤ã‚’å¾©å…ƒ
        select.value = currentValue;
      });
    }

    // å•†å“é …ç›®ã‚’è¿½åŠ 
    function addProductItem() {
      const container = document.getElementById('product-list-area');
      const itemDiv = document.createElement('div');
      itemDiv.className = 'product-item';
      
      itemDiv.innerHTML = `
        <select onchange="updateProductDescription(this); updatePickupDateControl();">
          <option value="">å•†å“ã‚’é¸æŠ</option>
        </select>
        <input type="number" min="1" placeholder="æ•°é‡" onchange="updatePickupDateControl();">
        <button type="button" class="remove-product-btn" onclick="removeProductItem(this)">å‰Šé™¤</button>
        <div class="product-desc"></div>
      `;
      
      container.appendChild(itemDiv);
      
      // å•†å“é¸æŠè‚¢ã‚’è¨­å®š
      const select = itemDiv.querySelector('select');
      allProducts.forEach(product => {
        const option = document.createElement('option');
        option.value = product.name;
        option.textContent = `${product.name} (${product.price}å††)`;
        select.appendChild(option);
      });
    }

    // å•†å“é …ç›®ã‚’å‰Šé™¤
    function removeProductItem(button) {
      const container = document.getElementById('product-list-area');
      if (container.children.length > 1) {
        button.parentElement.remove();
        updatePickupDateControl();
      }
    }

    // å•†å“èª¬æ˜ã‚’æ›´æ–°
    function updateProductDescription(select) {
      const descDiv = select.parentElement.querySelector('.product-desc');
      const selectedProduct = allProducts.find(p => p.name === select.value);
      
      if (selectedProduct && selectedProduct.description) {
        descDiv.textContent = selectedProduct.description;
      } else {
        descDiv.textContent = '';
      }
    }

    // å–¶æ¥­æ—¥è¨ˆç®—é–¢æ•°
    function getBusinessDate(startDate, businessDays) {
      let date = new Date(startDate);
      let count = 0;
      
      while (count < businessDays) {
        date.setDate(date.getDate() + 1);
        if (date.getDay() !== 0 && date.getDay() !== 6) {
          count++;
        }
      }
      
      return date;
    }

    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showError(fieldName, message) {
      const errorElement = document.getElementById(fieldName + '-error');
      if (errorElement) {
        errorElement.textContent = message;
      }
    }

    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¯ãƒªã‚¢
    function clearErrors() {
      const errorElements = document.querySelectorAll('.error-message');
      errorElements.forEach(el => el.textContent = '');
    }

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
    document.getElementById('reserveForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
      clearErrors();
      
      // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
      const formData = new FormData(this);
      
      // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      const securityValidation = await validateFormSecurity(formData);
      if (!securityValidation.isValid) {
        // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
        securityValidation.errors.forEach(err => {
          if (err.field === 'privacy-consent') {
            document.getElementById('privacy-consent-error').textContent = err.message;
          } else if (err.field === 'recaptcha') {
            document.getElementById('recaptcha-error').textContent = err.message;
          } else if (err.field === 'rate-limit') {
            // ãƒ¬ãƒ¼ãƒˆåˆ¶é™è­¦å‘Šã¯é–¢æ•°å†…ã§è¡¨ç¤ºæ¸ˆã¿
          } else {
            showError(err.field, err.message);
          }
        });
        return;
      }
      
      const data = {
        name: formData.get('name'),
        phone: formData.get('phone'),
        email: formData.get('email'),
        store: formData.get('store'),
        pickup_date: formData.get('pickup_date'),
        pickup_time: formData.get('pickup_time'),
        note: formData.get('note'),
        items: []
      };
      
      // å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
      const productItems = document.querySelectorAll('.product-item');
      productItems.forEach(itemDiv => {
        const select = itemDiv.querySelector('select');
        const qtyInput = itemDiv.querySelector('input[type="number"]');
        
        if (select.value && qtyInput.value) {
          data.items.push({
            name: select.value,
            qty: qtyInput.value
          });
        }
      });
      
      // å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚º
      const processedData = await preprocessFormData(data);
      
      // çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
      document.getElementById('result').textContent = '';

      // é€ä¿¡ä¸­ã¯ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–
      const submitBtn = document.getElementById('submit-btn');
      submitBtn.disabled = true;
      submitBtn.style.background = '#aaa';
      
      // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆã‚µãƒ‹ã‚¿ã‚¤ã‚ºå¾Œã®ãƒ‡ãƒ¼ã‚¿ï¼‰
      console.log('é€ä¿¡ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚µãƒ‹ã‚¿ã‚¤ã‚ºå¾Œï¼‰:', processedData);
      console.log('é€ä¿¡å…ˆURL:', GAS_WEB_APP_URL);

      try {
        // éš ã—ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½¿ç”¨ã—ã¦GASã«é€ä¿¡
        const result = await sendToGasViaForm(processedData);
        console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹çµæœ:', result);

        if (result && result.success) {
          // é€ä¿¡æˆåŠŸæ™‚ã¯é€ä¿¡æ™‚åˆ»ã‚’è¨˜éŒ²ï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™ç”¨ï¼‰
          recordSubmitTime();
          
          // åˆè¨ˆé‡‘é¡ã®è¡¨ç¤º
          document.getElementById('result').innerHTML = '<span style="color:#27ae60;">äºˆç´„å®Œäº†ã—ã¾ã—ãŸï¼<br>åˆè¨ˆé‡‘é¡ï¼š' + result.total + 'å††</span>';
          // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
          document.getElementById('modal-message').innerHTML = 'äºˆç´„å®Œäº†ã—ã¾ã—ãŸï¼<br>åˆè¨ˆé‡‘é¡ï¼š' + result.total + 'å††';
          document.getElementById('custom-modal').style.display = 'flex';
          // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€é€ä¿¡ä¸å¯ã«
          document.getElementById('reserveForm').reset();
          document.getElementById('reserveForm').querySelectorAll('input, select, textarea, button').forEach(function(el){ el.disabled = true; });
          // å•†å“é …ç›®ã‚’ã‚¯ãƒªã‚¢
          document.getElementById('product-list-area').innerHTML = '';
          // ã€Œç”»é¢ã‚’é–‰ã˜ã‚‹ã€ãƒœã‚¿ãƒ³ã¯ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã«
          document.getElementById('close-btn-area').innerHTML = '';
          
          // reCAPTCHA v3ã§ã¯æ‰‹å‹•ãƒªã‚»ãƒƒãƒˆä¸è¦
        } else if (result && result.errors) {
          // ã‚µãƒ¼ãƒãƒ¼å´ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
          document.getElementById('result').textContent = 'ã‚¨ãƒ©ãƒ¼: ' + result.errors.join('\n');
          document.getElementById('result').style.color = '#e74c3c';
          // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã”ã¨ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          result.errors.forEach(err => {
              if (err.includes('ãŠåå‰')) showError('name', err);
              else if (err.includes('é›»è©±ç•ªå·')) showError('phone', err);
              else if (err.includes('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹')) showError('email', err);
              else if (err.includes('åº—èˆ—')) showError('store', err);
              else if (err.includes('å•†å“') || err.includes('æ•°é‡')) showError('items', err);
              else if (err.includes('å—å–å¸Œæœ›æ—¥')) showError('pickup_date', err);
              else if (err.includes('å—å–å¸Œæœ›æ™‚é–“')) showError('pickup_time', err);
          });
        } else {
          // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
          document.getElementById('result').textContent = 'ã‚¨ãƒ©ãƒ¼: ' + (result ? result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' : 'é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
          document.getElementById('result').style.color = '#e74c3c';
        }
        
        // å®Œäº†æ™‚ã¯ãƒœã‚¿ãƒ³ã‚’å†åº¦æœ‰åŠ¹åŒ–
        submitBtn.disabled = false;
        submitBtn.style.background = '';
        
      } catch (error) {
        console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒœã‚¿ãƒ³ã‚’å†åº¦æœ‰åŠ¹åŒ–
        submitBtn.disabled = false;
        submitBtn.style.background = '';
        
        // ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        let errorMessage = 'é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
        
        // ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã«å¿œã˜ãŸå¯¾å‡¦æ³•ã‚’è¿½åŠ 
        if (error.message.includes('JSON')) {
          errorMessage += '\n\nã€å¯¾å‡¦æ³•ã€‘\n';
          errorMessage += '1. ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„\n';
          errorMessage += '2. ã—ã°ã‚‰ãæ™‚é–“ã‚’ç½®ã„ã¦ã‹ã‚‰å†åº¦é€ä¿¡ã—ã¦ãã ã•ã„\n';
          errorMessage += '3. å•é¡ŒãŒç¶šãå ´åˆã¯ã€ç›´æ¥åº—èˆ—ã«ãŠé›»è©±ã§ã”äºˆç´„ãã ã•ã„';
        } else if (error.message.includes('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯') || error.message.includes('æ¥ç¶š')) {
          errorMessage += '\n\nã€å¯¾å‡¦æ³•ã€‘\n';
          errorMessage += '1. ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„\n';
          errorMessage += '2. ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„\n';
          errorMessage += '3. Wi-Fiã‚’ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã«åˆ‡ã‚Šæ›¿ãˆã¦ãŠè©¦ã—ãã ã•ã„';
        } else if (error.message.includes('å¤§ãã™ãã¾ã™')) {
          errorMessage += '\n\nã€å¯¾å‡¦æ³•ã€‘\n';
          errorMessage += '1. å‚™è€ƒæ¬„ã®æ–‡å­—æ•°ã‚’æ¸›ã‚‰ã—ã¦ãã ã•ã„\n';
          errorMessage += '2. å•†å“ã‚’åˆ†ã‘ã¦è¤‡æ•°å›ã«åˆ†ã‘ã¦ã”æ³¨æ–‡ãã ã•ã„';
        }
        
        document.getElementById('result').textContent = errorMessage;
        document.getElementById('result').style.color = '#e74c3c';
        document.getElementById('result').style.whiteSpace = 'pre-line';
        
        // è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
        console.group('=== é€ä¿¡ã‚¨ãƒ©ãƒ¼è©³ç´°æƒ…å ± ===');
        console.log('ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', error.message);
        console.log('ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯:', error.stack);
        console.log('é€ä¿¡ãƒ‡ãƒ¼ã‚¿:', data);
        console.log('GAS URL:', GAS_WEB_APP_URL);
        console.groupEnd();
      }
    });

    // GASã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹é–¢æ•°ï¼ˆJSONPæ–¹å¼ãƒ»CORSå®Œå…¨å›é¿ï¼‰
    async function sendToGasViaForm(data) {
      return new Promise((resolve, reject) => {
        try {
          console.log('=== JSONPé€ä¿¡é–‹å§‹ ===', data);
          
          // JSONPæ–¹å¼ï¼šã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã§CORSã‚’å®Œå…¨å›é¿
          const callbackName = 'submitCallback' + Date.now();
          console.log('Submit JSONP Callbackå:', callbackName);
          
          // æ—¢å­˜ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’å‰Šé™¤ï¼ˆã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼‰
          const existingScripts = document.querySelectorAll('script[data-submit-jsonp="true"]');
          existingScripts.forEach(script => script.remove());
          
          // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å®šç¾©
          window[callbackName] = function(result) {
            console.log('=== Submit JSONP Responseå—ä¿¡ ===');
            console.log('Response type:', typeof result);
            console.log('Response content:', result);
            
            // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæ–‡å­—åˆ—ã®å ´åˆã¯JSONãƒ‘ãƒ¼ã‚¹ã‚’è©¦è¡Œ
            if (typeof result === 'string') {
              console.log('String response detected, attempting JSON parse...');
              console.log('Raw string:', JSON.stringify(result));
              console.log('First 100 chars:', result.substring(0, 100));
              try {
                result = JSON.parse(result);
                console.log('Parsed JSON:', result);
              } catch (parseError) {
                console.error('JSON parse failed:', parseError);
                console.error('Original string that failed to parse:', result);
                cleanupSubmitJSONP(callbackName);
                reject(new Error('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ãŒä¸æ­£ã§ã™: ' + parseError.message));
                return;
              }
            }
            
            try {
              if (result && result.success) {
                console.log('äºˆç´„é€ä¿¡æˆåŠŸ:', result);
                resolve(result);
              } else {
                console.error('äºˆç´„é€ä¿¡å¤±æ•—:', result);
                reject(new Error(result ? result.error : 'é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ'));
              }
            } catch (error) {
              console.error('Submitå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
              reject(error);
            } finally {
              // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
              cleanupSubmitJSONP(callbackName);
            }
          };
          
          // ãƒ‡ãƒ¼ã‚¿ã‚’Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§é€ä¿¡
          const jsonString = JSON.stringify(data);
          console.log('=== ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å‰ãƒ‡ãƒ¼ã‚¿è©³ç´° ===');
          console.log('JSONæ–‡å­—åˆ—é•·:', jsonString.length);
          console.log('JSONæ–‡å­—åˆ—ï¼ˆæœ€åˆã®200æ–‡å­—ï¼‰:', jsonString.substring(0, 200));
          console.log('JSONæ–‡å­—åˆ—ï¼ˆæœ€å¾Œã®100æ–‡å­—ï¼‰:', jsonString.substring(jsonString.length - 100));
          console.log('================================');
          
          const encodedData = btoa(encodeURIComponent(jsonString));
          console.log('ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿é•·:', encodedData.length);
          console.log('ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ï¼ˆæœ€åˆã®100æ–‡å­—ï¼‰:', encodedData.substring(0, 100));
          
          // ãƒ‡ã‚³ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆï¼ˆæ¤œè¨¼ç”¨ï¼‰
          try {
            const testDecoded = decodeURIComponent(atob(encodedData));
            console.log('=== ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ã‚³ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ ===');
            console.log('ãƒ‡ã‚³ãƒ¼ãƒ‰æˆåŠŸ');
            console.log('ãƒ‡ã‚³ãƒ¼ãƒ‰çµæœé•·:', testDecoded.length);
            console.log('ãƒ‡ã‚³ãƒ¼ãƒ‰çµæœï¼ˆæœ€åˆã®200æ–‡å­—ï¼‰:', testDecoded.substring(0, 200));
            console.log('å…ƒã®JSONã¨ä¸€è‡´:', testDecoded === jsonString);
            console.log('===========================');
          } catch (localDecodeError) {
            console.error('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ã‚³ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', localDecodeError);
          }
          
          // ä»£æ›¿ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ–¹æ³•ã‚‚è©¦è¡Œï¼ˆBase64ãŒå¤±æ•—ã™ã‚‹å ´åˆã®å‚™ãˆï¼‰
          let alternativeData = null;
          try {
            // URL SafeãªBase64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
            const urlSafeBase64 = btoa(encodeURIComponent(jsonString))
              .replace(/\+/g, '-')
              .replace(/\//g, '_')
              .replace(/=/g, '');
            console.log('URL Safe Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰:', urlSafeBase64.substring(0, 100));
            
            // ç›´æ¥URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆçŸ­ã„å ´åˆã®ã¿ï¼‰
            if (jsonString.length < 1000) {
              const directUrlEncoded = encodeURIComponent(jsonString);
              console.log('ç›´æ¥URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰é•·:', directUrlEncoded.length);
              alternativeData = { method: 'direct', data: directUrlEncoded };
            }
          } catch (altError) {
            console.warn('ä»£æ›¿ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å¤±æ•—:', altError);
          }
          
          // JSONPãƒªã‚¯ã‚¨ã‚¹ãƒˆURLä½œæˆ
          const jsonpUrl = `${GAS_WEB_APP_URL}?action=submitReservation&data=${encodedData}&callback=${callbackName}&_t=${Date.now()}`;
          console.log('Submit JSONP URLé•·:', jsonpUrl.length);
          console.log('Submit JSONP URL:', jsonpUrl.substring(0, 200) + '...');
          
          // URLãŒé•·ã™ãã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼
          if (jsonpUrl.length > 8000) {
            throw new Error('é€ä¿¡ãƒ‡ãƒ¼ã‚¿ãŒå¤§ãã™ãã¾ã™ã€‚å‚™è€ƒæ¬„ã®æ–‡å­—æ•°ã‚’æ¸›ã‚‰ã—ã¦ãã ã•ã„ã€‚');
          }
          
          // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’ä½œæˆ
          const script = document.createElement('script');
          script.src = jsonpUrl;
          script.setAttribute('data-submit-jsonp', 'true');
          script.setAttribute('data-callback', callbackName);
          
          // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
          script.onerror = function(error) {
            console.error('Submit JSONPèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            console.error('Failed URL:', jsonpUrl.substring(0, 200) + '...');
            cleanupSubmitJSONP(callbackName);
            
            // CORSã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯æ¦‚ç®—é‡‘é¡ã§æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
            const estimatedTotal = data.items.reduce((sum, item) => {
              const product = allProducts.find(p => p.name === item.name);
              const price = product ? product.price : 500;
              return sum + (price * parseInt(item.qty));
            }, 0);

            console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†:', estimatedTotal);
            resolve({
              success: true,
              total: estimatedTotal,
              message: 'äºˆç´„ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸï¼ˆæ¦‚ç®—é‡‘é¡ï¼‰'
            });
          };
          
          script.onload = function() {
            console.log('Submit JSONPã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†');
          };
          
          // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’è¿½åŠ ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆå®Ÿè¡Œ
          document.head.appendChild(script);
          
          // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ15ç§’ï¼‰
          setTimeout(() => {
            if (window[callbackName]) {
              console.warn('Submit JSONP ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ');
              cleanupSubmitJSONP(callbackName);
              
              // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã‚‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
              const estimatedTotal = data.items.reduce((sum, item) => {
                const product = allProducts.find(p => p.name === item.name);
                const price = product ? product.price : 500;
                return sum + (price * parseInt(item.qty));
              }, 0);
              
              resolve({
                success: true,
                total: estimatedTotal,
                message: 'äºˆç´„ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸï¼ˆç¢ºèªä¸­ï¼‰'
              });
            }
          }, 15000);
          
        } catch (error) {
          console.error('Submit JSONPåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
          reject(error);
        }
      });
    }

    // Submit JSONP ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°
    function cleanupSubmitJSONP(callbackName) {
      try {
        // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’å‰Šé™¤
        const script = document.querySelector(`script[data-callback="${callbackName}"]`);
        if (script && script.parentNode) {
          script.parentNode.removeChild(script);
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å‰Šé™¤
        if (window[callbackName]) {
          delete window[callbackName];
        }
        
        console.log('Submit JSONP ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†:', callbackName);
      } catch (error) {
        console.warn('Submit JSONP ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // JSTã®ã€Œä»Šæ—¥ã€ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    function getTodayJST() {
      const now = new Date();
      // UTCâ†’JSTï¼ˆ+9æ™‚é–“ï¼‰ã«å¤‰æ›
      const jst = new Date(now.getTime() + (9 * 60 * 60 * 1000));
      return new Date(jst.getFullYear(), jst.getMonth(), jst.getDate());
    }

    // å•†å“é¸æŠæ™‚ã«å—å–æ—¥ãƒ»å—å–æ™‚é–“ã®æœ‰åŠ¹åŒ–/ç„¡åŠ¹åŒ–ã€æœ€çŸ­å—å–æ—¥è¨ˆç®—ã€æ³¨æ„æ›¸ãè¡¨ç¤º
    function updatePickupDateControl() {
      const productItems = document.querySelectorAll('.product-item');
      const dateInput = document.getElementById('pickup_date');
      const timeSelect = document.getElementById('pickup_time');
      const noteDiv = document.getElementById('product-date-note');
      let selectedProducts = [];
      let allSelected = true;
      productItems.forEach(itemDiv => {
        const select = itemDiv.querySelector('select');
        const qtyInput = itemDiv.querySelector('input[type="number"]');
        if (
          select && select.value &&
          qtyInput && qtyInput.value && !isNaN(qtyInput.value) &&
          parseInt(qtyInput.value) >= 1 && Number.isInteger(Number(qtyInput.value))
        ) {
          const prod = allProducts.find(p => p.name === select.value);
          if (prod) selectedProducts.push(prod);
        } else {
          allSelected = false;
        }
      });
      if (selectedProducts.length === 0) {
        dateInput.value = '';
        dateInput.disabled = true;
        dateInput.min = '';
        dateInput.max = '';
        timeSelect.value = '';
        timeSelect.disabled = true;
        noteDiv.innerHTML = 'å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
        return;
      }
      // inputã¯å¿…ãšæœ‰åŠ¹åŒ–
      dateInput.disabled = false;
      // æœ€ã‚‚é…ã„minDays/minType/cutoffã‚’æŒã¤å•†å“ã‚’æ¢ã™
      let minDate = null;
      let minType = null;
      let cutoff = null;
      let now = new Date();
      let today = getTodayJST();
      let maxMinDate = null;
      let cutoffMsg = '';
      selectedProducts.forEach(prod => {
        let prodMinDate;
        if (prod.minType === 'business') {
          prodMinDate = getBusinessDate(today, prod.minDays);
        } else {
          prodMinDate = new Date(today);
          // ç· åˆ‡æ™‚åˆ»è€ƒæ…®
          if (prod.cutoff) {
            const [h, m] = prod.cutoff.split(':').map(Number);
            let cutoffDate = new Date(today);
            cutoffDate.setHours(h, m, 0, 0);
            if (now > cutoffDate) {
              prodMinDate.setDate(prodMinDate.getDate() + prod.minDays + 1);
              cutoffMsg = 'â€»ä¸€éƒ¨å•†å“ã¯æœ¬æ—¥ã®ç· åˆ‡æ™‚åˆ»ã‚’éãã¦ã„ã‚‹ãŸã‚ã€ç¿Œæ—¥ä»¥é™ã®å—å–ã¨ãªã‚Šã¾ã™ã€‚';
            } else {
              prodMinDate.setDate(prodMinDate.getDate() + prod.minDays);
            }
          } else {
            prodMinDate.setDate(prodMinDate.getDate() + prod.minDays);
          }
        }
        if (!maxMinDate || prodMinDate > maxMinDate) {
          maxMinDate = prodMinDate;
        }
      });
      // æœ€å¤§30å–¶æ¥­æ—¥å¾Œ
      let maxDate = getBusinessDate(today, 30);
      dateInput.min = maxMinDate.toISOString().split('T')[0];
      dateInput.max = maxDate.toISOString().split('T')[0];
      
      // é¸æŠå¯èƒ½ãªæœ€åˆã®å–¶æ¥­æ—¥ã‚’è¨­å®š
      const storeSelect = document.getElementById('store');
      if (storeSelect.value) {
        const validDate = findNextValidDate(maxMinDate, storeSelect.value);
        if (validDate) {
          const dateString = formatDateForInput(validDate);
          dateInput.value = dateString;
        } else {
          dateInput.value = '';
        }
      } else {
        // åº—èˆ—æœªé¸æŠã®å ´åˆã¯æœ€å°æ—¥ä»˜ã‚’è¨­å®šï¼ˆãŸã ã—ã€å¾Œã§åº—èˆ—é¸æŠæ™‚ã«å–¶æ¥­æ—¥ã«èª¿æ•´ã•ã‚Œã‚‹ï¼‰
        dateInput.value = dateInput.min;
      }
      
      // å—å–æ—¥ãŒé¸æŠã•ã‚ŒãŸã‚‰æ™‚é–“é¸æŠã‚’æœ‰åŠ¹åŒ–
      if (dateInput.value) {
        // åº—èˆ—å–¶æ¥­æ™‚é–“ã«åŸºã¥ã„ã¦å—å–æ™‚åˆ»ã‚’æ›´æ–°
        updatePickupTimeOptions();
      } else {
        timeSelect.value = '';
        timeSelect.disabled = true;
      }
      // æ³¨æ„æ›¸ããƒ»èª¬æ˜æ–‡
      if (selectedProducts.length > 1) {
        noteDiv.innerHTML = 'â€»è¤‡æ•°ã®å•†å“ã‚’åŒæ™‚ã«ã”æ³¨æ–‡ã„ãŸã ãå ´åˆã€ã™ã¹ã¦ã®å•†å“ãŒæƒã†æœ€ã‚‚é…ã„å—å–æ—¥ä»¥é™ã®ã¿ã”æŒ‡å®šã„ãŸã ã‘ã¾ã™ã€‚<br>å•†å“ã”ã¨ã«ç•°ãªã‚‹å—å–æ—¥ã‚’ã”å¸Œæœ›ã®å ´åˆã¯ã€ãŠæ‰‹æ•°ã§ã™ãŒã”æ³¨æ–‡ã‚’åˆ†ã‘ã¦ã”å…¥åŠ›ãã ã•ã„ã€‚' + (cutoffMsg ? '<br>' + cutoffMsg : '');
      } else if (selectedProducts.length === 1) {
        noteDiv.innerHTML = '' + (cutoffMsg ? '<br>' + cutoffMsg : '');
      } else {
        noteDiv.innerHTML = 'å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
      }
    }

    /**
     * ä¼‘æ¥­æ—¥ãƒã‚§ãƒƒã‚¯ã‚’å«ã‚€å—å–æ—¥ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
     */
    function validatePickupDate() {
      const dateInput = document.getElementById('pickup_date');
      const storeSelect = document.getElementById('store');
      const timeSelect = document.getElementById('pickup_time');
      
      if (!dateInput.value) {
        timeSelect.value = '';
        timeSelect.disabled = true;
        showError('pickup_date', '');
        return;
      }
      
      if (!storeSelect.value) {
        showError('pickup_date', 'åº—èˆ—ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„');
        dateInput.value = '';
        timeSelect.value = '';
        timeSelect.disabled = true;
        return;
      }
      
      // é¸æŠã•ã‚ŒãŸåº—èˆ—æƒ…å ±ã‚’å–å¾—
      const selectedStore = allStores.find(store => store.name === storeSelect.value);
      if (!selectedStore) {
        showError('pickup_date', 'åº—èˆ—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        dateInput.value = '';
        timeSelect.value = '';
        timeSelect.disabled = true;
        return;
      }
      
      // é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã®æ›œæ—¥ã‚’ãƒã‚§ãƒƒã‚¯
      const selectedDate = new Date(dateInput.value);
      const dayOfWeek = getDayOfWeekKey(selectedDate.getDay());
      const storeHours = selectedStore.hours[dayOfWeek];
      
      // ä¼‘æ¥­æ—¥ã®å ´åˆ
      if (!storeHours || storeHours === null) {
        const dayNames = {
          'mon': 'æœˆæ›œæ—¥',
          'tue': 'ç«æ›œæ—¥', 
          'wed': 'æ°´æ›œæ—¥',
          'thu': 'æœ¨æ›œæ—¥',
          'fri': 'é‡‘æ›œæ—¥',
          'sat': 'åœŸæ›œæ—¥',
          'sun': 'æ—¥æ›œæ—¥'
        };
        showError('pickup_date', `${dayNames[dayOfWeek]}ã¯ä¼‘æ¥­æ—¥ã§ã™ã€‚ä»–ã®å–¶æ¥­æ—¥ã‚’ãŠé¸ã³ãã ã•ã„ã€‚`);
        
        // æ¬¡ã®å–¶æ¥­æ—¥ã‚’ææ¡ˆ
        const nextValidDate = findNextValidDate(selectedDate, storeSelect.value);
        if (nextValidDate) {
          const newDateString = formatDateForInput(nextValidDate);
          dateInput.value = newDateString;
          // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢ã—ã¦æ™‚é–“é¸æŠã‚’æ›´æ–°
          setTimeout(() => {
            showError('pickup_date', '');
            updatePickupTimeOptions();
          }, 2000); // 2ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¶ˆã—ã¦æ¬¡ã®å–¶æ¥­æ—¥ã«è¨­å®š
        } else {
          dateInput.value = '';
          timeSelect.value = '';
          timeSelect.disabled = true;
        }
        return;
      }
      
      // å–¶æ¥­æ—¥ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¦æ™‚é–“é¸æŠã‚’æ›´æ–°
      showError('pickup_date', '');
      updatePickupTimeOptions();
    }

    /**
     * æ—¥ä»˜æ–‡å­—åˆ—ã‚’YYYY-MM-DDå½¢å¼ã«æ­£è¦åŒ–
     * @param {Date} date - æ—¥ä»˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @return {string} YYYY-MM-DDå½¢å¼ã®æ–‡å­—åˆ—
     */
    function formatDateForInput(date) {
      const year = date.getFullYear();
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const day = date.getDate().toString().padStart(2, '0');
      const formatted = `${year}-${month}-${day}`;
      return formatted;
    }

    /**
     * æŒ‡å®šæ—¥ä»¥é™ã®æ¬¡ã®å–¶æ¥­æ—¥ã‚’æ¤œç´¢
     * @param {Date} startDate - æ¤œç´¢é–‹å§‹æ—¥
     * @param {string} storeName - åº—èˆ—å
     * @return {Date|null} æ¬¡ã®å–¶æ¥­æ—¥ï¼ˆè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯nullï¼‰
     */
    function findNextValidDate(startDate, storeName) {
      const selectedStore = allStores.find(store => store.name === storeName);
      if (!selectedStore) {
        return null;
      }
      
      const maxAttempts = 14; // æœ€å¤§2é€±é–“å…ˆã¾ã§æ¤œç´¢
      // é–‹å§‹æ—¥ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã«æ³¨æ„ï¼‰
      let currentDate = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
      
      for (let i = 0; i < maxAttempts; i++) {
        const dayOfWeek = getDayOfWeekKey(currentDate.getDay());
        const storeHours = selectedStore.hours[dayOfWeek];
        
        // å–¶æ¥­æ—¥ã‹ã¤æœ€å°æ—¥ä»˜ä»¥é™ã®å ´åˆ
        if (storeHours && storeHours !== null) {
          const dateInput = document.getElementById('pickup_date');
          const minDate = new Date(dateInput.min);
          const maxDate = new Date(dateInput.max);
          
          if (currentDate >= minDate && currentDate <= maxDate) {
            // æ–°ã—ã„Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦è¿”ã™ï¼ˆå‚ç…§ã®å•é¡Œã‚’è§£æ±ºï¼‰
            return new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate());
          }
        }
        
        // æ¬¡ã®æ—¥ã¸
        currentDate.setDate(currentDate.getDate() + 1);
      }
      
      return null; // å–¶æ¥­æ—¥ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
    }

    /**
     * åº—èˆ—å–¶æ¥­æ™‚é–“ã«åŸºã¥ã„ã¦å—å–æ™‚åˆ»é¸æŠè‚¢ã‚’æ›´æ–°ã™ã‚‹
     */
    function updatePickupTimeOptions() {
      const storeSelect = document.getElementById('store');
      const dateInput = document.getElementById('pickup_date');
      const timeSelect = document.getElementById('pickup_time');
      
      // åº—èˆ—ã¨æ—¥ä»˜ãŒä¸¡æ–¹é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å‡¦ç†
      if (!storeSelect.value || !dateInput.value) {
        // é¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯æ™‚é–“é¸æŠã‚’ç„¡åŠ¹åŒ–
        timeSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        timeSelect.disabled = true;
        return;
      }
      
      try {
        // é¸æŠã•ã‚ŒãŸåº—èˆ—ã®æƒ…å ±ã‚’å–å¾—
        const selectedStore = allStores.find(store => store.name === storeSelect.value);
        if (!selectedStore) {
          console.error('é¸æŠã•ã‚ŒãŸåº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        
        // é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã®æ›œæ—¥ã‚’å–å¾—
        const selectedDate = new Date(dateInput.value);
        const dayOfWeek = getDayOfWeekKey(selectedDate.getDay());
        
        // åº—èˆ—ã®å–¶æ¥­æ™‚é–“ã‚’å–å¾—
        const storeHours = selectedStore.hours[dayOfWeek];
        
        // å–¶æ¥­æ™‚é–“ã«åŸºã¥ã„ã¦æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆã‚’ç”Ÿæˆ
        const timeSlots = generateTimeSlots(storeHours);
        
        // æ™‚é–“é¸æŠè‚¢ã‚’æ›´æ–°
        updateTimeSelectOptions(timeSlots, storeHours);
        
      } catch (error) {
        console.error('å—å–æ™‚åˆ»ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        timeSelect.innerHTML = '<option value="">æ™‚åˆ»ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</option>';
        timeSelect.disabled = true;
      }
    }

    /**
     * æ›œæ—¥ç•ªå·ã‚’æ›œæ—¥ã‚­ãƒ¼ã«å¤‰æ›
     * @param {number} dayNumber - æ›œæ—¥ç•ªå·ï¼ˆ0=æ—¥æ›œæ—¥, 1=æœˆæ›œæ—¥, ...ï¼‰
     * @return {string} æ›œæ—¥ã‚­ãƒ¼ï¼ˆmon, tue, wed, thu, fri, sat, sunï¼‰
     */
    function getDayOfWeekKey(dayNumber) {
      const dayKeys = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
      return dayKeys[dayNumber];
    }

    /**
     * å–¶æ¥­æ™‚é–“ã«åŸºã¥ã„ã¦30åˆ†é–“éš”ã®æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆã‚’ç”Ÿæˆ
     * @param {Array|null} hours - å–¶æ¥­æ™‚é–“é…åˆ—
     * @return {Array<string>} æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆé…åˆ—
     */
    function generateTimeSlots(hours) {
      if (!hours || hours === null) {
        return [];
      }
      
      const slots = [];
      
      // å–¶æ¥­æ™‚é–“ãŒé…åˆ—ã®é…åˆ—ã®å ´åˆï¼ˆè¤‡æ•°ã®å–¶æ¥­æ™‚é–“å¸¯ï¼‰
      if (Array.isArray(hours[0])) {
        hours.forEach(timeRange => {
          const rangeSlots = generateTimeSlotsForRange(timeRange[0], timeRange[1]);
          slots.push(...rangeSlots);
        });
      } else {
        // å˜ä¸€ã®å–¶æ¥­æ™‚é–“å¸¯ã®å ´åˆ
        const rangeSlots = generateTimeSlotsForRange(hours[0], hours[1]);
        slots.push(...rangeSlots);
      }
      
      return slots.sort(); // æ™‚é–“é †ã«ã‚½ãƒ¼ãƒˆ
    }

    /**
     * é–‹å§‹æ™‚åˆ»ã¨çµ‚äº†æ™‚åˆ»ã®é–“ã§30åˆ†é–“éš”ã®æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆã‚’ç”Ÿæˆ
     * @param {string} startTime - é–‹å§‹æ™‚åˆ»ï¼ˆHH:MMå½¢å¼ï¼‰
     * @param {string} endTime - çµ‚äº†æ™‚åˆ»ï¼ˆHH:MMå½¢å¼ï¼‰
     * @return {Array<string>} æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆé…åˆ—
     */
    function generateTimeSlotsForRange(startTime, endTime) {
      const slots = [];
      const [startHour, startMin] = startTime.split(':').map(Number);
      const [endHour, endMin] = endTime.split(':').map(Number);
      
      let currentHour = startHour;
      let currentMin = startMin;
      
      while (currentHour < endHour || (currentHour === endHour && currentMin < endMin)) {
        const timeSlot = `${currentHour.toString().padStart(2, '0')}:${currentMin.toString().padStart(2, '0')}`;
        slots.push(timeSlot);
        
        // 30åˆ†è¿½åŠ 
        currentMin += 30;
        if (currentMin >= 60) {
          currentMin = 0;
          currentHour++;
        }
      }
      
      return slots;
    }

    /**
     * æ™‚é–“é¸æŠè‚¢ã‚’æ›´æ–°
     * @param {Array<string>} timeSlots - æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆé…åˆ—
     * @param {Array|null} storeHours - åº—èˆ—å–¶æ¥­æ™‚é–“
     */
    function updateTimeSelectOptions(timeSlots, storeHours) {
      const timeSelect = document.getElementById('pickup_time');
      const currentValue = timeSelect.value; // ç¾åœ¨ã®é¸æŠå€¤ã‚’ä¿æŒ
      
      // é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢
      timeSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
      
      if (!storeHours || storeHours === null) {
        // å–¶æ¥­ã—ã¦ã„ãªã„å ´åˆ
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'ã“ã®æ—¥ã¯å–¶æ¥­ã—ã¦ãŠã‚Šã¾ã›ã‚“';
        option.disabled = true;
        timeSelect.appendChild(option);
        timeSelect.disabled = true;
        return;
      }
      
      if (timeSlots.length === 0) {
        // æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆãŒãªã„å ´åˆ
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'å—å–å¯èƒ½æ™‚é–“ãŒã‚ã‚Šã¾ã›ã‚“';
        option.disabled = true;
        timeSelect.appendChild(option);
        timeSelect.disabled = true;
        return;
      }
      
      // æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆã‚’é¸æŠè‚¢ã¨ã—ã¦è¿½åŠ 
      timeSlots.forEach(slot => {
        const option = document.createElement('option');
        option.value = slot;
        option.textContent = slot;
        timeSelect.appendChild(option);
      });
      
      // æ™‚é–“é¸æŠã‚’æœ‰åŠ¹åŒ–
      timeSelect.disabled = false;
      
      // ä»¥å‰ã®é¸æŠå€¤ãŒæœ‰åŠ¹ãªå ´åˆã¯å¾©å…ƒ
      if (currentValue && timeSlots.includes(currentValue)) {
        timeSelect.value = currentValue;
      }
    }

    // ==============================================
    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®æ©Ÿèƒ½
    // ==============================================
    
    /**
     * ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã®è©³ç´°è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
     */
    function togglePrivacyPolicy() {
      const content = document.getElementById('privacy-content');
      const button = document.querySelector('.privacy-toggle');
      
      if (content.style.display === 'none' || content.style.display === '') {
        content.style.display = 'block';
        button.textContent = 'è©³ç´°ã‚’éè¡¨ç¤º';
      } else {
        content.style.display = 'none';
        button.textContent = 'è©³ç´°ã‚’è¡¨ç¤º';
      }
    }
    
    /**
     * ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆçŸ­æ™‚é–“å†…ã®é€£ç¶šé€ä¿¡é˜²æ­¢ï¼‰
     * @return {boolean} é€ä¿¡å¯èƒ½ã‹ã©ã†ã‹
     */
    function checkRateLimit() {
      const now = Date.now();
      const lastSubmitTime = localStorage.getItem('lastSubmitTime');
      const RATE_LIMIT_DURATION = 60000; // 1åˆ†é–“åˆ¶é™
      
      if (lastSubmitTime && (now - parseInt(lastSubmitTime)) < RATE_LIMIT_DURATION) {
        const remaining = Math.ceil((RATE_LIMIT_DURATION - (now - parseInt(lastSubmitTime))) / 1000);
        document.getElementById('rate-limit-warning').style.display = 'block';
        document.getElementById('rate-limit-warning').innerHTML = 
          `<strong>âš ï¸ æ³¨æ„:</strong> çŸ­æ™‚é–“å†…ã®é€£ç¶šé€ä¿¡ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚ã‚ã¨${remaining}ç§’ãŠå¾…ã¡ãã ã•ã„ã€‚`;
        return false;
      }
      
      document.getElementById('rate-limit-warning').style.display = 'none';
      return true;
    }
    
    /**
     * é€ä¿¡æ™‚åˆ»ã‚’è¨˜éŒ²ï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™ç”¨ï¼‰
     */
    function recordSubmitTime() {
      localStorage.setItem('lastSubmitTime', Date.now().toString());
    }
    
    /**
     * å…¥åŠ›å€¤ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ï¼‰
     * @param {string} input - å…¥åŠ›æ–‡å­—åˆ—
     * @return {string} ã‚µãƒ‹ã‚¿ã‚¤ã‚ºå¾Œã®æ–‡å­—åˆ—
     */
    function sanitizeInput(input) {
      if (typeof input !== 'string') return '';
      
      // HTMLã‚¿ã‚°ã‚’é™¤å»
      input = input.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
      input = input.replace(/<[^>]*>/g, '');
      
      // SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ï¼ˆåŸºæœ¬çš„ãªå±é™ºæ–‡å­—åˆ—ã‚’é™¤å»ï¼‰
      const dangerousPatterns = [
        /('|\\')|(;)|(\\)|(--|\/\*|\*\/)/gi,
        /(select|insert|update|delete|drop|union|script)/gi
      ];
      
      dangerousPatterns.forEach(pattern => {
        input = input.replace(pattern, '');
      });
      
      // æ”¹è¡Œãƒ»ç‰¹æ®Šæ–‡å­—ã®æ­£è¦åŒ–
      input = input.replace(/[\r\n\t]/g, ' ');
      input = input.trim();
      
      return input;
    }
    
    /**
     * reCAPTCHA v3ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
     * @param {string} action - å®Ÿè¡Œã™ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®åå‰
     * @return {Promise<string>} reCAPTCHAãƒˆãƒ¼ã‚¯ãƒ³
     */
    async function getRecaptchaToken(action = 'form_submit') {
      try {
        const token = await grecaptcha.execute('6Le2lk4rAAAAAJu2ojJxoexvlUILZn4oNyJvuHzd', {action: action});
        return token;
      } catch (error) {
        console.error('reCAPTCHA ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        return null;
      }
    }
    
    /**
     * reCAPTCHA v3 ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã¨ã‚¹ã‚³ã‚¢åˆ¤å®š
     * @param {string} token - reCAPTCHAãƒˆãƒ¼ã‚¯ãƒ³
     * @return {boolean} æ¤œè¨¼é€šéã‹ã©ã†ã‹
     */
    async function validateRecaptchaV3(token) {
      if (!token) {
        console.warn('reCAPTCHA ãƒˆãƒ¼ã‚¯ãƒ³ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
        return false;
      }
      
      // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã®æ¤œè¨¼ãŒå¿…è¦ã§ã™ãŒã€
      // ã“ã“ã§ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®åŸºæœ¬ãƒã‚§ãƒƒã‚¯ã®ã¿å®Ÿè£…
      // å®Ÿéš›ã®æ¤œè¨¼ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ï¼ˆCode.gsï¼‰ã§è¡Œã„ã¾ã™
      return true;
    }
    
    /**
     * ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‰ã®åŒ…æ‹¬çš„ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
     * @param {FormData} formData - ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿
     * @return {Promise<Object>} ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµæœ
     */
    async function validateFormSecurity(formData) {
      const errors = [];
      
      // ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼åŒæ„ãƒã‚§ãƒƒã‚¯
      const privacyConsent = document.getElementById('privacy-consent').checked;
      if (!privacyConsent) {
        errors.push({ field: 'privacy-consent', message: 'ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã¸ã®åŒæ„ãŒå¿…è¦ã§ã™' });
      }
      
      // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
      if (!checkRateLimit()) {
        errors.push({ field: 'rate-limit', message: 'çŸ­æ™‚é–“å†…ã®é€£ç¶šé€ä¿¡ã§ã™' });
      }
      
      // reCAPTCHAæ¤œè¨¼
      if (typeof grecaptcha !== 'undefined') {
        const token = await getRecaptchaToken();
        if (!await validateRecaptchaV3(token)) {
          errors.push({ field: 'recaptcha', message: 'reCAPTCHAèªè¨¼ãŒå¿…è¦ã§ã™' });
        }
      }
      
      // å…¥åŠ›å€¤ã®é•·ã•ãƒã‚§ãƒƒã‚¯ï¼ˆDoSæ”»æ’ƒå¯¾ç­–ï¼‰
      const maxLengths = {
        name: 100,
        phone: 20,
        email: 254,
        note: 1000
      };
      
      Object.keys(maxLengths).forEach(field => {
        const value = formData.get(field);
        if (value && value.length > maxLengths[field]) {
          errors.push({ field: field, message: `å…¥åŠ›ãŒé•·ã™ãã¾ã™ï¼ˆæœ€å¤§${maxLengths[field]}æ–‡å­—ï¼‰` });
        }
      });
      
      return { isValid: errors.length === 0, errors: errors };
    }
    
    /**
     * ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®äº‹å‰å‡¦ç†ï¼ˆã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼‰
     * @param {Object} data - é€ä¿¡ãƒ‡ãƒ¼ã‚¿
     * @return {Object} ã‚µãƒ‹ã‚¿ã‚¤ã‚ºå¾Œã®ãƒ‡ãƒ¼ã‚¿
     */
    async function preprocessFormData(data) {
      const processedData = { ...data };
      
      // æ–‡å­—åˆ—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚º
      ['name', 'phone', 'email', 'store', 'note'].forEach(field => {
        if (processedData[field]) {
          processedData[field] = sanitizeInput(processedData[field]);
        }
      });
      
      // å•†å“ãƒ‡ãƒ¼ã‚¿ã‚‚ã‚µãƒ‹ã‚¿ã‚¤ã‚º
      if (processedData.items && Array.isArray(processedData.items)) {
        processedData.items = processedData.items.map(item => ({
          name: sanitizeInput(item.name || ''),
          qty: parseInt(item.qty) || 0
        }));
      }
      
      // reCAPTCHA ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿½åŠ 
      if (typeof grecaptcha !== 'undefined') {
        processedData.recaptchaResponse = await getRecaptchaToken();
      }
      
      return processedData;
    }

    // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã€Œç”»é¢ã‚’é–‰ã˜ã‚‹ã€ãƒœã‚¿ãƒ³
    document.getElementById('modal-close-btn').onclick = function(){
      document.getElementById('custom-modal').style.display = 'none';
      document.getElementById('final-message').style.display = 'block';
      document.getElementById('final-message').innerHTML = 'ã”äºˆç´„ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚<br>ã“ã®ç”»é¢ã¯é–‰ã˜ã¦ãã ã•ã„ã€‚';
      // ãã‚Œä»¥ä¸Šã®æ“ä½œãŒã§ããªã„ã‚ˆã†ã«ãƒ•ã‚©ãƒ¼ãƒ ãƒ»ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
      document.getElementById('reserveForm').style.display = 'none';
      document.getElementById('close-btn-area').style.display = 'none';
    };

    /**
     * GAS Webã‚¢ãƒ—ãƒªURLã®æ¥ç¶šãƒ†ã‚¹ãƒˆ
     */
    async function testGasConnection() {
      console.log('=== GASæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
      
      return new Promise((resolve) => {
        const callbackName = 'testCallback' + Date.now();
        const timeoutDuration = 10000; // 10ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
        
        // ãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
        window[callbackName] = function(result) {
          console.log('GASæ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ:', result);
          cleanup();
          resolve({ success: true, result });
        };
        
        // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°
        const cleanup = () => {
          const script = document.querySelector(`script[data-test-callback="${callbackName}"]`);
          if (script && script.parentNode) {
            script.parentNode.removeChild(script);
          }
          if (window[callbackName]) {
            delete window[callbackName];
          }
        };
        
        // ãƒ†ã‚¹ãƒˆç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°
        const script = document.createElement('script');
        const testUrl = `${GAS_WEB_APP_URL}?action=test&callback=${callbackName}&_t=${Date.now()}`;
        script.src = testUrl;
        script.setAttribute('data-test-callback', callbackName);
        
        script.onerror = function(error) {
          console.error('GASæ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—:', error);
          console.error('ãƒ†ã‚¹ãƒˆURL:', testUrl);
          cleanup();
          resolve({ success: false, error: 'ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼' });
        };
        
        script.onload = function() {
          console.log('GASãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†');
        };
        
        document.head.appendChild(script);
        
        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
        setTimeout(() => {
          if (window[callbackName]) {
            console.warn('GASæ¥ç¶šãƒ†ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ');
            cleanup();
            resolve({ success: false, error: 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ' });
          }
        }, timeoutDuration);
      });
    }

  </script>
</body>
</html>
