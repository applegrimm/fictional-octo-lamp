<!--
  @file admin.html
  @brief 店舗・商品情報管理画面
  @details スプレッドシート風UIで店舗・商品データを編集し、JSONファイルを生成・更新
  @author AI Assistant
  @date 2024-12-20
-->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>店舗・商品情報管理画面</title>
  
  <style>
    /* =============================
       パスワード認証画面
    ============================= */
    .auth-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .auth-container {
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      text-align: center;
      max-width: 400px;
      width: 90%;
    }
    
    .auth-title {
      font-size: 1.8rem;
      color: #333;
      margin-bottom: 10px;
      font-weight: 600;
    }
    
    .auth-subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 1rem;
    }
    
    .auth-input {
      width: 100%;
      padding: 15px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 1.1rem;
      margin-bottom: 20px;
      transition: border-color 0.3s ease;
      box-sizing: border-box;
    }
    
    .auth-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .auth-button {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    
    .auth-button:hover {
      transform: translateY(-2px);
    }
    
    .auth-error {
      color: #dc3545;
      margin-top: 15px;
      font-size: 0.9rem;
      display: none;
    }
    
    .auth-attempts {
      color: #ffc107;
      margin-top: 10px;
      font-size: 0.85rem;
      display: none;
    }
    
    .auth-locked {
      color: #dc3545;
      margin-top: 15px;
      font-size: 0.9rem;
      display: none;
    }
    
    .main-content {
      display: none;
    }
    
    .main-content.authenticated {
      display: block;
    }
    
    /* =============================
       基本レイアウト
    ============================= */
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', 'Meiryo', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      text-align: center;
    }
    
    .header h1 {
      margin: 0;
      font-size: 2rem;
      font-weight: 600;
    }
    
    .header p {
      margin: 10px 0 0 0;
      opacity: 0.9;
      font-size: 1.1rem;
    }
    
    /* =============================
       タブナビゲーション
    ============================= */
    .tab-nav {
      background: #fff;
      border-bottom: 2px solid #e9ecef;
      display: flex;
      padding: 0 30px;
    }
    
    .tab-btn {
      background: none;
      border: none;
      padding: 15px 25px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      color: #6c757d;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }
    
    .tab-btn:hover {
      color: #495057;
      background-color: #f8f9fa;
    }
    
    .tab-btn.active {
      color: #667eea;
      border-bottom-color: #667eea;
      background-color: #f8f9fa;
    }
    
    /* =============================
       コンテンツエリア
    ============================= */
    .content {
      padding: 30px;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* =============================
       コントロールバー
    ============================= */
    .controls {
      margin-bottom: 25px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
      justify-content: space-between;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }
    
    .controls-left {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .controls-right {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 500;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5a6fd8;
      transform: translateY(-1px);
    }
    
    .btn-success {
      background: #28a745;
      color: white;
    }
    
    .btn-success:hover {
      background: #218838;
      transform: translateY(-1px);
    }
    
    .btn-warning {
      background: #ffc107;
      color: #212529;
    }
    
    .btn-warning:hover {
      background: #e0a800;
      transform: translateY(-1px);
    }
    
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    
    .btn-danger:hover {
      background: #c82333;
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-1px);
    }
    
    /* =============================
       ファイルアップロード
    ============================= */
    .file-upload {
      position: relative;
      display: inline-block;
      overflow: hidden;
    }
    
    .file-upload input[type="file"] {
      position: absolute;
      left: -9999px;
    }
    
    .file-upload label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: #6c757d;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .file-upload label:hover {
      background: #5a6268;
      transform: translateY(-1px);
    }
    
    /* =============================
       テーブルスタイル
    ============================= */
    .table-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow-x: auto;
      overflow-y: hidden;
      /* スクロールバーのスタイル改善 */
      scrollbar-width: thin;
      scrollbar-color: #667eea #f1f1f1;
      position: relative;
    }
    
    /* 上部スクロールバー用のコンテナ */
    .top-scrollbar {
      width: 100%;
      height: 12px;
      overflow-x: auto;
      overflow-y: hidden;
      background: #f1f1f1;
      border-radius: 6px 6px 0 0;
      margin-bottom: 0;
      scrollbar-width: thin;
      scrollbar-color: #667eea #f1f1f1;
    }
    
    .top-scrollbar::-webkit-scrollbar {
      height: 12px;
    }
    
    .top-scrollbar::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 6px;
    }
    
    .top-scrollbar::-webkit-scrollbar-thumb {
      background: #667eea;
      border-radius: 6px;
      border: 2px solid #f1f1f1;
    }
    
    .top-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #5a6fd8;
    }
    
    /* Webkit系ブラウザのスクロールバー */
    .table-container::-webkit-scrollbar {
      height: 12px;
      width: 12px;
    }
    
    .table-container::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 6px;
    }
    
    .table-container::-webkit-scrollbar-thumb {
      background: #667eea;
      border-radius: 6px;
      border: 2px solid #f1f1f1;
    }
    
    .table-container::-webkit-scrollbar-thumb:hover {
      background: #5a6fd8;
    }
    
    /* スクロールバーを常に表示 */
    .table-container {
      scrollbar-gutter: stable;
    }
    
    
    .data-table {
      width: 100%;
      min-width: 2200px; /* テーブルの最小幅を設定（より確実にスクロールを発生させる） */
      border-collapse: collapse;
      font-size: 0.9rem;
      table-layout: fixed; /* 固定レイアウトで幅を確実に適用 */
    }
    
    .data-table th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 12px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #5a6fd8;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .data-table td {
      padding: 12px;
      border-bottom: 1px solid #e9ecef;
      vertical-align: top;
    }
    
    .data-table tbody tr:hover {
      background-color: #f8f9fa;
    }
    
    .data-table tbody tr:nth-child(even) {
      background-color: #fdfdfd;
    }
    
    .data-table tbody tr:nth-child(even):hover {
      background-color: #f1f3f4;
    }
    
    /* =============================
       入力フィールド
    ============================= */
    .data-table input,
    .data-table select,
    .data-table textarea {
      width: 100%;
      border: 1px solid #ced4da;
      border-radius: 4px;
      padding: 8px;
      font-size: 0.9rem;
      transition: border-color 0.3s ease;
      min-width: 0; /* フレックスボックスでの縮小を許可 */
    }
    
    .data-table input:focus,
    .data-table select:focus,
    .data-table textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
    }
    
    .data-table input[type="number"] {
      text-align: right;
    }
    
    .data-table textarea {
      min-height: 80px;
      resize: vertical;
      font-family: inherit; /* フォントを統一 */
    }
    
    /* 複数選択selectのスタイル */
    .data-table select[multiple] {
      min-height: 80px;
      padding: 4px;
    }
    
    .data-table select[multiple] option {
      padding: 4px 8px;
      margin: 2px 0;
    }
    
    /* =============================
       営業時間設定
    ============================= */
    .hours-input {
      display: flex;
      flex-direction: column;
      gap: 5px;
      min-width: 200px;
    }
    
    .hours-row {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.8rem;
    }
    
    .hours-row input[type="time"] {
      width: 70px;
      font-size: 0.8rem;
      padding: 4px;
    }
    
    .hours-row input[type="checkbox"] {
      width: auto;
    }
    
    .hours-row label {
      min-width: 30px;
      font-size: 0.8rem;
    }
    
    /* =============================
       アクションボタン
    ============================= */
    .action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      margin: 2px;
      transition: all 0.3s ease;
    }
    
    .action-btn:hover {
      transform: translateY(-1px);
    }
    
    .btn-add {
      background: #28a745;
      color: white;
    }
    
    .btn-add:hover {
      background: #218838;
    }
    
    .btn-remove {
      background: #dc3545;
      color: white;
    }
    
    .btn-remove:hover {
      background: #c82333;
    }
    
    /* =============================
       メッセージ表示
    ============================= */
    .message {
      padding: 15px 20px;
      margin: 20px 0;
      border-radius: 6px;
      border-left: 4px solid;
      font-weight: 500;
    }
    
    .message-success {
      background-color: #d4edda;
      border-color: #28a745;
      color: #155724;
    }
    
    .message-error {
      background-color: #f8d7da;
      border-color: #dc3545;
      color: #721c24;
    }
    
    .message-info {
      background-color: #d1ecf1;
      border-color: #17a2b8;
      color: #0c5460;
    }
    
    /* =============================
       レスポンシブ対応
    ============================= */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .header {
        padding: 15px 20px;
      }
      
      .header h1 {
        font-size: 1.5rem;
      }
      
      .content {
        padding: 20px 15px;
      }
      
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .controls-left,
      .controls-right {
        justify-content: center;
      }
      
      .data-table {
        font-size: 0.8rem;
      }
      
      .data-table th,
      .data-table td {
        padding: 8px 6px;
      }
      
      /* 宅配関連フィールドのモバイル対応 */
      .data-table th:nth-child(n+8),
      .data-table td:nth-child(n+8) {
        min-width: 100px;
      }
      
      /* 重要なフィールドの最小幅を確保 */
      .data-table th:nth-child(2), /* 商品名 */
      .data-table td:nth-child(2) {
        min-width: 200px;
      }
      
      .data-table th:nth-child(7), /* 説明 */
      .data-table td:nth-child(7) {
        min-width: 250px;
      }
      
      .hours-input {
        min-width: 150px;
      }
    }
    
    /* =============================
       プログレスバー
    ============================= */
    .progress-container {
      width: 100%;
      height: 4px;
      background-color: #e9ecef;
      border-radius: 2px;
      overflow: hidden;
      margin: 10px 0;
    }
    
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    /* =============================
       隠し要素
    ============================= */
    .hidden {
      display: none !important;
    }
    
    /* =============================
       ローディング状態
    ============================= */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ヘッダー -->
    <div class="header">
      <h1>🏪 店舗・商品情報管理システム</h1>
      <p>スプレッドシート風エディタで店舗・商品データを編集し、JSONファイルを生成</p>
    </div>
  
  <!-- パスワード認証画面 -->
  <div id="auth-overlay" class="auth-overlay">
    <div class="auth-container">
      <div class="auth-title">🔐 管理者認証</div>
      <div class="auth-subtitle">管理画面にアクセスするにはパスワードを入力してください</div>
      
      <form id="auth-form" onsubmit="handleAuthentication(event)">
        <input type="password" 
               id="auth-password" 
               class="auth-input" 
               placeholder="パスワードを入力"
               autocomplete="current-password"
               required>
        
        <button type="submit" class="auth-button">
          🚀 ログイン
        </button>
      </form>
      
      <div id="auth-error" class="auth-error">
        ❌ パスワードが間違っています
      </div>
      
      <div id="auth-attempts" class="auth-attempts">
        ⚠️ 残り試行回数: <span id="attempts-count">3</span>回
      </div>
      
      <div id="auth-locked" class="auth-locked">
        🔒 アクセスがロックされました。5分後に再試行してください。
      </div>
      
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e9ecef;">
        <small style="color: #999;">
          セキュリティ保護された管理画面<br>
          不正アクセスは記録されます
        </small>
      </div>
    </div>
  </div>
  
  <!-- メインコンテンツ -->
  <div id="main-content" class="main-content">
    <div class="container">
    <!-- タブナビゲーション -->
    <div class="tab-nav">
      <button class="tab-btn active" onclick="switchTab('stores')">
        🏢 店舗管理
      </button>
      <button class="tab-btn" onclick="switchTab('products')">
        🛍️ 商品管理
      </button>
      <button class="tab-btn" onclick="switchTab('github')">
        🚀 GitHub連携
      </button>
    </div>
    
    <!-- メッセージ表示エリア -->
    <div id="message-area"></div>
    
    <!-- 店舗管理タブ -->
    <div id="stores-tab" class="tab-content active">
      <div class="content">
        <div class="controls">
          <div class="controls-left">
            <h2 style="margin: 0; color: #495057;">🏢 店舗情報管理</h2>
          </div>
          <div class="controls-right">
            <div class="file-upload">
              <input type="file" id="stores-file-input" accept=".json" onchange="loadStoresFromFile(event)">
              <label for="stores-file-input">
                📁 stores.jsonを読み込み
              </label>
            </div>
            <button class="btn btn-primary" onclick="addStoreRow()">
              ➕ 店舗を追加
            </button>
            <button class="btn btn-success" onclick="pushToGitHub('stores')">
              📤 GitHubへアップロード
            </button>
            <button class="btn btn-secondary" onclick="generateStoresJson()">
              💾 ローカルに保存
            </button>
          </div>
        </div>
        
        <!-- 上部スクロールバー -->
        <div class="top-scrollbar" id="stores-top-scrollbar">
          <div style="width: 2200px; height: 1px;"></div>
        </div>
        
        <div class="table-container" id="stores-table-container">
          <table class="data-table" id="stores-table">
            <thead>
              <tr>
                <th style="width: 80px;">ID</th>
                <th style="width: 200px;">店舗名</th>
                <th style="width: 120px;">グループ</th>
                <th style="width: 120px;">カテゴリ</th>
                <th style="width: 150px;">管理シークレット</th>
                <th style="width: 500px;">営業時間</th>
                <th style="width: 200px;">休業日</th>
                <th style="width: 100px;">操作</th>
              </tr>
            </thead>
            <tbody id="stores-tbody">
              <!-- 店舗データが動的に追加される -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- 商品管理タブ -->
    <div id="products-tab" class="tab-content">
      <div class="content">
        <div class="controls">
          <div class="controls-left">
            <h2 style="margin: 0; color: #495057;">🛍️ 商品情報管理</h2>
          </div>
          <div class="controls-right">
            <div class="file-upload">
              <input type="file" id="products-file-input" accept=".json" onchange="loadProductsFromFile(event)">
              <label for="products-file-input">
                📁 products.jsonを読み込み
              </label>
            </div>
            <button class="btn btn-primary" onclick="addProductRow()">
              ➕ 商品を追加
            </button>
            <button class="btn btn-success" onclick="pushToGitHub('products')">
              📤 GitHubへアップロード
            </button>
            <button class="btn btn-secondary" onclick="generateProductsJson()">
              💾 ローカルに保存
            </button>
            <button class="btn btn-warning" onclick="toggleProductFilter()" id="filter-btn">
              🔍 非表示商品を隠す
            </button>
          </div>
        </div>
        
        <!-- 上部スクロールバー -->
        <div class="top-scrollbar" id="products-top-scrollbar">
          <div style="width: 3000px; height: 1px;"></div>
        </div>
        
        <div class="table-container" id="products-table-container">
          <table class="data-table" id="products-table">
            <thead>
              <tr>
                <th style="width: 100px;">ID</th>
                <th style="width: 300px;">商品名</th>
                <th style="width: 120px;">価格（円）</th>
                <th style="width: 120px;">最小日数</th>
                <th style="width: 120px;">締切時間</th>
                <th style="width: 140px;">日数タイプ</th>
                <th style="width: 200px;">受取日範囲指定</th>
                <th style="width: 200px;">配送日範囲指定</th>
                <th style="width: 200px;">販売期間指定</th>
                <th style="width: 400px;">説明</th>
                <th style="width: 260px;">画像URL/アップロード</th>
                <th style="width: 140px;">宅配対応</th>
                <th style="width: 120px;">宅配日数</th>
                <th style="width: 120px;">宅配締切</th>
                <th style="width: 200px;">配送時間帯</th>
                <th style="width: 120px;">配送重量</th>
                <th style="width: 120px;">配送サイズ</th>
                <th style="width: 120px;">冷凍配送</th>
                <th style="width: 140px;">配送エリア</th>
                <th style="width: 120px;">熨斗対応</th>
                <th style="width: 300px;">熨斗オプション</th>
                <th style="width: 100px;">表示</th>
                <th style="width: 120px;">操作</th>
              </tr>
            </thead>
            <tbody id="products-tbody">
              <!-- 商品データが動的に追加される -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- GitHub連携タブ -->
    <div id="github-tab" class="tab-content">
      <div class="content">
        <div class="controls">
          <div class="controls-left">
            <h2 style="margin: 0; color: #495057;">🚀 GitHub連携設定</h2>
          </div>
          <div class="controls-right">
            <button class="btn btn-warning" onclick="testGitHubConnection()">
              🔧 接続テスト
            </button>
            <button class="btn btn-success" onclick="pushToGitHub('all')">
              📤 全てをGitHubにプッシュ
            </button>
            <button class="btn btn-info" onclick="clearCache()" style="margin-left: 10px;">
              🗑️ キャッシュクリア
            </button>
            <button class="btn btn-danger" onclick="logout()" style="margin-left: 15px;">
              🚪 ログアウト
            </button>
          </div>
        </div>

        <!-- Stripeモード切替ブロック -->
        <div class="table-container" style="margin-top: 20px;">
          <div style="padding: 20px;">
            <h3>💳 Stripe決済モード切替</h3>
            <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap; margin-bottom: 12px;">
              <div>
                <span style="font-weight: 600; margin-right: 8px;">現在のモード:</span>
                <span id="stripe-mode-display" style="font-size: 1.1rem; font-weight: 700; color: #667eea;">読み込み中...</span>
              </div>
              <div style="display: flex; gap: 10px;">
                <button id="stripe-test-btn" class="btn btn-warning" type="button" onclick="switchToTestMode()">🧪 テストモードに切替</button>
                <button id="stripe-live-btn" class="btn btn-danger" type="button" onclick="switchToLiveMode()">🚀 本番モードに切替</button>
              </div>
            </div>
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 12px;">
              <div style="color: #856404; font-weight: 600; margin-bottom: 6px;">⚠️ 注意事項</div>
              <ul style="color: #856404; margin: 0 0 6px 18px;">
                <li>テストモード: 実際の課金は発生しません（テストカードをご利用ください）</li>
                <li>本番モード: 実際の課金が発生します。切替時は確認ダイアログが表示されます</li>
                <li>この設定はブラウザのlocalStorageに保存されます（ブラウザ単位）</li>
              </ul>
              <div style="display:flex; gap: 8px; flex-wrap: wrap;">
                <button class="btn btn-info" type="button" onclick="checkStripeMode()">🔍 現在の設定を確認</button>
                <button class="btn btn-secondary" type="button" onclick="resetStripeMode()">🔄 設定をリセット（TESTに戻す）</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- GitHub設定フォーム -->
        <div class="table-container">
          <div style="padding: 20px;">
            <h3>🔑 GitHub認証設定</h3>
            <div style="margin-bottom: 20px;">
              <label for="github-token" style="display: block; font-weight: bold; margin-bottom: 8px;">
                Personal Access Token:
              </label>
              <input type="password" id="github-token" 
                     placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" 
                     style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
              <small style="color: #666; display: block; margin-top: 5px;">
                GitHub → Settings → Developer settings → Personal access tokens → Generate new token (classic)<br>
                必要なスコープ: <code>repo</code> (Full control of private repositories)<br>
                <strong>注意:</strong> 新しいトークン形式（ghp_で始まる）を使用してください
              </small>
            </div>
            
            <h3>📁 リポジトリ設定</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
              <div>
                <label for="github-owner" style="display: block; font-weight: bold; margin-bottom: 8px;">
                  Owner (ユーザー名/組織名):
                </label>
                <input type="text" id="github-owner" 
                       placeholder="your-username" 
                       style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
              </div>
              <div>
                <label for="github-repo" style="display: block; font-weight: bold; margin-bottom: 8px;">
                  Repository名:
                </label>
                <input type="text" id="github-repo" 
                       placeholder="your-repo-name" 
                       style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
              <div>
                <label for="github-branch" style="display: block; font-weight: bold; margin-bottom: 8px;">
                  ブランチ名:
                </label>
                <input type="text" id="github-branch" 
                       placeholder="main" 
                       value="main"
                       style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
              </div>
              <div>
                <label for="github-path" style="display: block; font-weight: bold; margin-bottom: 8px;">
                  ファイルパス（省略可）:
                </label>
                <input type="text" id="github-path" 
                       placeholder="例: data/" 
                       style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                <small style="color: #666; display: block; margin-top: 5px;">
                  空欄の場合はルートディレクトリに保存
                </small>
              </div>
            </div>
            
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 15px; margin-bottom: 20px;">
              <h4 style="margin-top: 0; color: #856404;">🔒 セキュリティ情報</h4>
              <ul style="margin-bottom: 0; color: #856404;">
                <li>Personal Access Tokenは暗号化してブラウザに保存されます</li>
                <li>トークンは他のユーザーと共有しないでください</li>
                <li>不要になったトークンはGitHub設定から削除してください</li>
                <li>このページをHTTPSで使用することを強く推奨します</li>
              </ul>
            </div>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <button class="btn btn-primary" onclick="saveGitHubConfig()">
                💾 設定を保存
              </button>
              <button class="btn btn-secondary" onclick="loadGitHubConfig()">
                📂 保存済み設定を読み込み
              </button>
              <button class="btn btn-danger" onclick="clearGitHubConfig()">
                🗑️ 設定をクリア
              </button>
            </div>
            
            <h3>📤 個別プッシュ</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <button class="btn btn-success" onclick="pushToGitHub('stores')">
                🏢 stores.jsonをプッシュ
              </button>
              <button class="btn btn-success" onclick="pushToGitHub('products')">
                🛍️ products.jsonをプッシュ
              </button>
              <button class="btn btn-warning" onclick="pushToGitHub('admin')">
                🔧 admin.htmlをプッシュ
              </button>
            </div>
            
            <h3>🔑 パスワード変更</h3>
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 15px; margin-bottom: 20px;">
              <h4 style="margin-top: 0; color: #856404;">パスワード変更機能</h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                <div>
                  <label for="current-password" style="display: block; font-weight: bold; margin-bottom: 8px;">
                    現在のパスワード:
                  </label>
                  <input type="password" id="current-password" 
                         placeholder="現在のパスワードを入力" 
                         style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div>
                  <label for="new-password" style="display: block; font-weight: bold; margin-bottom: 8px;">
                    新しいパスワード:
                  </label>
                  <input type="password" id="new-password" 
                         placeholder="新しいパスワードを入力" 
                         style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
              </div>
              <div style="margin-bottom: 15px;">
                <label for="confirm-password" style="display: block; font-weight: bold; margin-bottom: 8px;">
                  新しいパスワード（確認）:
                </label>
                <input type="password" id="confirm-password" 
                       placeholder="新しいパスワードを再入力" 
                       style="width: 50%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
              </div>
              <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-warning" onclick="changePassword()">
                  🔑 パスワードを変更
                </button>
                <button class="btn btn-success" onclick="pushUpdatedAdminToGitHub()">
                  📤 新しいadmin.htmlをGitHubにプッシュ
                </button>
                <button class="btn btn-secondary" onclick="downloadUpdatedAdminFile()">
                  📥 ローカルにダウンロード
                </button>
              </div>
              <small style="color: #856404; display: block; margin-top: 10px;">
                ⚠️ パスワード変更後は、「GitHubにプッシュ」または「ローカルにダウンロード」してファイルを更新してください
              </small>
            </div>
          </div>
        </div>
        
        <!-- GitHub操作ログ -->
        <div class="table-container" style="margin-top: 20px;">
          <div style="padding: 20px;">
            <h3>📋 操作ログ</h3>
            <div id="github-log" style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 15px; min-height: 200px; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.9em; white-space: pre-wrap;"></div>
            <button class="btn btn-secondary" onclick="clearGitHubLog()" style="margin-top: 10px;">
              🗑️ ログをクリア
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // =============================
  // グローバル変数
  // =============================
  let storesData = [];
  let productsData = [];
  let showHiddenProducts = true; // 非表示商品も表示するかどうか
  
  // =============================
  // 初期化処理
  // =============================
  document.addEventListener('DOMContentLoaded', function() {
    console.log('店舗・商品管理画面を初期化しています...');
    
    // 既存のJSONファイルを読み込み
    loadExistingData();
    
    // 上部スクロールバーの初期化
    initializeDualScrollbars();
    
    // StripeモードUI初期化
    try { updateModeButtons(); } catch (e) { console.warn('StripeモードUI初期化警告:', e); }
  });
  
  // =============================
  // タブ切り替え
  // =============================
  function switchTab(tabName) {
    // すべてのタブを非表示
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });
    
    // すべてのタブボタンを非アクティブ
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    
    // 選択されたタブを表示
    document.getElementById(tabName + '-tab').classList.add('active');
    event.target.classList.add('active');
    
  }
  
  // =============================
  // メッセージ表示
  // =============================
  function showMessage(text, type = 'info') {
    const messageArea = document.getElementById('message-area');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message message-${type}`;
    messageDiv.textContent = text;
    
    messageArea.innerHTML = '';
    messageArea.appendChild(messageDiv);
    
    // 5秒後に自動削除
    setTimeout(() => {
      if (messageDiv.parentNode) {
        messageDiv.parentNode.removeChild(messageDiv);
      }
    }, 5000);
  }
  
  // =============================
  // 既存データの読み込み
  // =============================
  async function loadExistingData() {
    try {
      showMessage('既存データを読み込んでいます...', 'info');
      
      // キャッシュバスター（タイムスタンプ）を追加
      const timestamp = Date.now();
      
      // stores.jsonを読み込み
      try {
        const storesResponse = await fetch(`./stores.json?v=${timestamp}`);
        if (storesResponse.ok) {
          storesData = await storesResponse.json();
          console.log('店舗データ読み込み成功:', storesData.length + '件');
        }
      } catch (error) {
        console.warn('stores.jsonの読み込みに失敗:', error);
      }
      
      // products.jsonを読み込み
      try {
        const productsResponse = await fetch(`./products.json?v=${timestamp}`);
        if (productsResponse.ok) {
          productsData = await productsResponse.json();
          console.log('商品データ読み込み成功:', productsData.length + '件');
        }
      } catch (error) {
        console.warn('products.jsonの読み込みに失敗:', error);
      }
      
      // テーブルを更新
      updateStoresTable();
      updateProductsTable();
      
      showMessage(`データの読み込みが完了しました（店舗:${storesData.length}件、商品:${productsData.length}件）`, 'success');
      
    } catch (error) {
      console.error('データ読み込みエラー:', error);
      showMessage('データの読み込み中にエラーが発生しました: ' + error.message, 'error');
    }
  }
  
  // =============================
  // 店舗管理機能
  // =============================
  
  /**
   * 店舗テーブルを更新
   */
  function updateStoresTable() {
    const tbody = document.getElementById('stores-tbody');
    tbody.innerHTML = '';
    
    storesData.forEach((store, index) => {
      const row = createStoreRow(store, index);
      tbody.appendChild(row);
    });
    
    // 店舗がない場合は初期行を追加
    if (storesData.length === 0) {
      addStoreRow();
    }
    
  }
  
  /**
   * 店舗行を作成
   */
  function createStoreRow(store, index) {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>
        <input type="text" value="${store.id || ''}" 
               onchange="updateStoreData(${index}, 'id', this.value)"
               placeholder="例: b1">
      </td>
      <td>
        <input type="text" value="${store.name || ''}" 
               onchange="updateStoreData(${index}, 'name', this.value)"
               placeholder="店舗名を入力">
      </td>
      <td>
        <select onchange="updateStoreData(${index}, 'group', this.value)" 
                style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 4px;">
          <option value="">グループを選択</option>
          <option value="burns" ${store.group === 'burns' ? 'selected' : ''}>焼肉バーンズ</option>
          <option value="kirabi" ${store.group === 'kirabi' ? 'selected' : ''}>カルビ牧場</option>
          <option value="applegrimm" ${store.group === 'applegrimm' ? 'selected' : ''}>あっぷるぐりむ</option>
          <option value="pizzeria" ${store.group === 'pizzeria' ? 'selected' : ''}>ピッツェリア</option>
          <option value="kirabi_single" ${store.group === 'kirabi_single' ? 'selected' : ''}>きらび</option>
          <option value="marutomi" ${store.group === 'marutomi' ? 'selected' : ''}>まるとみ</option>
        </select>
      </td>
      <td>
        <input type="text" value="${store.category || ''}" 
               onchange="updateStoreData(${index}, 'category', this.value)"
               placeholder="例: 焼肉">
      </td>
      <td>
        <input type="text" value="${store.managementSecret || ''}" 
               onchange="updateStoreData(${index}, 'managementSecret', this.value)"
               placeholder="管理用シークレット">
      </td>
      <td>
        ${createHoursInput(store.hours || {}, index)}
      </td>
      <td>
        <textarea onchange="updateStoreData(${index}, 'unavailable_dates', this.value.split(',').map(d => d.trim()).filter(d => d))"
                  placeholder="YYYY-MM-DD,YYYY-MM-DD">${(store.unavailable_dates || []).join(',')}</textarea>
      </td>
      <td>
        <button class="action-btn btn-remove" onclick="removeStoreRow(${index})">削除</button>
      </td>
    `;
    return row;
  }
  
  /**
   * 営業時間入力フィールドを作成
   */
  function createHoursInput(hours, storeIndex) {
    const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
    const dayNames = ['月', '火', '水', '木', '金', '土', '日'];
    
    let html = '<div class="hours-input">';
    
    days.forEach((day, dayIndex) => {
      const dayHours = hours[day];
      const isClosed = dayHours === null;
      const isMultipleSlots = Array.isArray(dayHours) && Array.isArray(dayHours[0]);
      
      html += `<div class="hours-row">
        <label>${dayNames[dayIndex]}:</label>
        <input type="checkbox" ${isClosed ? '' : 'checked'} 
               onchange="toggleStoreDay(${storeIndex}, '${day}', this.checked)">
        <span>営業</span>`;
      
      if (!isClosed) {
        if (isMultipleSlots) {
          // 複数営業時間帯
          dayHours.forEach((slot, slotIndex) => {
            html += `
              <input type="time" value="${slot[0] || ''}" 
                     onchange="updateStoreHours(${storeIndex}, '${day}', ${slotIndex}, 0, this.value)">
              <span>-</span>
              <input type="time" value="${slot[1] || ''}" 
                     onchange="updateStoreHours(${storeIndex}, '${day}', ${slotIndex}, 1, this.value)">`;
          });
          html += `<button type="button" class="action-btn btn-add" 
                          onclick="addStoreTimeSlot(${storeIndex}, '${day}')">+</button>`;
        } else {
          // 単一営業時間帯
          const startTime = Array.isArray(dayHours) ? dayHours[0] : '';
          const endTime = Array.isArray(dayHours) ? dayHours[1] : '';
          html += `
            <input type="time" value="${startTime}" 
                   onchange="updateStoreHours(${storeIndex}, '${day}', null, 0, this.value)">
            <span>-</span>
            <input type="time" value="${endTime}" 
                   onchange="updateStoreHours(${storeIndex}, '${day}', null, 1, this.value)">
            <button type="button" class="action-btn btn-add" 
                    onclick="addStoreTimeSlot(${storeIndex}, '${day}')">複数時間帯</button>`;
        }
      }
      
      html += '</div>';
    });
    
    html += '</div>';
    return html;
  }
  
  /**
   * 店舗データを更新
   */
  function updateStoreData(index, field, value) {
    if (!storesData[index]) {
      storesData[index] = {};
    }
    storesData[index][field] = value;
    
    // グループ選択時にgroupNameを自動設定
    if (field === 'group') {
      const groupNames = {
        'burns': '焼肉バーンズ',
        'kirabi': 'カルビ牧場',
        'applegrimm': 'あっぷるぐりむ',
        'pizzeria': 'ピッツェリア',
        'kirabi_single': 'きらび',
        'marutomi': 'まるとみ'
      };
      
      if (groupNames[value]) {
        storesData[index]['groupName'] = groupNames[value];
        // カテゴリも自動設定
        const categories = {
          'burns': '焼肉',
          'kirabi': '焼肉・韓国料理',
          'applegrimm': 'スイーツ・カフェ',
          'pizzeria': 'ピザ・イタリアン',
          'kirabi': 'スイーツ・カフェ'
        };
        if (categories[value]) {
          storesData[index]['category'] = categories[value];
        }
        
        // テーブルを更新して新しい値を反映
        updateStoresTable();
      }
    }
    
    console.log(`店舗[${index}]の${field}を更新:`, value);
  }
  
  /**
   * 店舗営業日の切り替え
   */
  function toggleStoreDay(storeIndex, day, isOpen) {
    if (!storesData[storeIndex]) {
      storesData[storeIndex] = {};
    }
    if (!storesData[storeIndex].hours) {
      storesData[storeIndex].hours = {};
    }
    
    if (isOpen) {
      storesData[storeIndex].hours[day] = ['09:00', '18:00'];
    } else {
      storesData[storeIndex].hours[day] = null;
    }
    
    updateStoresTable();
  }
  
  /**
   * 店舗営業時間を更新
   */
  function updateStoreHours(storeIndex, day, slotIndex, timeIndex, value) {
    if (!storesData[storeIndex] || !storesData[storeIndex].hours) {
      return;
    }
    
    const dayHours = storesData[storeIndex].hours[day];
    
    if (slotIndex === null) {
      // 単一営業時間帯
      if (!Array.isArray(dayHours)) {
        storesData[storeIndex].hours[day] = ['', ''];
      }
      storesData[storeIndex].hours[day][timeIndex] = value;
    } else {
      // 複数営業時間帯
      if (!Array.isArray(dayHours) || !Array.isArray(dayHours[slotIndex])) {
        return;
      }
      storesData[storeIndex].hours[day][slotIndex][timeIndex] = value;
    }
    
    console.log(`店舗[${storeIndex}]の${day}営業時間を更新:`, storesData[storeIndex].hours[day]);
  }
  
  /**
   * 営業時間スロットを追加
   */
  function addStoreTimeSlot(storeIndex, day) {
    if (!storesData[storeIndex] || !storesData[storeIndex].hours) {
      return;
    }
    
    const dayHours = storesData[storeIndex].hours[day];
    
    if (Array.isArray(dayHours) && !Array.isArray(dayHours[0])) {
      // 単一→複数に変換
      storesData[storeIndex].hours[day] = [dayHours, ['', '']];
    } else if (Array.isArray(dayHours) && Array.isArray(dayHours[0])) {
      // 複数時間帯に追加
      storesData[storeIndex].hours[day].push(['', '']);
    }
    
    updateStoresTable();
  }
  
  /**
   * 店舗行を追加
   */
  function addStoreRow() {
    const newStore = {
      id: '',
      name: '',
      group: '',
      groupName: '',
      category: '',
      managementSecret: '',
      hours: {
        mon: ['09:00', '18:00'],
        tue: ['09:00', '18:00'],
        wed: ['09:00', '18:00'],
        thu: ['09:00', '18:00'],
        fri: ['09:00', '18:00'],
        sat: ['09:00', '18:00'],
        sun: null
      },
      unavailable_dates: []
    };
    
    storesData.push(newStore);
    updateStoresTable();
    showMessage('新しい店舗行を追加しました', 'success');
  }
  
  /**
   * 店舗行を削除
   */
  function removeStoreRow(index) {
    if (confirm('この店舗を削除しますか？')) {
      storesData.splice(index, 1);
      updateStoresTable();
      showMessage('店舗を削除しました', 'success');
    }
  }
  
  /**
   * ファイルから店舗データを読み込み
   */
  function loadStoresFromFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = JSON.parse(e.target.result);
        storesData = data;
        updateStoresTable();
        showMessage(`${storesData.length}件の店舗データを読み込みました`, 'success');
      } catch (error) {
        showMessage('JSONファイルの読み込みに失敗しました: ' + error.message, 'error');
      }
    };
    reader.readAsText(file);
  }
  
  /**
   * stores.jsonを生成・ダウンロード
   */
  function generateStoresJson() {
    try {
      // データの妥当性チェック
      const validStores = storesData.filter(store => store.id && store.name);
      
      if (validStores.length === 0) {
        showMessage('有効な店舗データがありません（IDと店舗名は必須です）', 'error');
        return;
      }
      
      const jsonString = JSON.stringify(validStores, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = 'stores.json';
      a.click();
      
      URL.revokeObjectURL(url);
      showMessage(`stores.json（${validStores.length}件）を生成しました`, 'success');
      
    } catch (error) {
      showMessage('stores.jsonの生成に失敗しました: ' + error.message, 'error');
    }
  }
  
  // =============================
  // 商品管理機能
  // =============================
  
  /**
   * 画像ファイルをGitHubにアップロードし、imageUrlを設定
   * @param {Event} event - input[type=file] のchangeイベント
   * @param {number} index - productsDataのインデックス
   */
  async function handleProductImageUpload(event, index) {
    try {
      const file = event.target.files && event.target.files[0];
      if (!file) {
        addGitHubLog('❌ ファイルが選択されていません');
        return;
      }
      
      addGitHubLog(`📤 画像アップロード開始: ${file.name} (${Math.round(file.size/1024)}KB)`);
      
      // 大きなファイルの警告
      if (file.size > 1024 * 1024) { // 1MB以上
        addGitHubLog(`⚠️ 大きなファイルです。Web表示用には1MB以下を推奨します。`);
      }
      
      const config = getGitHubConfig();
      if (!config) {
        showMessage('GitHub設定が未保存です。先に設定してください。', 'error');
        addGitHubLog('❌ GitHub設定が未保存');
        event.target.value = '';
        return;
      }
      
      // 拡張子と保存パス
      const ext = file.name.split('.').pop().toLowerCase();
      const product = productsData[index] || {};
      const id = (product.id || `p${index + 1}`).replace(/[^a-zA-Z0-9_-]/g, '');
      const fileName = `${id}.${ext}`;
      const imagesDir = config.path ? `${config.path}images/products/` : 'images/products/';
      const filePath = `${imagesDir}${fileName}`;
      
      addGitHubLog(`📤 画像をアップロード中... (${filePath})`);
      
      // ファイルサイズチェック（5MB制限に変更）
      if (file.size > 5 * 1024 * 1024) {
        throw new Error('ファイルサイズが大きすぎます（5MB以下にしてください）');
      }
      
      addGitHubLog(`   - Base64エンコード開始...`);
      
      // FileReader APIを使用した安全なBase64エンコード
      const base64Content = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function() {
          // data:image/jpeg;base64, の部分を除去
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = function() {
          reject(new Error('ファイル読み込みエラー'));
        };
        reader.readAsDataURL(file);
      });
      
      addGitHubLog(`   - Base64エンコード完了 (${Math.round(base64Content.length/1024)}KB)`);
      
      // GitHub APIの制限チェック（100MB制限）
      if (base64Content.length > 100 * 1024 * 1024) {
        throw new Error('Base64エンコード後のサイズが大きすぎます（100MB制限）');
      }
      
      // Base64の妥当性をチェック
      try {
        atob(base64Content.substring(0, 100)); // 最初の100文字をテスト
        addGitHubLog(`   - Base64妥当性チェック: OK`);
      } catch (e) {
        addGitHubLog(`   - Base64妥当性チェック: NG - ${e.message}`);
        throw new Error('Base64エンコードに失敗しました');
      }
      
      // 既存SHA取得
      let sha = null;
      try {
        addGitHubLog(`   - 既存ファイル確認中: ${filePath}`);
        const getResponse = await fetch(`https://api.github.com/repos/${config.owner}/${config.repo}/contents/${filePath}`, {
          headers: {
            'Authorization': `Bearer ${config.token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (getResponse.ok) {
          const info = await getResponse.json();
          sha = info.sha;
          addGitHubLog(`   - 既存画像を更新 (SHA: ${sha.substring(0,7)})`);
        } else if (getResponse.status === 404) {
          addGitHubLog('   - 新規画像を作成');
        } else {
          const errorText = await getResponse.text();
          addGitHubLog(`   - ファイル確認エラー: HTTP ${getResponse.status} - ${errorText}`);
          throw new Error(`画像情報取得エラー: HTTP ${getResponse.status}`);
        }
      } catch (e) {
        addGitHubLog(`   - 画像情報取得でエラー: ${e.message}`);
        // 404エラーの場合は続行
        if (!e.message.includes('404')) {
          throw e;
        }
      }
      
      const commitData = {
        message: `🖼️ Upload product image: ${fileName}`,
        content: base64Content,
        branch: config.branch
      };
      if (sha) commitData.sha = sha;
      
      addGitHubLog(`   - GitHub APIに送信中...`);
      const putResponse = await fetch(`https://api.github.com/repos/${config.owner}/${config.repo}/contents/${filePath}`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${config.token}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(commitData)
      });
      
      if (!putResponse.ok) {
        const errorText = await putResponse.text();
        addGitHubLog(`   - アップロードエラー: HTTP ${putResponse.status} - ${errorText}`);
        const err = JSON.parse(errorText);
        throw new Error(`HTTP ${putResponse.status}: ${err.message || errorText}`);
      }
      
      const result = await putResponse.json();
      addGitHubLog('✅ 画像アップロード完了');
      addGitHubLog(`   - コミットSHA: ${result.commit.sha.substring(0, 7)}`);
      addGitHubLog(`   - ファイルURL: ${result.content.html_url}`);
      
      // GitHub Pagesの公開URLを生成（オーナー.github.io/repo/path）
      // Pathが空なら直下、あるなら接頭辞として利用
      const pagesBase = `https://${config.owner}.github.io/${config.repo}/`;
      const publicUrl = pagesBase + filePath;
      
      addGitHubLog(`   - 公開URL: ${publicUrl}`);
      
      // imageUrlを更新
      updateProductData(index, 'imageUrl', publicUrl);
      showMessage('画像URLを設定しました: ' + publicUrl, 'success');
      
    } catch (error) {
      addGitHubLog(`❌ 画像アップロードエラー: ${error.message}`);
      showMessage('画像アップロードに失敗しました: ' + error.message, 'error');
      console.error('画像アップロードエラーの詳細:', error);
    } finally {
      // 入力の同一ファイル再選択に備えてリセット
      if (event && event.target) {
        try { event.target.value = ''; } catch (_) {}
      }
    }
  }
  
  /**
   * プレビューを別タブで開く
   */
  function previewProductImage(index) {
    const product = productsData[index] || {};
    if (product.imageUrl) {
      window.open(product.imageUrl, '_blank');
    } else {
      showMessage('画像URLが設定されていません', 'info');
    }
  }
  
  /**
   * 商品テーブルを更新
   */
  function updateProductsTable() {
    const tbody = document.getElementById('products-tbody');
    tbody.innerHTML = '';
    
    // フィルター適用
    const filteredProducts = productsData.filter(product => {
      if (showHiddenProducts) {
        return true; // 全て表示
      } else {
        return product.visible !== false; // 非表示商品を除外
      }
    });
    
    filteredProducts.forEach((product, originalIndex) => {
      // 元のインデックスを取得
      const originalProductIndex = productsData.indexOf(product);
      const row = createProductRow(product, originalProductIndex);
      tbody.appendChild(row);
    });
    
    // 商品がない場合は初期行を追加
    if (productsData.length === 0) {
      addProductRow();
    }
    
  }
  
  /**
   * 商品行を作成
   */
  function createProductRow(product, index) {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>
        <input type="text" value="${product.id || ''}" 
               onchange="updateProductData(${index}, 'id', this.value)"
               placeholder="例: p1">
      </td>
      <td>
        <input type="text" value="${product.name || ''}" 
               onchange="updateProductData(${index}, 'name', this.value)"
               placeholder="商品名を入力">
      </td>
      <td>
        <input type="number" value="${product.price || ''}" 
               onchange="updateProductData(${index}, 'price', parseInt(this.value))"
               placeholder="価格">
      </td>
      <td>
        <input type="number" value="${product.minDays || ''}" 
               onchange="updateProductData(${index}, 'minDays', parseInt(this.value))"
               placeholder="日数">
      </td>
      <td>
        <input type="time" value="${product.cutoff || ''}" 
               onchange="updateProductData(${index}, 'cutoff', this.value || null)"
               placeholder="HH:MM">
      </td>
      <td>
        <select onchange="updateProductData(${index}, 'minType', this.value)">
          <option value="calendar" ${product.minType === 'calendar' ? 'selected' : ''}>カレンダー日</option>
          <option value="business" ${product.minType === 'business' ? 'selected' : ''}>営業日</option>
        </select>
      </td>
      <td>
        <div style="display: flex; flex-direction: column; gap: 4px;">
          <label style="font-size: 12px; color: #666;">
            <input type="checkbox" ${product.pickupDateRange?.enabled ? 'checked' : ''} 
                   onchange="togglePickupDateRange(${index}, this.checked)"> 日付範囲指定
          </label>
          <div id="pickup-date-range-${index}" style="display: ${product.pickupDateRange?.enabled ? 'block' : 'none'};">
            <input type="date" value="${product.pickupDateRange?.startDate || ''}" 
                   onchange="updateProductData(${index}, 'pickupDateRange.startDate', this.value)"
                   placeholder="開始日" style="width: 100%; margin-bottom: 2px;">
            <input type="date" value="${product.pickupDateRange?.endDate || ''}" 
                   onchange="updateProductData(${index}, 'pickupDateRange.endDate', this.value)"
                   placeholder="終了日" style="width: 100%; margin-bottom: 2px;">
            <input type="time" value="${product.pickupDateRange?.cutoff || ''}" 
                   onchange="updateProductData(${index}, 'pickupDateRange.cutoff', this.value)"
                   placeholder="締切時間" style="width: 100%;">
          </div>
        </div>
      </td>
      <td>
        <div style="display: flex; flex-direction: column; gap: 4px;">
          <label style="font-size: 12px; color: #666;">
            <input type="checkbox" ${product.deliveryDateRange?.enabled ? 'checked' : ''} 
                   onchange="toggleDeliveryDateRange(${index}, this.checked)"> 日付範囲指定
          </label>
          <div id="delivery-date-range-${index}" style="display: ${product.deliveryDateRange?.enabled ? 'block' : 'none'};">
            <input type="date" value="${product.deliveryDateRange?.startDate || ''}" 
                   onchange="updateProductData(${index}, 'deliveryDateRange.startDate', this.value)"
                   placeholder="開始日" style="width: 100%; margin-bottom: 2px;">
            <input type="date" value="${product.deliveryDateRange?.endDate || ''}" 
                   onchange="updateProductData(${index}, 'deliveryDateRange.endDate', this.value)"
                   placeholder="終了日" style="width: 100%; margin-bottom: 2px;">
            <input type="time" value="${product.deliveryDateRange?.cutoff || ''}" 
                   onchange="updateProductData(${index}, 'deliveryDateRange.cutoff', this.value)"
                   placeholder="締切時間" style="width: 100%;">
          </div>
        </div>
      </td>
      <td>
        <div style="display: flex; flex-direction: column; gap: 4px;">
          <label style="font-size: 12px; color: #666;">
            <input type="checkbox" ${product.salesPeriod?.enabled ? 'checked' : ''} 
                   onchange="toggleSalesPeriod(${index}, this.checked)"> 販売期間指定
          </label>
          <div id="sales-period-${index}" style="display: ${product.salesPeriod?.enabled ? 'block' : 'none'};">
            <input type="date" value="${product.salesPeriod?.startDate || ''}" 
                   onchange="updateProductData(${index}, 'salesPeriod.startDate', this.value)"
                   placeholder="販売開始日" style="width: 100%; margin-bottom: 2px;">
            <input type="date" value="${product.salesPeriod?.endDate || ''}" 
                   onchange="updateProductData(${index}, 'salesPeriod.endDate', this.value)"
                   placeholder="販売終了日" style="width: 100%; margin-bottom: 2px;">
            <input type="time" value="${product.salesPeriod?.startTime || ''}" 
                   onchange="updateProductData(${index}, 'salesPeriod.startTime', this.value)"
                   placeholder="開始時刻" style="width: 48%; margin-right: 2%;">
            <input type="time" value="${product.salesPeriod?.endTime || ''}" 
                   onchange="updateProductData(${index}, 'salesPeriod.endTime', this.value)"
                   placeholder="終了時刻" style="width: 48%;">
          </div>
        </div>
      </td>
      <td>
        <textarea onchange="updateProductData(${index}, 'description', this.value)"
                  placeholder="商品の説明を入力">${product.description || ''}</textarea>
      </td>
      <td>
        <div style="display:flex; gap:6px; align-items:center;">
          <input type="text" value="${product.imageUrl || ''}" 
                 onchange="updateProductData(${index}, 'imageUrl', this.value)"
                 placeholder="https://.../images/products/p1.jpg" style="width: 60%;">
          <input type="file" accept="image/*" 
                 onchange="handleProductImageUpload(event, ${index})" style="width: 40%;">
        </div>
        <div style="margin-top:6px; display:flex; align-items:center; gap:8px;">
          <img src="${product.imageUrl || ''}" alt="preview" style="max-width:80px; max-height:60px; border:1px solid #eee; border-radius:4px; ${product.imageUrl ? '' : 'display:none;'}">
          <button class="btn btn-secondary" type="button" onclick="previewProductImage(${index})">プレビュー</button>
        </div>
      </td>
      <td>
        <select onchange="updateProductData(${index}, 'deliveryAvailable', this.value === 'true')">
          <option value="false" ${!product.deliveryAvailable ? 'selected' : ''}>不可</option>
          <option value="true" ${product.deliveryAvailable ? 'selected' : ''}>可能</option>
        </select>
      </td>
      <td>
        <input type="number" value="${product.deliveryMinDays || ''}" 
               onchange="updateProductData(${index}, 'deliveryMinDays', parseInt(this.value))"
               placeholder="日数">
      </td>
      <td>
        <input type="time" value="${product.deliveryCutoff || ''}" 
               onchange="updateProductData(${index}, 'deliveryCutoff', this.value || null)"
               placeholder="HH:MM">
      </td>
      <td>
        <div style="display: flex; flex-direction: column; gap: 4px;">
          <label style="font-size: 12px; color: #666;">
            <input type="checkbox" ${product.deliveryTimeSlots?.enabled ? 'checked' : ''} 
                   onchange="toggleDeliveryTimeSlots(${index}, this.checked)"> 時間帯指定
          </label>
          <div id="delivery-time-slots-${index}" style="display: ${product.deliveryTimeSlots?.enabled ? 'block' : 'none'};">
            <select onchange="updateProductData(${index}, 'deliveryTimeSlots.timeSlots', this.value)" 
                    style="width: 100%; margin-bottom: 2px;">
              <option value="all" ${product.deliveryTimeSlots?.timeSlots === 'all' ? 'selected' : ''}>全時間帯</option>
              <option value="morning" ${product.deliveryTimeSlots?.timeSlots === 'morning' ? 'selected' : ''}>8時-12時のみ</option>
              <option value="afternoon" ${product.deliveryTimeSlots?.timeSlots === 'afternoon' ? 'selected' : ''}>14時-18時のみ</option>
              <option value="evening" ${product.deliveryTimeSlots?.timeSlots === 'evening' ? 'selected' : ''}>18時-21時のみ</option>
              <option value="none" ${product.deliveryTimeSlots?.timeSlots === 'none' ? 'selected' : ''}>時間帯指定なし</option>
            </select>
          </div>
        </div>
      </td>
      <td>
        <input type="number" step="0.1" value="${product.deliveryWeight || ''}" 
               onchange="updateProductData(${index}, 'deliveryWeight', parseFloat(this.value))"
               placeholder="kg">
      </td>
      <td>
        <select onchange="updateProductData(${index}, 'deliverySize', this.value)">
          <option value="S" ${product.deliverySize === 'S' ? 'selected' : ''}>S</option>
          <option value="M" ${product.deliverySize === 'M' ? 'selected' : ''}>M</option>
          <option value="L" ${product.deliverySize === 'L' ? 'selected' : ''}>L</option>
          <option value="XL" ${product.deliverySize === 'XL' ? 'selected' : ''}>XL</option>
        </select>
      </td>
      <td>
        <select onchange="updateProductData(${index}, 'deliveryFrozen', this.value === 'true')">
          <option value="false" ${!product.deliveryFrozen ? 'selected' : ''}>常温</option>
          <option value="true" ${product.deliveryFrozen ? 'selected' : ''}>冷凍</option>
        </select>
      </td>
      <td>
        <select onchange="updateProductData(${index}, 'deliveryArea', this.value)">
          <option value="local" ${product.deliveryArea === 'local' ? 'selected' : ''}>地域限定</option>
          <option value="nationwide" ${product.deliveryArea === 'nationwide' ? 'selected' : ''}>全国</option>
        </select>
      </td>
      <td>
        <select onchange="updateProductData(${index}, 'noshiAvailable', this.value === 'true')">
          <option value="false" ${!product.noshiAvailable ? 'selected' : ''}>不可</option>
          <option value="true" ${product.noshiAvailable ? 'selected' : ''}>可能</option>
        </select>
      </td>
      <td>
        <select onchange="updateProductData(${index}, 'noshiOptions', Array.from(this.selectedOptions).map(option => option.value))" multiple>
          <option value="なし" ${(product.noshiOptions || []).includes('なし') ? 'selected' : ''}>なし</option>
          <option value="御歳暮" ${(product.noshiOptions || []).includes('御歳暮') ? 'selected' : ''}>御歳暮</option>
          <option value="御中元" ${(product.noshiOptions || []).includes('御中元') ? 'selected' : ''}>御中元</option>
          <option value="内祝い" ${(product.noshiOptions || []).includes('内祝い') ? 'selected' : ''}>内祝い</option>
          <option value="お祝い" ${(product.noshiOptions || []).includes('お祝い') ? 'selected' : ''}>お祝い</option>
          <option value="その他" ${(product.noshiOptions || []).includes('その他') ? 'selected' : ''}>その他</option>
        </select>
      </td>
      <td>
        <select onchange="updateProductData(${index}, 'visible', this.value === 'true')">
          <option value="true" ${product.visible !== false ? 'selected' : ''}>表示</option>
          <option value="false" ${product.visible === false ? 'selected' : ''}>非表示</option>
        </select>
      </td>
      <td>
        <button class="action-btn btn-remove" onclick="removeProductRow(${index})">削除</button>
      </td>
    `;
    return row;
  }
  
  /**
   * 商品データを更新
   */
  function updateProductData(index, field, value) {
    if (!productsData[index]) {
      productsData[index] = {};
    }
    
    // 日付範囲指定のネストしたフィールドを処理
    if (field.includes('.')) {
      const [parentField, childField] = field.split('.');
      if (!productsData[index][parentField]) {
        productsData[index][parentField] = {};
      }
      productsData[index][parentField][childField] = value;
    } else {
      productsData[index][field] = value;
    }
    
    console.log(`商品[${index}]の${field}を更新:`, value);

    // プレビュー画像更新
    if (field === 'imageUrl') {
      const tbody = document.getElementById('products-tbody');
      const row = tbody.children[index];
      if (row) {
        const img = row.querySelector('img[alt="preview"]');
        if (img) {
          if (value) {
            img.src = value;
            img.style.display = '';
          } else {
            img.removeAttribute('src');
            img.style.display = 'none';
          }
        }
      }
    }
  }
  
  /**
   * 受取日範囲指定のトグル
   */
  function togglePickupDateRange(index, enabled) {
    if (!productsData[index].pickupDateRange) {
      productsData[index].pickupDateRange = {};
    }
    productsData[index].pickupDateRange.enabled = enabled;
    
    const rangeDiv = document.getElementById(`pickup-date-range-${index}`);
    if (rangeDiv) {
      rangeDiv.style.display = enabled ? 'block' : 'none';
    }
  }
  
  /**
   * 配送日範囲指定のトグル
   */
  function toggleDeliveryDateRange(index, enabled) {
    if (!productsData[index].deliveryDateRange) {
      productsData[index].deliveryDateRange = {};
    }
    productsData[index].deliveryDateRange.enabled = enabled;
    
    const rangeDiv = document.getElementById(`delivery-date-range-${index}`);
    if (rangeDiv) {
      rangeDiv.style.display = enabled ? 'block' : 'none';
    }
  }
  
  /**
   * 販売期間指定のトグル
   */
  function toggleSalesPeriod(index, enabled) {
    if (!productsData[index].salesPeriod) {
      productsData[index].salesPeriod = {};
    }
    productsData[index].salesPeriod.enabled = enabled;
    
    const rangeDiv = document.getElementById(`sales-period-${index}`);
    if (rangeDiv) {
      rangeDiv.style.display = enabled ? 'block' : 'none';
    }
  }
  
  /**
   * 配送時間帯指定のトグル
   */
  function toggleDeliveryTimeSlots(index, enabled) {
    if (!productsData[index].deliveryTimeSlots) {
      productsData[index].deliveryTimeSlots = {};
    }
    productsData[index].deliveryTimeSlots.enabled = enabled;
    
    const rangeDiv = document.getElementById(`delivery-time-slots-${index}`);
    if (rangeDiv) {
      rangeDiv.style.display = enabled ? 'block' : 'none';
    }
  }
  
  /**
   * 商品行を追加
   */
  function addProductRow() {
    const newProduct = {
      id: '',
      name: '',
      price: 0,
      minDays: 1,
      cutoff: null,
      minType: 'calendar',
      pickupDateRange: {
        enabled: false,
        startDate: '',
        endDate: '',
        cutoff: ''
      },
      deliveryDateRange: {
        enabled: false,
        startDate: '',
        endDate: '',
        cutoff: ''
      },
      salesPeriod: {
        enabled: false,
        startDate: '',
        endDate: '',
        startTime: '',
        endTime: ''
      },
      description: '',
      imageUrl: '',
      deliveryAvailable: false,
      deliveryMinDays: 7,
      deliveryCutoff: null,
      deliveryTimeSlots: {
        enabled: false,
        timeSlots: 'all'
      },
      deliveryWeight: 0,
      deliverySize: 'M',
      deliveryFrozen: false,
      deliveryArea: 'nationwide',
      noshiAvailable: false,
      noshiOptions: ['なし'],
      visible: true
    };
    
    productsData.push(newProduct);
    updateProductsTable();
    showMessage('新しい商品行を追加しました', 'success');
  }
  
  /**
   * 商品行を削除
   */
  function removeProductRow(index) {
    if (confirm('この商品を削除しますか？')) {
      productsData.splice(index, 1);
      updateProductsTable();
      showMessage('商品を削除しました', 'success');
    }
  }
  
  /**
   * ファイルから商品データを読み込み
   */
  function loadProductsFromFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = JSON.parse(e.target.result);
        productsData = data;
        updateProductsTable();
        showMessage(`${productsData.length}件の商品データを読み込みました`, 'success');
      } catch (error) {
        showMessage('JSONファイルの読み込みに失敗しました: ' + error.message, 'error');
      }
    };
    reader.readAsText(file);
  }
  
  /**
   * products.jsonを生成・ダウンロード
   */
  function generateProductsJson() {
    try {
      // データの妥当性チェック
      const validProducts = productsData.filter(product => 
        product.id && product.name && typeof product.price === 'number'
      ).map(p => {
        // 空文字のimageUrlは除去
        const { imageUrl, ...rest } = p;
        if (imageUrl && imageUrl.trim() !== '') {
          return { ...rest, imageUrl: imageUrl.trim() };
        }
        return rest;
      });
      
      if (validProducts.length === 0) {
        showMessage('有効な商品データがありません（ID、商品名、価格は必須です）', 'error');
        return;
      }
      
      const jsonString = JSON.stringify(validProducts, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = 'products.json';
      a.click();
      
      URL.revokeObjectURL(url);
      showMessage(`products.json（${validProducts.length}件）を生成しました`, 'success');
      
    } catch (error) {
      showMessage('products.jsonの生成に失敗しました: ' + error.message, 'error');
    }
  }
  
  /**
   * 商品表示フィルターを切り替え
   */
  function toggleProductFilter() {
    showHiddenProducts = !showHiddenProducts;
    const filterBtn = document.getElementById('filter-btn');
    
    if (showHiddenProducts) {
      filterBtn.textContent = '🔍 非表示商品を隠す';
      filterBtn.className = 'btn btn-warning';
      showMessage('全ての商品を表示しています', 'info');
    } else {
      filterBtn.textContent = '👁️ 全ての商品を表示';
      filterBtn.className = 'btn btn-success';
      showMessage('非表示商品を隠しています', 'info');
    }
    
    updateProductsTable();
  }
  
  /**
   * 上部・下部両方のスクロールバーを初期化
   */
  function initializeDualScrollbars() {
    // 店舗管理タブのスクロールバー同期
    const storesTopScrollbar = document.getElementById('stores-top-scrollbar');
    const storesTableContainer = document.getElementById('stores-table-container');
    
    if (storesTopScrollbar && storesTableContainer) {
      // 下部→上部の同期
      storesTableContainer.addEventListener('scroll', function() {
        storesTopScrollbar.scrollLeft = storesTableContainer.scrollLeft;
      });
      
      // 上部→下部の同期
      storesTopScrollbar.addEventListener('scroll', function() {
        storesTableContainer.scrollLeft = storesTopScrollbar.scrollLeft;
      });
    }
    
    // 商品管理タブのスクロールバー同期
    const productsTopScrollbar = document.getElementById('products-top-scrollbar');
    const productsTableContainer = document.getElementById('products-table-container');
    
    if (productsTopScrollbar && productsTableContainer) {
      // 下部→上部の同期
      productsTableContainer.addEventListener('scroll', function() {
        productsTopScrollbar.scrollLeft = productsTableContainer.scrollLeft;
      });
      
      // 上部→下部の同期
      productsTopScrollbar.addEventListener('scroll', function() {
        productsTableContainer.scrollLeft = productsTopScrollbar.scrollLeft;
      });
    }
  }
  
</script>

<script>
  // =============================
  // GitHub連携機能
  // =============================
  
  /**
   * GitHub設定を暗号化して保存
   */
  function saveGitHubConfig() {
    try {
      const config = {
        token: document.getElementById('github-token').value,
        owner: document.getElementById('github-owner').value,
        repo: document.getElementById('github-repo').value,
        branch: document.getElementById('github-branch').value,
        path: document.getElementById('github-path').value
      };
      
      // 必須項目チェック
      if (!config.token || !config.owner || !config.repo) {
        showMessage('Token、Owner、Repositoryは必須項目です', 'error');
        return;
      }
      
      // 簡易暗号化（実用レベルではないが、平文保存は避ける）
      const encodedConfig = btoa(JSON.stringify(config));
      localStorage.setItem('github-config', encodedConfig);
      
      showMessage('GitHub設定を保存しました', 'success');
      addGitHubLog('✅ GitHub設定を保存しました');
      
    } catch (error) {
      showMessage('設定の保存に失敗しました: ' + error.message, 'error');
      addGitHubLog('❌ 設定保存エラー: ' + error.message);
    }
  }
  
  /**
   * GitHub設定を読み込み
   */
  function loadGitHubConfig() {
    try {
      const encodedConfig = localStorage.getItem('github-config');
      if (!encodedConfig) {
        showMessage('保存された設定が見つかりません', 'error');
        return;
      }
      
      const config = JSON.parse(atob(encodedConfig));
      
      document.getElementById('github-token').value = config.token || '';
      document.getElementById('github-owner').value = config.owner || '';
      document.getElementById('github-repo').value = config.repo || '';
      document.getElementById('github-branch').value = config.branch || 'main';
      document.getElementById('github-path').value = config.path || '';
      
      showMessage('GitHub設定を読み込みました', 'success');
      addGitHubLog('📂 GitHub設定を読み込みました');
      
    } catch (error) {
      showMessage('設定の読み込みに失敗しました: ' + error.message, 'error');
      addGitHubLog('❌ 設定読み込みエラー: ' + error.message);
    }
  }
  
  /**
   * GitHub設定をクリア
   */
  function clearGitHubConfig() {
    if (confirm('GitHub設定を削除しますか？')) {
      localStorage.removeItem('github-config');
      
      document.getElementById('github-token').value = '';
      document.getElementById('github-owner').value = '';
      document.getElementById('github-repo').value = '';
      document.getElementById('github-branch').value = 'main';
      document.getElementById('github-path').value = '';
      
      showMessage('GitHub設定をクリアしました', 'success');
      addGitHubLog('🗑️ GitHub設定をクリアしました');
    }
  }
  
  /**
   * GitHub接続テスト
   */
  async function testGitHubConnection() {
    try {
      const config = getGitHubConfig();
      if (!config) return;
      
      addGitHubLog('🔧 GitHub接続テストを開始...');
      
      // デバッグ情報を追加
      addGitHubLog(`   - Owner: ${config.owner}`);
      addGitHubLog(`   - Repo: ${config.repo}`);
      addGitHubLog(`   - Token形式: ${config.token.substring(0, 10)}...`);
      addGitHubLog(`   - Token長: ${config.token.length}文字`);
      
      // トークン形式チェック
      if (!config.token.startsWith('ghp_') && !config.token.startsWith('gho_') && !config.token.startsWith('ghu_') && !config.token.startsWith('ghs_') && !config.token.startsWith('ghr_')) {
        addGitHubLog(`⚠️ 警告: トークン形式が正しくない可能性があります`);
        addGitHubLog(`   期待される形式: ghp_, gho_, ghu_, ghs_, ghr_`);
      }
      
      addGitHubLog(`   - API URL: https://api.github.com/repos/${config.owner}/${config.repo}`);
      
      const response = await fetch(`https://api.github.com/repos/${config.owner}/${config.repo}`, {
        headers: {
          'Authorization': `Bearer ${config.token}`,
          'Accept': 'application/vnd.github.v3+json',
          'User-Agent': 'Admin-Panel/1.0'
        }
      });
      
      addGitHubLog(`   - レスポンスステータス: ${response.status}`);
      
      if (response.ok) {
        const repoInfo = await response.json();
        showMessage('GitHub接続テスト成功！', 'success');
        addGitHubLog(`✅ 接続成功: ${repoInfo.full_name}`);
        addGitHubLog(`   - プライベート: ${repoInfo.private ? 'Yes' : 'No'}`);
        addGitHubLog(`   - デフォルトブランチ: ${repoInfo.default_branch}`);
      } else {
        let errorMessage = `HTTP ${response.status}`;
        let errorDetails = '';
        try {
          const error = await response.json();
          errorMessage += `: ${error.message}`;
          errorDetails = JSON.stringify(error, null, 2);
          addGitHubLog(`❌ エラー詳細: ${errorDetails}`);
          if (error.documentation_url) {
            errorMessage += `\n詳細: ${error.documentation_url}`;
          }
        } catch (e) {
          errorMessage += `: ${response.statusText}`;
        }
        throw new Error(errorMessage);
      }
      
    } catch (error) {
      showMessage('GitHub接続テスト失敗: ' + error.message, 'error');
      addGitHubLog('❌ 接続テスト失敗: ' + error.message);
    }
  }
  
  /**
   * GitHubにJSONファイルをプッシュ
   */
  async function pushToGitHub(type) {
    try {
      const config = getGitHubConfig();
      if (!config) return;
      
      if (type === 'both' || type === 'all') {
        await pushFileToGitHub('stores', storesData, config);
        await pushFileToGitHub('products', productsData, config);
        if (type === 'all') {
          await pushAdminFileToGitHub(config);
        }
      } else if (type === 'stores') {
        await pushFileToGitHub('stores', storesData, config);
      } else if (type === 'products') {
        await pushFileToGitHub('products', productsData, config);
      } else if (type === 'admin') {
        await pushAdminFileToGitHub(config);
      }
      
      showMessage(`${type === 'both' ? 'JSONファイル' : type === 'all' ? '全ファイル' : type === 'admin' ? 'admin.html' : type + '.json'}をGitHubにプッシュしました`, 'success');
      
    } catch (error) {
      showMessage('GitHubプッシュ失敗: ' + error.message, 'error');
      addGitHubLog('❌ プッシュ失敗: ' + error.message);
    }
  }
  
  /**
   * 個別ファイルをGitHubにプッシュ
   */
  async function pushFileToGitHub(fileType, data, config) {
    const fileName = `${fileType}.json`;
    const filePath = config.path ? `${config.path}${fileName}` : fileName;
    
    addGitHubLog(`📤 ${fileName}をプッシュ中...`);
    
    // データの妥当性チェック
    let validData;
    if (fileType === 'stores') {
      validData = data.filter(item => item.id && item.name);
    } else if (fileType === 'products') {
      validData = data.filter(item => item.id && item.name && typeof item.price === 'number');
    }
    
    if (validData.length === 0) {
      throw new Error(`有効な${fileType}データがありません`);
    }
    
    const jsonContent = JSON.stringify(validData, null, 2);
    const encodedContent = btoa(unescape(encodeURIComponent(jsonContent)));
    
    // 既存ファイルのSHAを取得
    let sha = null;
    try {
      const getResponse = await fetch(`https://api.github.com/repos/${config.owner}/${config.repo}/contents/${filePath}`, {
        headers: {
          'Authorization': `Bearer ${config.token}`,
          'Accept': 'application/vnd.github.v3+json',
          'User-Agent': 'Admin-Panel/1.0'
        }
      });
      
      if (getResponse.ok) {
        const fileInfo = await getResponse.json();
        sha = fileInfo.sha;
        addGitHubLog(`   - 既存ファイルを更新 (SHA: ${sha.substring(0, 7)})`);
      } else if (getResponse.status === 404) {
        addGitHubLog(`   - 新規ファイルを作成`);
      } else {
        throw new Error(`ファイル情報取得エラー: HTTP ${getResponse.status}`);
      }
    } catch (error) {
      addGitHubLog(`   - ファイル情報取得でエラー: ${error.message}`);
    }
    
    // ファイルをコミット
    const commitData = {
      message: `📝 Update ${fileName} via admin interface`,
      content: encodedContent,
      branch: config.branch
    };
    
    if (sha) {
      commitData.sha = sha;
    }
    
    const putResponse = await fetch(`https://api.github.com/repos/${config.owner}/${config.repo}/contents/${filePath}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${config.token}`,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(commitData)
    });
    
    if (!putResponse.ok) {
      const error = await putResponse.json();
      throw new Error(`HTTP ${putResponse.status}: ${error.message}`);
    }
    
    const result = await putResponse.json();
    addGitHubLog(`✅ ${fileName}プッシュ完了`);
    addGitHubLog(`   - コミットSHA: ${result.commit.sha.substring(0, 7)}`);
    addGitHubLog(`   - ファイルサイズ: ${validData.length}件`);
    addGitHubLog(`   - URL: ${result.content.html_url}`);
  }
  
  /**
   * GitHub設定を取得
   */
  function getGitHubConfig() {
    try {
      const encodedConfig = localStorage.getItem('github-config');
      if (!encodedConfig) {
        showMessage('GitHub設定が見つかりません。先に設定を保存してください。', 'error');
        return null;
      }
      
      const config = JSON.parse(atob(encodedConfig));
      
      if (!config.token || !config.owner || !config.repo) {
        showMessage('GitHub設定が不完全です。設定を確認してください。', 'error');
        return null;
      }
      
      return config;
      
    } catch (error) {
      showMessage('GitHub設定の読み込みに失敗しました: ' + error.message, 'error');
      return null;
    }
  }
  
  /**
   * GitHubログに追加
   */
  function addGitHubLog(message) {
    const logArea = document.getElementById('github-log');
    const timestamp = new Date().toLocaleString('ja-JP');
    const logEntry = `[${timestamp}] ${message}\n`;
    
    logArea.textContent += logEntry;
    logArea.scrollTop = logArea.scrollHeight;
  }
  
  /**
   * GitHubログをクリア
   */
  function clearGitHubLog() {
    document.getElementById('github-log').textContent = '';
    addGitHubLog('ログをクリアしました');
  }
  
  // ページ読み込み時にGitHub設定を自動読み込み
  document.addEventListener('DOMContentLoaded', function() {
    const encodedConfig = localStorage.getItem('github-config');
    if (encodedConfig) {
      loadGitHubConfig();
    }
  });
  
  /**
   * admin.htmlをGitHubにプッシュ
   */
  async function pushAdminFileToGitHub(config) {
    const fileName = 'admin.html';
    const filePath = config.path ? `${config.path}${fileName}` : fileName;
    
    addGitHubLog(`📤 ${fileName}をプッシュ中...`);
    
    // 現在のHTMLコンテンツを取得
    const htmlContent = document.documentElement.outerHTML;
    const encodedContent = btoa(unescape(encodeURIComponent(htmlContent)));
    
    // 既存ファイルのSHAを取得
    let sha = null;
    try {
      const getResponse = await fetch(`https://api.github.com/repos/${config.owner}/${config.repo}/contents/${filePath}`, {
        headers: {
          'Authorization': `Bearer ${config.token}`,
          'Accept': 'application/vnd.github.v3+json',
          'User-Agent': 'Admin-Panel/1.0'
        }
      });
      
      if (getResponse.ok) {
        const fileInfo = await getResponse.json();
        sha = fileInfo.sha;
        addGitHubLog(`   - 既存ファイルを更新 (SHA: ${sha.substring(0, 7)})`);
      } else if (getResponse.status === 404) {
        addGitHubLog(`   - 新規ファイルを作成`);
      } else {
        throw new Error(`ファイル情報取得エラー: HTTP ${getResponse.status}`);
      }
    } catch (error) {
      addGitHubLog(`   - ファイル情報取得でエラー: ${error.message}`);
    }
    
    // ファイルをコミット
    const commitData = {
      message: `🔧 Update admin.html via admin interface`,
      content: encodedContent,
      branch: config.branch
    };
    
    if (sha) {
      commitData.sha = sha;
    }
    
    const putResponse = await fetch(`https://api.github.com/repos/${config.owner}/${config.repo}/contents/${filePath}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${config.token}`,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(commitData)
    });
    
    if (!putResponse.ok) {
      const error = await putResponse.json();
      throw new Error(`HTTP ${putResponse.status}: ${error.message}`);
    }
    
    const result = await putResponse.json();
    addGitHubLog(`✅ ${fileName}プッシュ完了`);
    addGitHubLog(`   - コミットSHA: ${result.commit.sha.substring(0, 7)}`);
    addGitHubLog(`   - ファイルサイズ: ${Math.round(htmlContent.length / 1024)}KB`);
    addGitHubLog(`   - URL: ${result.content.html_url}`);
  }
  
  /**
   * 個別ファイルをGitHubにプッシュ
   */
</script>

<script>
  // =============================
  // パスワード認証機能
  // =============================
  
  // 設定（実際の運用では環境変数や設定ファイルで管理）
  const AUTH_CONFIG = {
    // パスワードのハッシュ値（SHA-256）
    // デフォルトパスワード: "admin"
    passwordHash: "8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918",
    maxAttempts: 3,
    lockoutDuration: 5 * 60 * 1000, // 5分
    sessionDuration: 24 * 60 * 60 * 1000 // 24時間
  };
  
  // 認証状態管理
  let authAttempts = 0;
  let lockoutTime = null;
  
  /**
   * 初期化処理
   */
  document.addEventListener('DOMContentLoaded', function() {
    console.log('🔐 管理画面パスワード認証を初期化...');
    
    // 既存の認証状態をチェック
    checkExistingAuth();
    
    // パスワード入力フィールドにフォーカス
    setTimeout(() => {
      document.getElementById('auth-password').focus();
    }, 100);
    
    // Enterキーでのログイン
    document.getElementById('auth-password').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        handleAuthentication(e);
      }
    });
    
    // ロックアウト状態をチェック
    checkLockoutStatus();
  });
  
  /**
   * 既存の認証状態をチェック
   */
  function checkExistingAuth() {
    const authData = localStorage.getItem('admin-auth');
    if (authData) {
      try {
        const parsed = JSON.parse(authData);
        const now = Date.now();
        
        // セッション有効期限をチェック
        if (parsed.expiry > now && parsed.authenticated === true) {
          console.log('✅ 有効な認証セッションが見つかりました');
          showMainContent();
          return;
        } else {
          // 期限切れセッションを削除
          localStorage.removeItem('admin-auth');
          console.log('⏰ 認証セッションが期限切れです');
        }
      } catch (error) {
        localStorage.removeItem('admin-auth');
        console.warn('🔧 認証データの解析に失敗:', error);
      }
    }
    
    // 認証が必要
    showAuthScreen();
  }
  
  /**
   * ロックアウト状態をチェック
   */
  function checkLockoutStatus() {
    const lockoutData = localStorage.getItem('admin-lockout');
    if (lockoutData) {
      try {
        const parsed = JSON.parse(lockoutData);
        const now = Date.now();
        
        if (parsed.until > now) {
          // まだロックアウト中
          lockoutTime = parsed.until;
          showLockoutMessage();
          
          // ロックアウト解除のタイマー
          setTimeout(() => {
            localStorage.removeItem('admin-lockout');
            hideLockoutMessage();
            resetAttempts();
          }, parsed.until - now);
          
          return true;
        } else {
          // ロックアウト期間終了
          localStorage.removeItem('admin-lockout');
        }
      } catch (error) {
        localStorage.removeItem('admin-lockout');
      }
    }
    return false;
  }
  
  /**
   * 認証処理
   */
  async function handleAuthentication(event) {
    event.preventDefault();
    
    // ロックアウト中かチェック
    if (checkLockoutStatus()) {
      return;
    }
    
    const password = document.getElementById('auth-password').value;
    
    // デバッグ情報を出力
    console.log('🔍 デバッグ情報:');
    console.log('  入力パスワード:', password);
    console.log('  期待ハッシュ:', AUTH_CONFIG.passwordHash);
    
    // パスワードをハッシュ化
    const hash = await hashPassword(password);
    console.log('  計算ハッシュ:', hash);
    console.log('  一致判定:', hash === AUTH_CONFIG.passwordHash);
    
    // パスワード検証
    if (hash === AUTH_CONFIG.passwordHash) {
      // 認証成功
      console.log('✅ 認証成功');
      authSuccess();
    } else {
      // 認証失敗
      console.log('❌ 認証失敗');
      authFailure();
    }
    
    // パスワードフィールドをクリア
    document.getElementById('auth-password').value = '';
  }
  
  /**
   * 認証成功処理
   */
  function authSuccess() {
    // セッション情報を保存
    const authData = {
      authenticated: true,
      timestamp: Date.now(),
      expiry: Date.now() + AUTH_CONFIG.sessionDuration,
      userAgent: navigator.userAgent.substring(0, 100) // セキュリティ用途
    };
    
    localStorage.setItem('admin-auth', JSON.stringify(authData));
    
    // 失敗回数をリセット
    resetAttempts();
    
    // メイン画面を表示
    showMainContent();
    
    // 成功メッセージ
    setTimeout(() => {
      showMessage('🎉 ログイン成功！管理画面にアクセスできます', 'success');
    }, 500);
  }
  
  /**
   * 認証失敗処理
   */
  function authFailure() {
    authAttempts++;
    
    const remainingAttempts = AUTH_CONFIG.maxAttempts - authAttempts;
    
    if (remainingAttempts > 0) {
      // まだ試行回数が残っている
      showAuthError();
      showAttemptsWarning(remainingAttempts);
      
      // パスワードフィールドをエラー状態に
      const passwordField = document.getElementById('auth-password');
      passwordField.style.borderColor = '#dc3545';
      setTimeout(() => {
        passwordField.style.borderColor = '';
      }, 3000);
      
    } else {
      // 試行回数上限に達した - ロックアウト
      const lockoutUntil = Date.now() + AUTH_CONFIG.lockoutDuration;
      
      const lockoutData = {
        attempts: authAttempts,
        until: lockoutUntil,
        ip: 'unknown', // ローカル実行のため
        timestamp: Date.now()
      };
      
      localStorage.setItem('admin-lockout', JSON.stringify(lockoutData));
      
      showLockoutMessage();
      
      // セキュリティログ
      console.warn('🚨 セキュリティ警告: 最大試行回数に達しました');
      
      // ロックアウト解除のタイマー
      setTimeout(() => {
        localStorage.removeItem('admin-lockout');
        hideLockoutMessage();
        resetAttempts();
      }, AUTH_CONFIG.lockoutDuration);
    }
  }
  
  /**
   * パスワードをSHA-256でハッシュ化
   */
  async function hashPassword(password) {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hash = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hash));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    return hashHex;
  }
  
  /**
   * メイン画面を表示
   */
  function showMainContent() {
    document.getElementById('auth-overlay').style.display = 'none';
    document.getElementById('main-content').classList.add('authenticated');
    
    // 既存のJSONデータを読み込み（認証後）
    loadExistingData();
  }
  
  /**
   * 認証画面を表示
   */
  function showAuthScreen() {
    document.getElementById('auth-overlay').style.display = 'flex';
    document.getElementById('main-content').classList.remove('authenticated');
  }
  
  /**
   * エラーメッセージを表示
   */
  function showAuthError() {
    document.getElementById('auth-error').style.display = 'block';
    setTimeout(() => {
      document.getElementById('auth-error').style.display = 'none';
    }, 3000);
  }
  
  /**
   * 試行回数警告を表示
   */
  function showAttemptsWarning(remaining) {
    document.getElementById('attempts-count').textContent = remaining;
    document.getElementById('auth-attempts').style.display = 'block';
    
    if (remaining <= 1) {
      document.getElementById('auth-attempts').style.color = '#dc3545';
      document.getElementById('auth-attempts').innerHTML = 
        '🚨 <strong>最後の試行です</strong> - 失敗するとアクセスがロックされます';
    }
  }
  
  /**
   * ロックアウトメッセージを表示
   */
  function showLockoutMessage() {
    document.getElementById('auth-form').style.display = 'none';
    document.getElementById('auth-error').style.display = 'none';
    document.getElementById('auth-attempts').style.display = 'none';
    document.getElementById('auth-locked').style.display = 'block';
  }
  
  /**
   * ロックアウトメッセージを非表示
   */
  function hideLockoutMessage() {
    document.getElementById('auth-form').style.display = 'block';
    document.getElementById('auth-locked').style.display = 'none';
  }
  
  /**
   * 試行回数をリセット
   */
  function resetAttempts() {
    authAttempts = 0;
    document.getElementById('auth-attempts').style.display = 'none';
    document.getElementById('attempts-count').textContent = AUTH_CONFIG.maxAttempts;
    document.getElementById('auth-attempts').style.color = '#ffc107';
    document.getElementById('auth-attempts').innerHTML = 
      '⚠️ 残り試行回数: <span id="attempts-count">' + AUTH_CONFIG.maxAttempts + '</span>回';
  }
  
  /**
   * ログアウト機能
   */
  function logout() {
    if (confirm('ログアウトしますか？')) {
      localStorage.removeItem('admin-auth');
      location.reload();
    }
  }
  
  /**
   * キャッシュクリア機能
   * index.htmlのローカルストレージキャッシュをクリア
   */
  function clearCache() {
    if (confirm('index.htmlのキャッシュをクリアしますか？\n\nこれにより、次回index.htmlにアクセスした際に最新の商品データが表示されます。')) {
      try {
        // ローカルストレージからキャッシュデータを削除
        localStorage.removeItem('reservationData');
        
        showMessage('✅ キャッシュをクリアしました！', 'success');
        addGitHubLog('🗑️ キャッシュクリア完了');
        addGitHubLog('   - index.htmlのローカルストレージキャッシュを削除しました');
        addGitHubLog('   - 次回index.htmlにアクセスした際に最新データが表示されます');
        
        console.log('✅ キャッシュクリア完了');
        
      } catch (error) {
        showMessage('キャッシュクリアでエラーが発生しました: ' + error.message, 'error');
        addGitHubLog('❌ キャッシュクリアエラー: ' + error.message);
        console.error('❌ キャッシュクリアエラー:', error);
      }
    }
  }
  
  /**
   * パスワード変更機能（開発者用）
   */
  async function generatePasswordHash(newPassword) {
    const hash = await hashPassword(newPassword);
    console.log('新しいパスワードハッシュ:', hash);
    console.log('AUTH_CONFIG.passwordHashを以下の値に変更してください:');
    console.log('"' + hash + '"');
    return hash;
  }
  
  // 開発者用: グローバル関数として公開
  window.generatePasswordHash = generatePasswordHash;
  window.logout = logout;
  
  // =============================
  // グローバル変数
  // =============================
</script>

<script>
  // =============================
  // パスワード変更機能
  // =============================
  
  // 新しいパスワードハッシュを一時保存
  let newPasswordHash = null;
  
  /**
   * パスワード変更処理
   */
  async function changePassword() {
    try {
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      
      // バリデーション
      if (!currentPassword || !newPassword || !confirmPassword) {
        showMessage('すべてのパスワードフィールドを入力してください', 'error');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        showMessage('新しいパスワードと確認パスワードが一致しません', 'error');
        return;
      }
      
      if (newPassword.length < 4) {
        showMessage('新しいパスワードは4文字以上で入力してください', 'error');
        return;
      }
      
      // 現在のパスワードを検証
      const currentHash = await hashPassword(currentPassword);
      if (currentHash !== AUTH_CONFIG.passwordHash) {
        showMessage('現在のパスワードが間違っています', 'error');
        return;
      }
      
      // 新しいパスワードのハッシュを生成
      newPasswordHash = await hashPassword(newPassword);
      
      // 成功メッセージ
      showMessage('パスワードハッシュを生成しました。「更新されたadmin.htmlをダウンロード」ボタンをクリックしてください', 'success');
      addGitHubLog(`🔑 新しいパスワードハッシュを生成しました`);
      addGitHubLog(`   - 新しいパスワード: ${newPassword}`);
      addGitHubLog('   - 「更新されたadmin.htmlをダウンロード」ボタンでファイルを取得してください');
      
      // フィールドをクリア
      document.getElementById('current-password').value = '';
      document.getElementById('new-password').value = '';
      document.getElementById('confirm-password').value = '';
      
    } catch (error) {
      showMessage('パスワード変更処理でエラーが発生しました: ' + error.message, 'error');
      addGitHubLog('❌ パスワード変更エラー: ' + error.message);
    }
  }
  
  /**
   * 更新されたadmin.htmlファイルをダウンロード
   */
  async function downloadUpdatedAdminFile() {
    try {
      if (!newPasswordHash) {
        showMessage('先にパスワード変更処理を実行してください', 'error');
        return;
      }
      
      // 現在のHTMLコンテンツを取得
      const currentHTML = document.documentElement.outerHTML;
      
      // パスワードハッシュを置換
      const updatedHTML = currentHTML.replace(
        /passwordHash: "[^"]*"/,
        `passwordHash: "${newPasswordHash}"`
      );
      
      // コメント部分も更新
      const finalHTML = updatedHTML.replace(
        /\/\/ デフォルトパスワード: "[^"]*"/,
        `// デフォルトパスワード: "***変更済み***"`
      );
      
      // ファイルをダウンロード
      const blob = new Blob([finalHTML], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = 'admin.html';
      a.click();
      
      URL.revokeObjectURL(url);
      
      showMessage('新しいadmin.htmlファイルをダウンロードしました。このファイルと置き換えてください', 'success');
      addGitHubLog('📥 更新されたadmin.htmlファイルをダウンロードしました');
      addGitHubLog('   - 現在のadmin.htmlファイルと置き換えてください');
      addGitHubLog('   - 次回から新しいパスワードでログインできます');
      
      // 一時的なハッシュをクリア
      newPasswordHash = null;
      
    } catch (error) {
      showMessage('ファイルダウンロードでエラーが発生しました: ' + error.message, 'error');
      addGitHubLog('❌ ファイルダウンロードエラー: ' + error.message);
    }
  }
  
  /**
   * 更新されたadmin.htmlをGitHubにプッシュ
   */
  async function pushUpdatedAdminToGitHub() {
    try {
      if (!newPasswordHash) {
        showMessage('先にパスワード変更処理を実行してください', 'error');
        return;
      }
      
      const config = getGitHubConfig();
      if (!config) return;
      
      addGitHubLog('📤 新しいパスワードでadmin.htmlをGitHubにプッシュ中...');
      
      // 現在のHTMLコンテンツを取得
      const currentHTML = document.documentElement.outerHTML;
      
      // パスワードハッシュを置換
      const updatedHTML = currentHTML.replace(
        /passwordHash: "[^"]*"/,
        `passwordHash: "${newPasswordHash}"`
      );
      
      // コメント部分も更新
      const finalHTML = updatedHTML.replace(
        /\/\/ デフォルトパスワード: "[^"]*"/,
        `// デフォルトパスワード: "***変更済み***"`
      );
      
      const fileName = 'admin.html';
      const filePath = config.path ? `${config.path}${fileName}` : fileName;
      const encodedContent = btoa(unescape(encodeURIComponent(finalHTML)));
      
      // 既存ファイルのSHAを取得
      let sha = null;
      try {
        const getResponse = await fetch(`https://api.github.com/repos/${config.owner}/${config.repo}/contents/${filePath}`, {
          headers: {
            'Authorization': `Bearer ${config.token}`,
            'Accept': 'application/vnd.github.v3+json',
          'User-Agent': 'Admin-Panel/1.0'
          }
        });
        
        if (getResponse.ok) {
          const fileInfo = await getResponse.json();
          sha = fileInfo.sha;
          addGitHubLog(`   - 既存ファイルを更新 (SHA: ${sha.substring(0, 7)})`);
        }
      } catch (error) {
        addGitHubLog(`   - ファイル情報取得でエラー: ${error.message}`);
      }
      
      // ファイルをコミット
      const commitData = {
        message: `🔑 Update admin.html with new password hash`,
        content: encodedContent,
        branch: config.branch
      };
      
      if (sha) {
        commitData.sha = sha;
      }
      
      const putResponse = await fetch(`https://api.github.com/repos/${config.owner}/${config.repo}/contents/${filePath}`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${config.token}`,
          'Accept': 'application/vnd.github.v3+json',
          'User-Agent': 'Admin-Panel/1.0',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(commitData)
      });
      
      if (!putResponse.ok) {
        const error = await putResponse.json();
        throw new Error(`HTTP ${putResponse.status}: ${error.message}`);
      }
      
      const result = await putResponse.json();
      
      showMessage('新しいパスワードでadmin.htmlをGitHubにプッシュしました！', 'success');
      addGitHubLog(`✅ ${fileName}プッシュ完了`);
      addGitHubLog(`   - コミットSHA: ${result.commit.sha.substring(0, 7)}`);
      addGitHubLog(`   - 新しいパスワードが適用されました`);
      addGitHubLog(`   - URL: ${result.content.html_url}`);
      addGitHubLog('   - 次回から新しいパスワードでログインできます');
      
      // 一時的なハッシュをクリア
      newPasswordHash = null;
      
    } catch (error) {
      showMessage('GitHubプッシュでエラーが発生しました: ' + error.message, 'error');
      addGitHubLog('❌ GitHubプッシュエラー: ' + error.message);
    }
  }
  
  /**
   * キャッシュクリア機能
   * index.htmlのローカルストレージキャッシュをクリア
   */
  function clearCache() {
    if (confirm('index.htmlのキャッシュをクリアしますか？\n\nこれにより、次回index.htmlにアクセスした際に最新の商品データが表示されます。')) {
      try {
        // ローカルストレージからキャッシュデータを削除
        localStorage.removeItem('reservationData');
        
        showMessage('✅ キャッシュをクリアしました！', 'success');
        addGitHubLog('🗑️ キャッシュクリア完了');
        addGitHubLog('   - index.htmlのローカルストレージキャッシュを削除しました');
        addGitHubLog('   - 次回index.htmlにアクセスした際に最新データが表示されます');
        
        console.log('✅ キャッシュクリア完了');
        
      } catch (error) {
        showMessage('キャッシュクリアでエラーが発生しました: ' + error.message, 'error');
        addGitHubLog('❌ キャッシュクリアエラー: ' + error.message);
        console.error('❌ キャッシュクリアエラー:', error);
      }
    }
  }

  // =============================
  // Stripeモード切替機能
  // =============================
  
  /**
   * Stripeモード切替ボタンの表示を更新
   */
  function updateModeButtons() {
    try {
      const currentMode = localStorage.getItem('stripe-mode') || 'TEST';
      const testBtn = document.getElementById('stripe-test-btn');
      const liveBtn = document.getElementById('stripe-live-btn');
      const modeDisplay = document.getElementById('stripe-mode-display');
      
      if (testBtn && liveBtn && modeDisplay) {
        // ボタンの状態を更新
        testBtn.disabled = currentMode === 'TEST';
        liveBtn.disabled = currentMode === 'LIVE';
        
        // 表示を更新
        modeDisplay.textContent = `現在のモード: ${currentMode === 'TEST' ? '🧪 テスト環境' : '🚀 本番環境'}`;
        modeDisplay.style.color = currentMode === 'TEST' ? '#28a745' : '#dc3545';
        
        console.log('StripeモードUI更新完了:', currentMode);
      }
    } catch (error) {
      console.error('StripeモードUI更新エラー:', error);
    }
  }
  
  /**
   * StripeモードをTESTに切り替え
   */
  function switchToTestMode() {
    if (confirm('🧪 テスト環境に切り替えますか？\n\n• 実際の課金は発生しません\n• テスト用の決済データが作成されます\n• 本番環境のデータには影響しません')) {
      localStorage.setItem('stripe-mode', 'TEST');
      updateModeButtons();
      showMessage('✅ テスト環境に切り替えました', 'success');
      console.log('Stripeモード切り替え: TEST');
    }
  }
  
  /**
   * StripeモードをLIVEに切り替え
   */
  function switchToLiveMode() {
    if (confirm('🚀 本番環境に切り替えますか？\n\n⚠️ 注意事項:\n• 実際の課金が発生します\n• 本番用のStripeキーが必要です\n• 慎重に操作してください')) {
      localStorage.setItem('stripe-mode', 'LIVE');
      updateModeButtons();
      showMessage('✅ 本番環境に切り替えました', 'success');
      console.log('Stripeモード切り替え: LIVE');
    }
  }
  
  /**
   * 現在のStripe設定を確認
   */
  function checkStripeMode() {
    try {
      const currentMode = localStorage.getItem('stripe-mode') || 'TEST';
      const testKey = 'pk_test_51RVBoUIjwFiP4bNCKXNfgzkwTnmAfRnX4cNFwDVZeO4PewRHOE7Fq7OgjvtbJpWJod7NlQOLROtRZfU0hLRElngH00k1okQ7wq';
      
      let message = `🔍 現在のStripe設定:\n\n`;
      message += `モード: ${currentMode === 'TEST' ? '🧪 テスト環境' : '🚀 本番環境'}\n`;
      message += `公開鍵: ${currentMode === 'TEST' ? testKey.substring(0, 20) + '...' : '本番用キー（設定済み）'}\n\n`;
      
      if (currentMode === 'TEST') {
        message += `✅ テスト環境のため安全です\n• 実際の課金は発生しません\n• テスト用データのみ作成されます`;
      } else {
        message += `⚠️ 本番環境のため注意が必要です\n• 実際の課金が発生します\n• 本番用のStripeキーが使用されます`;
      }
      
      alert(message);
      console.log('Stripe設定確認:', currentMode);
    } catch (error) {
      console.error('Stripe設定確認エラー:', error);
      showMessage('設定確認でエラーが発生しました', 'error');
    }
  }
  
  /**
   * Stripeモード設定をリセット（TESTに戻す）
   */
  function resetStripeMode() {
    if (confirm('🔄 Stripeモードをテスト環境にリセットしますか？\n\n• 現在の設定がTESTに戻ります\n• 安全なテスト環境で動作します')) {
      localStorage.setItem('stripe-mode', 'TEST');
      updateModeButtons();
      showMessage('✅ テスト環境にリセットしました', 'success');
      console.log('Stripeモードリセット: TEST');
    }
  }
</script>
</body>
</html> 
